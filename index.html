<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ูุงููุง โ ุฌูุณุฉ ูุดุชุฑูุฉ</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <style>
    body { padding-bottom: env(safe-area-inset-bottom); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-40 bg-slate-950/80 glass border-b border-slate-800">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="text-lg font-extrabold">๐ต๏ธโโ๏ธ ูุงููุง</div>
        <div id="badgeMini" class="hidden text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">โ</div>
      </div>
      <div class="flex gap-2">
        <button id="btnCopyShare" class="hidden tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          ูุดุงุฑูุฉ
        </button>
        <button id="btnResetLocal" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          ุฎุฑูุฌ
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 py-5 space-y-4">

    <!-- ุดุงุดุฉ ุงุฎุชูุงุฑ -->
    <section id="screenMode" class="space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 shadow">
        <h1 class="text-2xl font-extrabold">ุฌูุณุฉ ูุดุชุฑูุฉ</h1>
        <p class="text-slate-300 text-sm mt-2 leading-6">
          <span class="font-bold text-slate-100">ุงููุฏูุฑ:</span> ุฃูุช ููุท ุชุฏูุฑ ุงููุฑุงุญู ูุชูููุฐ ุงููุชุงุฆุฌ (ุจุฏูู ุฑุคูุฉ ุงูุฃุฏูุงุฑ).<br>
          <span class="font-bold text-slate-100">ุงููุงุนุจ:</span> ูู ุดุฎุต ูุฏุฎู ูู ุฌูุงูู ููุดูู ุฏูุฑู ููุท ููุตููุช ุญุณุจ ุงููุฑุญูุฉ.
        </p>
      </div>

      <button id="btnGoHost" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
        ุฃูุง ุงููุฏูุฑ (ุฅูุดุงุก ุฌูุณุฉ)
      </button>

      <button id="btnGoPlayer" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
        ุฃูุง ูุงุนุจ (ุฏุฎูู ุฌูุณุฉ)
      </button>

      <div class="text-xs text-slate-400 text-center">
        ุชูููุญ: ุชูุฏุฑ ุชุฑุณู โุฑุงุจุท ุงูุฏุฎููโ ุจุฏู ุงูููุฏ.
      </div>
    </section>

    <!-- ุดุงุดุฉ ุงููุฏูุฑ -->
    <section id="screenHost" class="hidden space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-slate-300">ููุฏ ุงูุฌูุณุฉ</div>
            <div id="hostCode" class="text-4xl font-extrabold tracking-widest mt-1">โ</div>
            <div class="text-sm text-slate-300 mt-2">ุฃุฑุณู ุงูููุฏ ุฃู ุงุถุบุท โูุดุงุฑูุฉโ ููุณุฎ ุฑุงุจุท ุฏุฎูู ุฌุงูุฒ.</div>
          </div>
          <button id="btnCopyJoin" class="tap px-4 py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">
            ูุณุฎ
          </button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">ุญุงูุฉ ุงูุฌูุณุฉ</div>
            <div id="hostStatus" class="text-lg font-extrabold mt-1">โ</div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">ุนุฏุฏ ุงููุงุนุจูู</div>
            <div id="hostCount" class="text-lg font-extrabold mt-1">โ</div>
          </div>
        </div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="font-extrabold text-lg">ุงูุฅุนุฏุงุฏุงุช</h2>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-300">ุนุฏุฏ ุงููุงููุง</label>
            <input id="hostMafia" type="number" min="1" value="1"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">ุงูุฃุฏูุงุฑ ุงูุฅุถุงููุฉ</div>
            <div class="text-sm text-slate-200 mt-1">๐ฏ ููุงุต (1)</div>
            <div class="text-sm text-slate-200">๐คก ููุฑูุฌ (1)</div>
          </div>
        </div>

        <button id="btnHostLockAndAssign" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          ููู ุงููุงุนุจูู + ุชูุฒูุน ุงูุฃุฏูุงุฑ
        </button>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">ุงููุงุนุจูู</div>
            <div class="text-xs text-slate-400">ุงูุฃุฏูุงุฑ ูุฎููุฉ</div>
          </div>
          <div id="hostPlayers" class="mt-3 space-y-2"></div>
        </div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-300">ุงููุฑุญูุฉ</div>
            <div id="hostPhase" class="text-2xl font-extrabold">โ</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-300">ุงูุฌููุฉ</div>
            <div id="hostRound" class="text-2xl font-extrabold">โ</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnHostTogglePhase" class="tap px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold">
            ุชุจุฏูู ููู/ููุงุฑ
          </button>
          <button id="btnHostResolve" class="tap px-4 py-4 rounded-3xl bg-amber-600 hover:bg-amber-500 font-extrabold">
            ุชูููุฐ ุงููุชูุฌุฉ
          </button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">ุชุตููุช ุงููุฑุญูุฉ</div>
            <div id="hostVoteInfo" class="text-lg font-extrabold mt-1">โ</div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">ุงููุงุฆุฒ</div>
            <div id="hostWinner" class="text-lg font-extrabold mt-1">โ</div>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
          <div class="font-extrabold">ุขุฎุฑ ุฑุณุงูุฉ</div>
          <div id="hostLog" class="mt-1 text-slate-300 text-sm leading-6">โ</div>
        </div>
      </div>

      <button id="btnBackMode1" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
        ุฑุฌูุน
      </button>
    </section>

    <!-- ุดุงุดุฉ ุงููุงุนุจ -->
    <section id="screenPlayer" class="hidden space-y-4">
      <div id="joinBox" class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">ุฏุฎูู ุฌูุณุฉ</h2>

        <label class="text-sm text-slate-300">ููุฏ ุงูุฌูุณุฉ</label>
        <input id="playerCode" placeholder="ูุซุงู: 482913"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <label class="text-sm text-slate-300">ุงุณูู</label>
        <input id="playerName" placeholder="ูุซุงู: ุนุจุฏุงููู"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <button id="btnPlayerJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
          ุฏุฎูู
        </button>

        <div class="text-xs text-slate-400">ุจุนุฏ ุชูุฒูุน ุงูุฃุฏูุงุฑ ุณูุธูุฑ ุฏูุฑู ุฃูุช ููุท.</div>
      </div>

      <div id="playerBox" class="hidden space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="text-xs text-slate-300">ุฃูุช ุฏุงุฎู ุฌูุณุฉ</div>
          <div class="text-2xl font-extrabold mt-1">
            <span id="pName">โ</span> ยท <span class="tracking-widest" id="pCode">โ</span>
          </div>

          <div class="mt-3 rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-slate-300">ุงููุฑุญูุฉ</div>
                <div id="pPhase" class="text-2xl font-extrabold mt-1">โ</div>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-300">ุงูุฌููุฉ</div>
                <div id="pRound" class="text-2xl font-extrabold mt-1">โ</div>
              </div>
            </div>
          </div>

          <div id="winnerBanner" class="hidden mt-3 rounded-2xl border border-amber-700 bg-amber-900/20 p-3">
            <div class="font-extrabold" id="winnerText">โ</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ุฏูุฑู</div>
            <button id="btnToggleRole" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
              ุฅุธูุงุฑ/ุฅุฎูุงุก
            </button>
          </div>

          <div id="myRoleCard" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
            <div id="myRoleText" class="text-3xl font-extrabold">โ</div>
            <div id="myRoleHint" class="text-sm text-slate-300 mt-2 leading-6">โ</div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">ุชุตููุชู</div>
            <div id="myVoteStatus" class="text-sm text-slate-300 mt-1">โ</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="font-extrabold text-lg">ุงูุฅุฌุฑุงุก</div>
          <div id="pActionBox" class="mt-3 space-y-3"></div>
        </div>

        <button id="btnBackMode2" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          ุฑุฌูุน
        </button>
      </div>
    </section>
  </main>

<script>
(() => {
  // โ Firebase config (ูู ุนูุฏู)
  const firebaseConfig = {
    apiKey: "AIzaSyC4YdqgiAfJmRmvkLH4wspzclAzKs3wyLw",
    authDomain: "mafia-game-7e488.firebaseapp.com",
    databaseURL: "https://mafia-game-7e488-default-rtdb.firebaseio.com",
    projectId: "mafia-game-7e488",
    storageBucket: "mafia-game-7e488.firebasestorage.app",
    messagingSenderId: "513186840934",
    appId: "1:513186840934:web:ccf858b27cea91be1448a7"
  };

  const $ = (id) => document.getElementById(id);
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Helpers
  const rid = () => (crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint32Array(2))].map(x=>x.toString(16)).join("") : String(Math.random()).slice(2));
  const now = () => Date.now();
  const code6 = () => String(Math.floor(100000 + Math.random() * 900000));
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const shuffle = (arr) => {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  };

  const LS_KEY = "mafia_identity_v2";
  const getMe = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; } };
  const setMe = (o) => localStorage.setItem(LS_KEY, JSON.stringify(o));
  const clearMe = () => localStorage.removeItem(LS_KEY);

  const SESS = (code) => db.ref(`sessions/${code}`);

  // UI
  const badgeMini = $("badgeMini");
  const btnCopyShare = $("btnCopyShare");
  const btnResetLocal = $("btnResetLocal");

  const screenMode = $("screenMode");
  const screenHost = $("screenHost");
  const screenPlayer = $("screenPlayer");

  const btnGoHost = $("btnGoHost");
  const btnGoPlayer = $("btnGoPlayer");

  // Host
  const hostCodeEl = $("hostCode");
  const btnCopyJoin = $("btnCopyJoin");
  const hostStatus = $("hostStatus");
  const hostCount = $("hostCount");
  const hostMafia = $("hostMafia");
  const btnHostLockAndAssign = $("btnHostLockAndAssign");
  const hostPlayers = $("hostPlayers");
  const hostPhase = $("hostPhase");
  const hostRound = $("hostRound");
  const btnHostTogglePhase = $("btnHostTogglePhase");
  const btnHostResolve = $("btnHostResolve");
  const hostVoteInfo = $("hostVoteInfo");
  const hostWinner = $("hostWinner");
  const hostLog = $("hostLog");
  const btnBackMode1 = $("btnBackMode1");

  // Player
  const joinBox = $("joinBox");
  const playerBox = $("playerBox");
  const playerCode = $("playerCode");
  const playerName = $("playerName");
  const btnPlayerJoin = $("btnPlayerJoin");
  const pName = $("pName");
  const pCode = $("pCode");
  const pPhase = $("pPhase");
  const pRound = $("pRound");
  const winnerBanner = $("winnerBanner");
  const winnerText = $("winnerText");
  const btnToggleRole = $("btnToggleRole");
  const myRoleCard = $("myRoleCard");
  const myRoleText = $("myRoleText");
  const myRoleHint = $("myRoleHint");
  const myVoteStatus = $("myVoteStatus");
  const pActionBox = $("pActionBox");
  const btnBackMode2 = $("btnBackMode2");

  // Role names/hints
  const ROLE_UI = {
    mafia: { name:"ูุงููุง", hint:"ุจุงูููู: ุตููุช ููุชู ูุงุนุจ. ุจุงูููุงุฑ: ุญุงูู ูุง ุชููุดู." },
    citizen: { name:"ููุงุทู", hint:"ุจุงูููุงุฑ: ุตููุช ุตุญ. ุจุงูููู: ุงูุชุธุฑ." },
    sniper: { name:"ููุงุต", hint:"๐ฏ ุทููุฉ ูุงุญุฏุฉ ุทูุงู ุงููุนุจุฉ (ูู ุงูููุงุฑ). ุงุฎุชุฑ ุงููุฏู ุจุนูุงูุฉ." },
    jester: { name:"ููุฑูุฌ", hint:"๐คก ูุฏูู ูุชู ุฅูุตุงุคู ุจุงูุชุตููุช ูู ุงูููุงุฑ ูุชููุฒ ูุญุฏู ููุฑูุง." },
  };

  // State
  let hostCode = null;
  let hostSub = null;
  let playerSub = null;
  let me = getMe(); // {mode:"host"|"player", code, pid, name}

  // Screen
  function setScreen(which){
    screenMode.classList.add("hidden");
    screenHost.classList.add("hidden");
    screenPlayer.classList.add("hidden");
    btnCopyShare.classList.add("hidden");
    badgeMini.classList.add("hidden");

    if (which === "mode") screenMode.classList.remove("hidden");
    if (which === "host") {
      screenHost.classList.remove("hidden");
      btnCopyShare.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = "ูุฏูุฑ";
    }
    if (which === "player") {
      screenPlayer.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = "ูุงุนุจ";
    }
  }

  function shareLink(code){
    const url = `${location.origin}${location.pathname}?code=${code}`;
    navigator.clipboard?.writeText(url);
    alert("ุชู ูุณุฎ ุฑุงุจุท ุงูุฏุฎูู.");
  }

  // URL join ?code=
  const urlParams = new URLSearchParams(location.search);
  const preCode = urlParams.get("code");
  if (preCode && !me) {
    setScreen("player");
    playerCode.value = preCode;
  }

  // ---------------- HOST ----------------
  async function createSession(){
    const code = code6();
    hostCode = code;

    await SESS(code).set({
      code,
      createdAt: now(),
      status: "lobby",      // lobby | playing
      phase: "night",       // night | day
      round: 1,
      config: { mafiaCount: 1, sniperCount: 1, jesterCount: 1, sniperUsed: false },
      winner: "",           // "", "mafia", "citizens", "jester"
      log: "ุชู ุฅูุดุงุก ุงูุฌูุณุฉ.",
      votes: { night:{mafia:{}}, day:{public:{}}, dayExtra:{sniper:{}} }
    });
    await SESS(code).child("players").set({});

    me = { mode:"host", code };
    setMe(me);

    hostCodeEl.textContent = code;
    setScreen("host");
    subscribeHost(code);
  }

  function subscribeHost(code){
    if (hostSub) hostSub.off();
    hostSub = SESS(code);

    hostSub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      hostStatus.textContent = s.status === "lobby" ? "ุจุงูุชุธุงุฑ ุงููุงุนุจูู" : "ุจุฏุฃุช ุงููุนุจุฉ";
      hostPhase.textContent = s.phase === "night" ? "ููู ๐" : "ููุงุฑ โ๏ธ";
      hostRound.textContent = String(s.round || 1);
      hostLog.textContent = s.log || "โ";
      hostWinner.textContent = s.winner ? (s.winner === "jester" ? "๐คก ุงูููุฑูุฌ" : s.winner === "mafia" ? "๐ฅ ุงููุงููุง" : "๐ฉ ุงูููุงุทููู") : "โ";

      // players list (roles hidden)
      const playersObj = s.players || {};
      const players = Object.values(playersObj);
      hostCount.textContent = String(players.length || 0);

      hostPlayers.innerHTML = "";
      if (players.length === 0) {
        hostPlayers.innerHTML = `<div class="text-slate-400 text-sm">ูุง ููุฌุฏ ูุงุนุจูู ุจุนุฏ.</div>`;
      } else {
        players.forEach(p => {
          hostPlayers.innerHTML += `
            <div class="flex items-center justify-between rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
              <div class="font-bold">${escapeHtml(p.name)}</div>
              <div class="text-xs px-2 py-1 rounded-xl border ${p.alive ? "border-emerald-700 bg-emerald-900/30 text-emerald-200" : "border-rose-800 bg-rose-900/20 text-rose-200"}">
                ${p.alive ? "ุญู" : "ููุช"}
              </div>
            </div>
          `;
        });
      }

      // vote info (counts only)
      const alive = players.filter(x => x.alive).length;
      if (s.phase === "night") {
        const mv = s.votes?.night?.mafia || {};
        hostVoteInfo.textContent = `${Object.keys(mv).length}/${Math.max(1, players.filter(x => x.alive && x.role === "mafia").length)} (ูุงููุง)`;
      } else {
        const dv = s.votes?.day?.public || {};
        hostVoteInfo.textContent = `${Object.keys(dv).length}/${Math.max(1, alive)} (ููุงุฑ)`;
      }
    });
  }

  async function lockAndAssign(){
    if (!hostCode) return;

    const snap = await SESS(hostCode).get();
    const s = snap.val();
    const playersObj = s?.players || {};
    const players = Object.values(playersObj);

    if (players.length < 5) return alert("ูุงุฒู 5 ูุงุนุจูู ุนูู ุงูุฃูู.");

    const mafiaCount = Math.max(1, Number(hostMafia.value || 1));
    await SESS(hostCode).child("config/mafiaCount").set(mafiaCount);

    // Roles: mafia + sniper(1) + jester(1) + rest citizens
    const roles = [];
    for (let i=0;i<mafiaCount;i++) roles.push("mafia");
    roles.push("sniper");
    roles.push("jester");

    if (roles.length > players.length) return alert("ุนุฏุฏ ุงูุฃุฏูุงุฑ ุฃูุจุฑ ูู ุนุฏุฏ ุงููุงุนุจูู.");

    while (roles.length < players.length) roles.push("citizen");

    const rolesShuffled = shuffle(roles);
    const playersShuffled = shuffle(players);

    const updates = {};
    playersShuffled.forEach((p, idx) => {
      updates[`players/${p.id}/role`] = rolesShuffled[idx];
      updates[`players/${p.id}/alive`] = true;
      updates[`players/${p.id}/joinedAt`] = p.joinedAt || now();
    });

    updates["status"] = "playing";
    updates["phase"] = "night";
    updates["round"] = 1;
    updates["winner"] = "";
    updates["config/sniperUsed"] = false;
    updates["votes"] = { night:{mafia:{}}, day:{public:{}}, dayExtra:{sniper:{}} };
    updates["log"] = "ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ. ุจุฏุฃุช ุงููุนุจุฉ: ููู ๐ (ุชุตููุช ุงููุงููุง).";

    await SESS(hostCode).update(updates);
    alert("ุชู ุงูุชูุฒูุน โ ุงูุขู ุงููุงููุง ุชุตููุช ูู ุฌูุงูุงุชูู.");
  }

  async function togglePhase(){
    if (!hostCode) return;
    const snap = await SESS(hostCode).get();
    const s = snap.val();
    if (!s || s.winner) return alert("ุงููุนุจุฉ ููุชููุฉ.");

    const next = s.phase === "night" ? "day" : "night";
    const nextRound = next === "night" ? (Number(s.round||1)+1) : Number(s.round||1);

    await SESS(hostCode).update({
      phase: next,
      round: nextRound,
      votes: { night:{mafia:{}}, day:{public:{}}, dayExtra:{sniper:{}} },
      log: `ุชู ุงูุงูุชูุงู ุฅูู ${next === "night" ? "ููู ๐" : "ููุงุฑ โ๏ธ"} (ุงูุฌููุฉ ${nextRound}).`
    });
  }

  function computeWinner(players){
    const alive = players.filter(p => p.alive);
    const mafiaAlive = alive.filter(p => p.role === "mafia").length;
    const others = alive.length - mafiaAlive;
    if (mafiaAlive === 0) return "citizens";
    if (mafiaAlive >= others) return "mafia";
    return "";
  }

  async function resolvePhase(){
    if (!hostCode) return;

    const snap = await SESS(hostCode).get();
    const s = snap.val();
    if (!s || s.status !== "playing") return alert("ุงูุฌูุณุฉ ุบูุฑ ุฌุงูุฒุฉ.");
    if (s.winner) return alert("ุงููุนุจุฉ ููุชููุฉ.");

    const playersObj = s.players || {};
    const players = Object.values(playersObj);
    const aliveObj = Object.fromEntries(players.filter(p => p.alive).map(p => [p.id, p]));

    // Helper: tally votes object -> topId
    const topVoted = (votes) => {
      const tally = {};
      Object.values(votes || {}).forEach(id => {
        if (!id) return;
        tally[id] = (tally[id] || 0) + 1;
      });
      return Object.entries(tally).sort((a,b)=>b[1]-a[1])[0]?.[0] || "";
    };

    if (s.phase === "night") {
      const victimId = topVoted(s.votes?.night?.mafia);
      if (!victimId) return alert("ูุง ููุฌุฏ ุชุตููุช ูุงููุง ูุงูู.");

      if (aliveObj[victimId]) {
        await SESS(hostCode).child(`players/${victimId}/alive`).set(false);
        await SESS(hostCode).child("log").set(`ูุชูุฌุฉ ุงูููู: ุชู ูุชู ูุงุนุจ: ${aliveObj[victimId].name}`);
      }
    } else {
      // Day: first apply sniper if used this day
      const sniperTargetId = topVoted(s.votes?.dayExtra?.sniper);
      if (sniperTargetId && !s.config?.sniperUsed && aliveObj[sniperTargetId]) {
        await SESS(hostCode).child(`players/${sniperTargetId}/alive`).set(false);
        await SESS(hostCode).child("config/sniperUsed").set(true);
        await SESS(hostCode).child("log").set(`๐ฏ ุงูููุงุต ูุชู ูุงุนุจ: ${aliveObj[sniperTargetId].name}`);
      }

      // Then public vote eliminate
      const outId = topVoted(s.votes?.day?.public);
      if (!outId) return alert("ูุง ููุฌุฏ ุชุตููุช ููุงุฑ ูุงูู.");

      const out = aliveObj[outId];
      if (out) {
        await SESS(hostCode).child(`players/${outId}/alive`).set(false);

        // Jester win if eliminated by day vote
        if (out.role === "jester") {
          await SESS(hostCode).update({
            winner: "jester",
            log: "๐คก ูุงุฒ ุงูููุฑูุฌ ูุญุฏู! (ุชู ุฅูุตุงุคู ุจุงูุชุตููุช)"
          });
          alert("ูุงุฒ ุงูููุฑูุฌ ๐คก๐");
          return;
        } else {
          await SESS(hostCode).child("log").set(`ูุชูุฌุฉ ุงูููุงุฑ: ุชู ุฅูุตุงุก ูุงุนุจ: ${out.name}`);
        }
      }
    }

    // Winner check
    const newSnap = await SESS(hostCode).get();
    const ns = newSnap.val();
    const w = computeWinner(Object.values(ns.players || {}));
    if (w) {
      await SESS(hostCode).update({
        winner: w,
        log: w === "mafia" ? "๐ ูุงุฒุช ุงููุงููุง!" : "๐ ูุงุฒ ุงูููุงุทููู!"
      });
      alert(w === "mafia" ? "ูุงุฒุช ุงููุงููุง ๐ฅ๐" : "ูุงุฒ ุงูููุงุทููู ๐ฉ๐");
    } else {
      alert("ุชู ุชูููุฐ ุงููุชูุฌุฉ โ");
    }
  }

  // ---------------- PLAYER ----------------
  async function joinSession(){
    const code = String(playerCode.value || "").trim();
    const name = String(playerName.value || "").trim();
    if (!/^\d{6}$/.test(code)) return alert("ุงูุชุจ ููุฏ ุตุญูุญ (6 ุฃุฑูุงู).");
    if (!name) return alert("ุงูุชุจ ุงุณูู.");

    const sessSnap = await SESS(code).get();
    const s = sessSnap.val();
    if (!s) return alert("ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ.");

    const pid = rid();
    me = { mode:"player", code, pid, name };
    setMe(me);

    await SESS(code).child(`players/${pid}`).set({
      id: pid,
      name,
      alive: true,
      role: "",
      joinedAt: now()
    });

    setScreen("player");
    joinBox.classList.add("hidden");
    playerBox.classList.remove("hidden");
    pName.textContent = name;
    pCode.textContent = code;

    subscribePlayer(code, pid);
  }

  function subscribePlayer(code, pid){
    if (playerSub) playerSub.off();
    playerSub = SESS(code);
    playerSub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      // winner banner for all
      if (s.winner) {
        winnerBanner.classList.remove("hidden");
        winnerText.textContent = s.winner === "jester" ? "๐คก๐ ูุงุฒ ุงูููุฑูุฌ ูุญุฏู!" :
                                 s.winner === "mafia" ? "๐ฅ๐ ูุงุฒุช ุงููุงููุง!" : "๐ฉ๐ ูุงุฒ ุงูููุงุทููู!";
      } else {
        winnerBanner.classList.add("hidden");
      }

      const meObj = s.players?.[pid];
      if (!meObj) return;

      // Phase
      pPhase.textContent = s.phase === "night" ? "ููู ๐" : "ููุงุฑ โ๏ธ";
      pRound.textContent = String(s.round || 1);

      // Role (only this player sees)
      const roleKey = meObj.role || "";
      if (!roleKey) {
        myRoleText.textContent = "ุจุงูุชุธุงุฑ ุชูุฒูุน ุงูุฃุฏูุงุฑโฆ";
        myRoleHint.textContent = "ุงููุฏูุฑ ุณูููู ุจุชูุฒูุน ุงูุฃุฏูุงุฑ ูุฑูุจูุง.";
      } else {
        myRoleText.textContent = ROLE_UI[roleKey]?.name || roleKey;
        myRoleHint.textContent = ROLE_UI[roleKey]?.hint || "โ";
      }

      // Vote status
      renderMyVoteStatus(s, pid, roleKey);

      // Action UI
      renderPlayerAction(s, pid, meObj, roleKey);
    });
  }

  function renderMyVoteStatus(s, pid, roleKey){
    if (s.phase === "night") {
      if (roleKey !== "mafia") {
        myVoteStatus.textContent = "ููู: ูุง ููุฌุฏ ุชุตููุช ูู.";
        return;
      }
      const v = s.votes?.night?.mafia?.[pid];
      myVoteStatus.textContent = v ? "โ ุชู ุฅุฑุณุงู ุชุตููุช ุงููุชู." : "โณ ูู ุชุตููุช ุจุนุฏ.";
    } else {
      const v = s.votes?.day?.public?.[pid];
      let extra = "";
      if (roleKey === "sniper") {
        const sv = s.votes?.dayExtra?.sniper?.[pid];
        extra = s.config?.sniperUsed ? " | ๐ฏ ุงูุทููุฉ ูุณุชูููุฉ." : (sv ? " | ๐ฏ ุชู ุชุญุฏูุฏ ูุฏู ุงูููุงุต." : " | ๐ฏ ูู ุชุณุชุฎุฏู ุงูุทููุฉ.");
      }
      myVoteStatus.textContent = (v ? "โ ุชู ุฅุฑุณุงู ุชุตููุช ุงูููุงุฑ." : "โณ ูู ุชุตููุช ุจุนุฏ.") + extra;
    }
  }

  function buildAliveOptions(playersObj){
    const alive = Object.values(playersObj || {}).filter(p => p.alive);
    return alive.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
  }

  function renderPlayerAction(s, pid, meObj, roleKey){
    const playersObj = s.players || {};
    const aliveOptions = buildAliveOptions(playersObj);

    // Dead player
    if (!meObj.alive) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุฃูุช ุฎุงุฑุฌ ุงููุนุจุฉ โ</div>`;
      return;
    }

    // Not assigned yet
    if (!roleKey) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุจุงูุชุธุงุฑ ุชูุฒูุน ุงูุฃุฏูุงุฑ ูู ุงููุฏูุฑโฆ</div>`;
      return;
    }

    if (s.winner) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุงูุชูุช ุงููุนุจุฉ ๐</div>`;
      return;
    }

    // Night
    if (s.phase === "night") {
      if (roleKey !== "mafia") {
        pActionBox.innerHTML = `<div class="text-center text-slate-300">ูููโฆ ุงูุชุธุฑ (ุชุตููุช ุงููุงููุง ููุท).</div>`;
        return;
      }
      pActionBox.innerHTML = `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="font-extrabold text-lg">ุชุตููุช ุงููุงููุง (ูุชู)</div>
          <select id="selNightKill" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
            <option value="">ุงุฎุชุฑ ุงูุถุญูุฉ</option>
            ${aliveOptions}
          </select>
          <button id="btnNightKill" class="tap w-full px-4 py-4 rounded-3xl bg-rose-600 hover:bg-rose-500 font-extrabold">
            ุฅุฑุณุงู ุงูุชุตููุช
          </button>
          <div class="text-xs text-slate-400">ุชุตููุชู ุณุฑู ููู ูุธูุฑ ูุฃุญุฏ.</div>
        </div>
      `;
      $("btnNightKill").addEventListener("click", async () => {
        const victimId = $("selNightKill").value || "";
        if (!victimId) return alert("ุงุฎุชุฑ ุงูุถุญูุฉ.");
        await SESS(me.code).child(`votes/night/mafia/${pid}`).set(victimId);
        alert("ุชู ุชุณุฌูู ุชุตููุชู โ");
      });
      return;
    }

    // Day
    const dayVoteBox = `
      <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
        <div class="font-extrabold text-lg">ุชุตููุช ุงูููุงุฑ (ุฅูุตุงุก)</div>
        <select id="selDayVote" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
          <option value="">ุงุฎุชุฑ ุงูุดุฎุต</option>
          ${aliveOptions}
        </select>
        <button id="btnDayVote" class="tap w-full px-4 py-4 rounded-3xl bg-amber-600 hover:bg-amber-500 font-extrabold">
          ุฅุฑุณุงู ุงูุชุตููุช
        </button>
        <div class="text-xs text-slate-400">ูุชู ุชูููุฐ ุงููุชูุฌุฉ ุนูุฏ ุถุบุท ุงููุฏูุฑ โุชูููุฐ ุงููุชูุฌุฉโ.</div>
      </div>
    `;

    const sniperBox = (roleKey === "sniper")
      ? `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">๐ฏ ุงูููุงุต</div>
            <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">
              ${s.config?.sniperUsed ? "ูุณุชุฎุฏู" : "ูุชุงุญ"}
            </div>
          </div>
          <div class="text-sm text-slate-300">ุทููุฉ ูุงุญุฏุฉ ุทูุงู ุงููุนุจุฉ (ููููู ุนุฏู ุงุณุชุฎุฏุงููุง).</div>
          <select id="selSniper" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${s.config?.sniperUsed ? "disabled" : ""}>
            <option value="">ุงุฎุชุฑ ูุฏู ุงูููุงุต</option>
            ${aliveOptions}
          </select>
          <button id="btnSniper" class="tap w-full px-4 py-4 rounded-3xl ${s.config?.sniperUsed ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${s.config?.sniperUsed ? "disabled" : ""}>
            ${s.config?.sniperUsed ? "ุชู ุงุณุชุฎุฏุงู ุงูุทููุฉ" : "ุชุญุฏูุฏ ุงููุฏู (ุชุตููุช ุณุฑู)"}
          </button>
          <div class="text-xs text-slate-400">ูุชู ุชูููุฐ ูุชู ุงูููุงุต ุนูุฏ ุถุบุท ุงููุฏูุฑ โุชูููุฐ ุงููุชูุฌุฉโ.</div>
        </div>
      ` : "";

    pActionBox.innerHTML = dayVoteBox + sniperBox;

    $("btnDayVote").addEventListener("click", async () => {
      const targetId = $("selDayVote").value || "";
      if (!targetId) return alert("ุงุฎุชุฑ ุงูุดุฎุต.");
      await SESS(me.code).child(`votes/day/public/${pid}`).set(targetId);
      alert("ุชู ุชุณุฌูู ุชุตููุชู โ");
    });

    if (roleKey === "sniper" && !s.config?.sniperUsed) {
      $("btnSniper").addEventListener("click", async () => {
        const targetId = $("selSniper").value || "";
        if (!targetId) return alert("ุงุฎุชุฑ ูุฏู ุงูููุงุต.");
        await SESS(me.code).child(`votes/dayExtra/sniper/${pid}`).set(targetId);
        alert("ุชู ุชุญุฏูุฏ ูุฏู ุงูููุงุต โ");
      });
    }
  }

  // Role toggle
  btnToggleRole.addEventListener("click", () => {
    myRoleCard.classList.toggle("hidden");
  });

  // Copy/share button
  btnCopyShare.addEventListener("click", () => {
    if (me?.mode === "host" && hostCode) return shareLink(hostCode);
    if (me?.mode === "player" && me?.code) return shareLink(me.code);
  });

  // Reset local
  btnResetLocal.addEventListener("click", () => {
    clearMe();
    location.href = location.pathname; // remove query
  });

  // Buttons
  btnGoHost.addEventListener("click", createSession);
  btnGoPlayer.addEventListener("click", () => setScreen("player"));

  btnCopyJoin.addEventListener("click", () => hostCode && shareLink(hostCode));
  btnHostLockAndAssign.addEventListener("click", lockAndAssign);
  btnHostTogglePhase.addEventListener("click", togglePhase);
  btnHostResolve.addEventListener("click", resolvePhase);

  btnPlayerJoin.addEventListener("click", joinSession);

  btnBackMode1.addEventListener("click", () => { clearMe(); setScreen("mode"); });
  btnBackMode2.addEventListener("click", () => { clearMe(); setScreen("mode"); });

  // Auto resume
  if (me?.mode === "host" && me?.code) {
    hostCode = me.code;
    hostCodeEl.textContent = hostCode;
    setScreen("host");
    subscribeHost(hostCode);
  } else if (me?.mode === "player" && me?.code && me?.pid) {
    setScreen("player");
    joinBox.classList.add("hidden");
    playerBox.classList.remove("hidden");
    pName.textContent = me.name;
    pCode.textContent = me.code;
    subscribePlayer(me.code, me.pid);
  } else {
    setScreen("mode");
  }
})();
</script>
</body>
</html>
