<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø§ÙÙŠØ§ â€” Ù„Ø¹Ø¨ Ø¢Ù„ÙŠ Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠØ±</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <style>
    body { padding-bottom: env(safe-area-inset-bottom); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-40 bg-slate-950/80 glass border-b border-slate-800">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="text-lg font-extrabold">ğŸ•µï¸â€â™‚ï¸ Ù…Ø§ÙÙŠØ§</div>
        <div id="badgeMini" class="hidden text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">â€”</div>
      </div>
      <div class="flex gap-2">
        <button id="btnCopyShare" class="hidden tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          Ù…Ø´Ø§Ø±ÙƒØ©
        </button>
        <button id="btnResetLocal" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 py-5 space-y-4">

    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± -->
    <section id="screenMode" class="space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 shadow">
        <h1 class="text-2xl font-extrabold">Ù…Ø§ÙÙŠØ§ â€” Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠØ±</h1>
        <p class="text-slate-300 text-sm mt-2 leading-6">
          â€¢ Ø£ÙˆÙ„ Ø´Ø®Øµ ÙŠÙ†Ø´Ø¦ Ø§Ù„Ø¬Ù„Ø³Ø© ÙŠØ¯Ø®Ù„ ÙƒÙ„Ø§Ø¹Ø¨ ÙˆÙŠØ¶Ø¨Ø· Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø«Ù… ÙŠØ¶ØºØ· <b>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</b>.<br>
          â€¢ Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡: <b>Ø§Ù„Ù…Ø±Ø§Ø­Ù„ + Ø§Ù„Ù…Ø¤Ù‚Øª + ØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªØ§Ø¦Ø¬</b> ÙƒÙ„Ù‡Ø§ ØªØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.
        </p>
      </div>

      <button id="btnGoCreate" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
        Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© (ÙˆØ£Ù†Ø§ Ù„Ø§Ø¹Ø¨)
      </button>

      <button id="btnGoJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
        Ø¯Ø®ÙˆÙ„ Ø¬Ù„Ø³Ø©
      </button>

      <div class="text-xs text-slate-400 text-center">
        ØªÙ‚Ø¯Ø± ØªØ±Ø³Ù„ â€œØ±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„â€ Ø¨Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯.
      </div>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ -->
    <section id="screenCreate" class="hidden space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø©</h2>

        <label class="text-sm text-slate-300">Ø§Ø³Ù…Ùƒ</label>
        <input id="createName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <div class="grid grid-cols-2 gap-2 mt-2">
          <div>
            <label class="text-sm text-slate-300">Ù…Ø¯Ø© Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ø«Ø§Ù†ÙŠØ©)</label>
            <input id="cfgSeconds" type="number" min="15" value="120"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
          </div>
          <div>
            <label class="text-sm text-slate-300">Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø¯Ù„</label>
            <select id="cfgTieMode"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
              <option value="revote">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØª</option>
              <option value="random">Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
            </select>
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-300">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§</label>
          <input id="cfgMafia" type="number" min="1" value="1"
            class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ + Ø¹Ø¯Ø¯)</div>
            <div class="text-xs text-slate-400">Ø§Ù„Ø¨Ø§Ù‚ÙŠ â€œÙ…ÙˆØ§Ø·Ù†â€</div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ¯ Ù‚Ù†Ø§Øµ</span>
                <input id="roleSniperOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleSniperCount" type="number" min="0" max="10" value="1"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ¤¡ Ù…Ù‡Ø±Ù‘Ø¬</span>
                <input id="roleJesterOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleJesterCount" type="number" min="0" max="10" value="1"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ©º Ø·Ø¨ÙŠØ¨</span>
                <input id="roleDoctorOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleDoctorCount" type="number" min="0" max="10" value="1"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ” Ù…Ø­Ù‚Ù‚</span>
                <input id="roleDetectiveOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleDetectiveCount" type="number" min="0" max="10" value="1"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ›¡ï¸ Ø­Ø§Ø±Ø³</span>
                <input id="roleBodyguardOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleBodyguardCount" type="number" min="0" max="10" value="1"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ”ª Ù‚Ø§ØªÙ„ Ù…ØªØ³Ù„Ø³Ù„</span>
                <input id="roleSerialOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleSerialCount" type="number" min="0" max="10" value="1"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>
          </div>

          <div class="text-xs text-slate-400 leading-6">
            â€¢ Ø§Ù„Ø·Ø¨ÙŠØ¨: ÙŠØ®ØªØ§Ø± Ø´Ø®ØµÙ‹Ø§ Ù„Ø¥Ù†Ù‚Ø§Ø°Ù‡ (Ù„ÙŠÙ„).<br>
            â€¢ Ø§Ù„Ù…Ø­Ù‚Ù‚: ÙŠØ­Ù‚Ù‚ ÙˆÙŠØ¸Ù‡Ø± Ù„Ù‡ ÙÙ‚Ø· â€œÙ…Ø§ÙÙŠØ§/Ù„ÙŠØ³ Ù…Ø§ÙÙŠØ§â€ (Ù„ÙŠÙ„).<br>
            â€¢ Ø§Ù„Ø­Ø§Ø±Ø³: ÙŠØ­Ù…ÙŠ Ø´Ø®ØµÙ‹Ø§Ø› Ø¥Ø°Ø§ Ù‡Ø§Ø¬Ù…Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ Ù‡Ø¯ÙÙ‡ ÙŠÙ…ÙˆØª Ø§Ù„Ø­Ø§Ø±Ø³ Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù†Ù‡ (Ù„ÙŠÙ„).<br>
            â€¢ Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„: ÙŠÙ‚ØªÙ„ Ø´Ø®ØµÙ‹Ø§ (Ù„ÙŠÙ„) ÙˆÙ‡Ùˆ Ø·Ø±Ù Ù…Ø³ØªÙ‚Ù„ (ÙŠÙÙˆØ² Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ù„ÙˆØ­Ø¯Ù‡).
          </div>
        </div>

        <button id="btnCreateSession" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©
        </button>

        <button id="btnBackFromCreate" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          Ø±Ø¬ÙˆØ¹
        </button>
      </div>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
    <section id="screenPlayer" class="hidden space-y-4">
      <div id="joinBox" class="hidden rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">Ø¯Ø®ÙˆÙ„ Ø¬Ù„Ø³Ø©</h2>

        <label class="text-sm text-slate-300">ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©</label>
        <input id="playerCode" placeholder="Ù…Ø«Ø§Ù„: 482913"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <label class="text-sm text-slate-300">Ø§Ø³Ù…Ùƒ</label>
        <input id="playerName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <button id="btnPlayerJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
          Ø¯Ø®ÙˆÙ„
        </button>

        <button id="btnBackFromJoin" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          Ø±Ø¬ÙˆØ¹
        </button>

        <div class="text-xs text-slate-400">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©.</div>
      </div>

      <div id="playerBox" class="hidden space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xs text-slate-300">Ø§Ù„Ø¬Ù„Ø³Ø©</div>
              <div class="text-2xl font-extrabold mt-1">
                <span id="pName">â€”</span> Â· <span class="tracking-widest" id="pCode">â€”</span>
              </div>
              <div id="lobbyHint" class="text-sm text-slate-300 mt-2 leading-6">â€”</div>
            </div>
            <div class="text-left">
              <div class="text-xs text-slate-300">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
              <div id="phaseLeft" class="text-2xl font-extrabold mt-1">â€”</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
              <div class="text-xs text-slate-300">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
              <div id="pPhase" class="text-2xl font-extrabold mt-1">â€”</div>
            </div>
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 text-right">
              <div class="text-xs text-slate-300">Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
              <div id="pRound" class="text-2xl font-extrabold mt-1">â€”</div>
            </div>
          </div>

          <div id="winnerBanner" class="hidden rounded-2xl border border-amber-700 bg-amber-900/20 p-3">
            <div class="font-extrabold" id="winnerText">â€”</div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©</div>
            <div id="publicLog" class="mt-1 text-slate-300 text-sm leading-6">â€”</div>
          </div>
        </div>

        <div id="lobbyBox" class="hidden rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</div>
            <div class="text-xs text-slate-400"><span id="playerCount">â€”</span></div>
          </div>
          <div id="playersList" class="space-y-2"></div>

          <button id="btnStartGame" class="hidden tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
            Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©
          </button>

          <div class="text-xs text-slate-400 leading-6">
            Ø§Ù„Ø´Ø±Ø·: 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£Ùˆ Ø£ÙƒØ«Ø±. Ø¨Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØµÙŠØ± Ø¢Ù„ÙŠ.
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Ø¯ÙˆØ±Ùƒ</div>
            <button id="btnToggleRole" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
              Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡
            </button>
          </div>

          <div id="myRoleCard" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
            <div id="myRoleText" class="text-3xl font-extrabold">â€”</div>
            <div id="myRoleHint" class="text-sm text-slate-300 mt-2 leading-6">â€”</div>
            <div id="roleExtraBox" class="mt-3 hidden rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <div class="text-xs text-slate-300">Ù…Ø¹Ù„ÙˆÙ…Ø© Ø®Ø§ØµØ©</div>
              <div id="roleExtraText" class="mt-1 font-bold">â€”</div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">Ø­Ø§Ù„Ø© ØªØµÙˆÙŠØªÙƒ</div>
            <div id="myVoteStatus" class="text-sm text-slate-300 mt-1">â€”</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
            <div class="text-xs text-slate-400">ğŸ“Š <span id="liveTally">â€”</span></div>
          </div>
          <div id="pActionBox" class="mt-3 space-y-3"></div>
        </div>
      </div>
    </section>
  </main>

<script>
(() => {
  const firebaseConfig = {
    apiKey: "AIzaSyC4YdqgiAfJmRmvkLH4wspzclAzKs3wyLw",
    authDomain: "mafia-game-7e488.firebaseapp.com",
    databaseURL: "https://mafia-game-7e488-default-rtdb.firebaseio.com",
    projectId: "mafia-game-7e488",
    storageBucket: "mafia-game-7e488.firebasestorage.app",
    messagingSenderId: "513186840934",
    appId: "1:513186840934:web:ccf858b27cea91be1448a7"
  };

  const $ = (id) => document.getElementById(id);
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const rid = () => (crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint32Array(2))].map(x=>x.toString(16)).join("") : String(Math.random()).slice(2));
  const now = () => Date.now();
  const code6 = () => String(Math.floor(100000 + Math.random() * 900000));
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const shuffle = (arr) => { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
  const normName = (s) => String(s || "").trim().replace(/\s+/g, " ").toLowerCase();
  const clampInt = (x, lo, hi) => Math.max(lo, Math.min(hi, Number(x || 0)));

  function fmtLeft(ms){
    const s = Math.max(0, Math.ceil(ms / 1000));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return m > 0 ? `${m}:${String(r).padStart(2,"0")}` : `${r}s`;
  }
  function tallyText(votesObj){
    const tally = {};
    Object.values(votesObj || {}).forEach(id => { if (!id) return; tally[id] = (tally[id] || 0) + 1; });
    const total = Object.keys(votesObj || {}).length;
    const arr = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
    if (total === 0) return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆØ§Øª Ø¨Ø¹Ø¯.";
    const top = arr.length ? arr[0][1] : 0;
    return `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${total} ØµÙˆØª. Ø£Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø¹Ù„ÙŠÙ‡ ${top} ØµÙˆØª.`;
  }
  function getTopCandidates(votes){
    const tally = {};
    Object.values(votes || {}).forEach(id => { if (!id) return; tally[id] = (tally[id] || 0) + 1; });
    const entries = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
    if (!entries.length) return { max: 0, candidates: [] };
    const max = entries[0][1];
    const candidates = entries.filter(([,c]) => c === max).map(([id]) => id);
    return { max, candidates };
  }

  const LS_KEY = "mafia_identity_auto_v1";
  const getMe = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; } };
  const setMe = (o) => localStorage.setItem(LS_KEY, JSON.stringify(o));
  const clearMe = () => localStorage.removeItem(LS_KEY);

  const SESS = (code) => db.ref(`sessions/${code}`);

  // UI refs
  const badgeMini = $("badgeMini");
  const btnCopyShare = $("btnCopyShare");
  const btnResetLocal = $("btnResetLocal");
  const screenMode = $("screenMode");
  const screenCreate = $("screenCreate");
  const screenPlayer = $("screenPlayer");
  const btnGoCreate = $("btnGoCreate");
  const btnGoJoin = $("btnGoJoin");

  const createName = $("createName");
  const cfgSeconds = $("cfgSeconds");
  const cfgTieMode = $("cfgTieMode");
  const cfgMafia = $("cfgMafia");
  const roleSniperOn = $("roleSniperOn");
  const roleJesterOn = $("roleJesterOn");
  const roleDoctorOn = $("roleDoctorOn");
  const roleDetectiveOn = $("roleDetectiveOn");
  const roleBodyguardOn = $("roleBodyguardOn");
  const roleSerialOn = $("roleSerialOn");
  const roleSniperCount = $("roleSniperCount");
  const roleJesterCount = $("roleJesterCount");
  const roleDoctorCount = $("roleDoctorCount");
  const roleDetectiveCount = $("roleDetectiveCount");
  const roleBodyguardCount = $("roleBodyguardCount");
  const roleSerialCount = $("roleSerialCount");
  const btnCreateSession = $("btnCreateSession");
  const btnBackFromCreate = $("btnBackFromCreate");

  const joinBox = $("joinBox");
  const playerCode = $("playerCode");
  const playerName = $("playerName");
  const btnPlayerJoin = $("btnPlayerJoin");
  const btnBackFromJoin = $("btnBackFromJoin");

  const playerBox = $("playerBox");
  const pName = $("pName");
  const pCode = $("pCode");
  const pPhase = $("pPhase");
  const pRound = $("pRound");
  const phaseLeft = $("phaseLeft");
  const lobbyHint = $("lobbyHint");
  const publicLog = $("publicLog");
  const winnerBanner = $("winnerBanner");
  const winnerText = $("winnerText");
  const lobbyBox = $("lobbyBox");
  const playerCount = $("playerCount");
  const playersList = $("playersList");
  const btnStartGame = $("btnStartGame");

  const btnToggleRole = $("btnToggleRole");
  const myRoleCard = $("myRoleCard");
  const myRoleText = $("myRoleText");
  const myRoleHint = $("myRoleHint");
  const roleExtraBox = $("roleExtraBox");
  const roleExtraText = $("roleExtraText");
  const myVoteStatus = $("myVoteStatus");
  const liveTally = $("liveTally");
  const pActionBox = $("pActionBox");

  const ROLE_UI = {
    mafia: { name:"Ù…Ø§ÙÙŠØ§", hint:"Ø¨Ø§Ù„Ù„ÙŠÙ„: ØµÙˆÙ‘Øª Ù„Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨. Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±: Ø­Ø§ÙˆÙ„ Ù…Ø§ ØªÙ†ÙƒØ´Ù." },
    citizen: { name:"Ù…ÙˆØ§Ø·Ù†", hint:"Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±: ØµÙˆÙ‘Øª ØµØ­. Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ù†ØªØ¸Ø±." },
    sniper: { name:"Ù‚Ù†Ø§Øµ", hint:"ğŸ¯ Ø·Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø·ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±). Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ø³Ø±ÙŠ." },
    jester: { name:"Ù…Ù‡Ø±Ù‘Ø¬", hint:"ğŸ¤¡ Ù‡Ø¯ÙÙƒ ÙŠØªÙ… Ø¥Ù‚ØµØ§Ø¤Ùƒ Ø¨Ø§Ù„ØªØµÙˆÙŠØª ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø± Ù„ØªÙÙˆØ² ÙˆØ­Ø¯Ùƒ ÙÙˆØ±Ù‹Ø§." },
    doctor: { name:"Ø·Ø¨ÙŠØ¨", hint:"ğŸ©º Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„Ø¥Ù†Ù‚Ø§Ø°Ù‡ Ù…Ù† Ø§Ù„Ù‚ØªÙ„." },
    detective: { name:"Ù…Ø­Ù‚Ù‚", hint:"ğŸ” Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„Ù„ØªØ­Ù‚ÙŠÙ‚ (ÙŠØ¸Ù‡Ø± Ù„Ùƒ: Ù…Ø§ÙÙŠØ§/Ù„ÙŠØ³ Ù…Ø§ÙÙŠØ§)." },
    bodyguard: { name:"Ø­Ø§Ø±Ø³", hint:"ğŸ›¡ï¸ Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„ØªØ­Ù…ÙŠÙ‡. Ø¥Ø°Ø§ Ù‡Ø§Ø¬Ù…ØªÙ‡ Ø§Ù„Ù…Ø§ÙÙŠØ§ Ù‡Ø¯ÙÙ‡ ØªÙ…ÙˆØª Ø£Ù†Øª Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù†Ù‡." },
    serial: { name:"Ù‚Ø§ØªÙ„ Ù…ØªØ³Ù„Ø³Ù„", hint:"ğŸ”ª Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„Ù‚ØªÙ„Ù‡. Ù‡Ø¯ÙÙƒ ØªØ¨Ù‚Ù‰ Ø¢Ø®Ø± Ø´Ø®Øµ Ø­ÙŠ." },
  };

  let me = getMe();
  let sub = null;
  let engineTimer = null;

  function setScreen(which){
    screenMode.classList.add("hidden");
    screenCreate.classList.add("hidden");
    screenPlayer.classList.add("hidden");
    joinBox.classList.add("hidden");
    playerBox.classList.add("hidden");
    btnCopyShare.classList.add("hidden");
    badgeMini.classList.add("hidden");

    if (which === "mode") screenMode.classList.remove("hidden");
    if (which === "create") screenCreate.classList.remove("hidden");
    if (which === "join") { screenPlayer.classList.remove("hidden"); joinBox.classList.remove("hidden"); }
    if (which === "player") {
      screenPlayer.classList.remove("hidden");
      playerBox.classList.remove("hidden");
      btnCopyShare.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = me?.isCreator ? "Ù…ÙÙ†Ø´Ø¦" : "Ù„Ø§Ø¹Ø¨";
    }
  }

  function shareLink(code){
    const url = `${location.origin}${location.pathname}?code=${code}`;
    navigator.clipboard?.writeText(url);
    alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„.");
  }

  const urlParams = new URLSearchParams(location.search);
  const preCode = urlParams.get("code");
  if (preCode && !me) { setScreen("join"); playerCode.value = preCode; }

  function readRolesFromUI(){
    const mk = (onEl, cntEl) => ({ on: !!onEl?.checked, count: clampInt(cntEl?.value, 0, 20) });
    return {
      sniper: mk(roleSniperOn, roleSniperCount),
      jester: mk(roleJesterOn, roleJesterCount),
      doctor: mk(roleDoctorOn, roleDoctorCount),
      detective: mk(roleDetectiveOn, roleDetectiveCount),
      bodyguard: mk(roleBodyguardOn, roleBodyguardCount),
      serial: mk(roleSerialOn, roleSerialCount),
    };
  }

  async function createSessionAsPlayer(){
    const name = String(createName.value || "").trim();
    if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ.");

    const seconds = clampInt(cfgSeconds.value, 15, 3600);
    const tieMode = String(cfgTieMode.value || "revote");
    const mafiaCount = Math.max(1, Number(cfgMafia.value || 1));
    const rolesCfg = readRolesFromUI();

    const code = code6();
    const pid = rid();

    await SESS(code).set({
      code,
      createdAt: now(),
      status: "lobby",
      phase: "lobby",
      round: 0,
      phaseEndAt: 0,
      creatorPid: pid,
      config: {
        phaseSeconds: seconds,
        tieMode,
        mafiaCount,
        roles: rolesCfg,
        sniperUsedBy: {}
      },
      winner: "",
      log: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©. Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†â€¦",
      votes: {
        night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{} },
        day: { public:{} },
        dayExtra: { sniper:{} }
      },
      private: { detectiveResults:{} },
      engine: { lock: { holder:"", expiresAt: 0 }, lastRunAt: 0 }
    });

    await SESS(code).child(`players/${pid}`).set({ id: pid, name, alive:true, role:"", joinedAt: now() });

    me = { code, pid, name, isCreator:true };
    setMe(me);

    setScreen("player");
    pName.textContent = name;
    pCode.textContent = code;
    subscribe(code, pid);
  }

  async function joinSession(){
    const code = String(playerCode.value || "").trim();
    const name = String(playerName.value || "").trim();
    if (!/^\d{6}$/.test(code)) return alert("Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ ØµØ­ÙŠØ­ (6 Ø£Ø±Ù‚Ø§Ù…).");
    if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ.");

    const snap = await SESS(code).get();
    const s = snap.val();
    if (!s) return alert("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

    const wanted = normName(name);
    const existing = Object.values(s.players || {}).some(p => normName(p.name) === wanted);
    if (existing) return alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©. Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§ Ø¢Ø®Ø±.");

    const pid = rid();
    await SESS(code).child(`players/${pid}`).set({ id: pid, name, alive:true, role:"", joinedAt: now() });

    me = { code, pid, name, isCreator: false };
    setMe(me);

    setScreen("player");
    pName.textContent = name;
    pCode.textContent = code;
    subscribe(code, pid);
  }

  function computeWinner(players){
    const alive = players.filter(p => p.alive);
    if (alive.length === 0) return "";
    const mafiaAlive = alive.filter(p => p.role === "mafia").length;
    const serialAlive = alive.filter(p => p.role === "serial").length;
    if (alive.length === 1 && alive[0].role === "serial") return "serial";
    if (mafiaAlive === 0 && serialAlive === 0) return "citizens";
    if (mafiaAlive > 0 && mafiaAlive >= (alive.length - mafiaAlive)) return "mafia";
    return "";
  }

  function buildAliveOptions(playersObj, excludeId, allowSelf){
    const alive = Object.values(playersObj || {}).filter(p => p.alive && (allowSelf || p.id !== excludeId));
    return alive.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
  }

  // Engine lock
  async function tryAcquireLock(code, pid){
    const lockRef = SESS(code).child("engine/lock");
    const leaseMs = 8000;
    const res = await lockRef.transaction((cur) => {
      const c = cur || { holder:"", expiresAt:0 };
      if (!c.holder || (c.expiresAt || 0) < now() || c.holder === pid) {
        return { holder: pid, expiresAt: now() + leaseMs };
      }
      return;
    });
    return !!res.committed;
  }
  async function renewLock(code, pid){
    const lockRef = SESS(code).child("engine/lock");
    const leaseMs = 8000;
    await lockRef.transaction((cur) => {
      const c = cur || { holder:"", expiresAt:0 };
      if (c.holder === pid) return { holder: pid, expiresAt: now() + leaseMs };
      return;
    });
  }

  async function engineStep(code, pid){
    const acquired = await tryAcquireLock(code, pid);
    if (!acquired) return;

    try {
      const snap = await SESS(code).get();
      const s = snap.val();
      if (!s || s.winner) return;
      if (s.status !== "playing") return;

      const phase = s.phase;
      const phaseEndAt = Number(s.phaseEndAt || 0);
      const playersObj = s.players || {};
      const players = Object.values(playersObj);
      const alive = players.filter(p => p.alive);

      let ready = false;
      if (phase === "night") {
        const aliveMafiaIds = alive.filter(p => p.role === "mafia").map(p => p.id);
        if (aliveMafiaIds.length === 0) ready = (now() >= phaseEndAt);
        else {
          const mv = s.votes?.night?.mafia || {};
          const voted = aliveMafiaIds.filter(id => mv[id]);
          ready = (voted.length === aliveMafiaIds.length) || (now() >= phaseEndAt);
        }
      } else if (phase === "day") {
        const dv = s.votes?.day?.public || {};
        const voted = alive.map(p => p.id).filter(id => dv[id]);
        ready = (voted.length === alive.length) || (now() >= phaseEndAt);
      }

      if (!ready) return;

      const lastRunAt = Number(s.engine?.lastRunAt || 0);
      if (now() - lastRunAt < 1000) return;
      await SESS(code).child("engine/lastRunAt").set(now());

      const tieMode = String(s.config?.tieMode || "revote");
      const seconds = clampInt(s.config?.phaseSeconds, 15, 3600);
      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

      async function tieRevote(path, msg){
        if (tieMode === "revote") {
          const upd = {};
          upd[path] = {};
          upd["log"] = msg + " ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØª.";
          upd["phaseEndAt"] = now() + seconds*1000;
          await SESS(code).update(upd);
          return { stop:true };
        }
        return { stop:false };
      }

      const aliveObj = Object.fromEntries(alive.map(p => [p.id, p]));

      if (phase === "night") {
        const killedMsgs = [];

        const aliveMafiaIds = alive.filter(p => p.role === "mafia").map(p => p.id);
        const mafiaVotes = s.votes?.night?.mafia || {};
        let mafiaVictimId = "";
        if (aliveMafiaIds.length > 0) {
          const top = getTopCandidates(mafiaVotes);
          if (top.candidates.length === 1) mafiaVictimId = top.candidates[0];
          else if (top.candidates.length > 1) {
            const r = await tieRevote("votes/night/mafia", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ (${top.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
            if (r.stop) return;
            mafiaVictimId = pick(top.candidates);
          }
        }

        const docVotes = s.votes?.night?.doctor || {};
        let savedId = "";
        if (Object.keys(docVotes).length) {
          const top = getTopCandidates(docVotes);
          if (top.candidates.length === 1) savedId = top.candidates[0] || "";
          else if (top.candidates.length > 1) {
            const r = await tieRevote("votes/night/doctor", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ø·Ø¨ÙŠØ¨ (${top.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
            if (r.stop) return;
            savedId = pick(top.candidates);
          }
        }

        const bgVotes = s.votes?.night?.bodyguard || {};
        let protectedId = "";
        if (Object.keys(bgVotes).length) {
          const top = getTopCandidates(bgVotes);
          if (top.candidates.length === 1) protectedId = top.candidates[0] || "";
          else if (top.candidates.length > 1) {
            const r = await tieRevote("votes/night/bodyguard", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ø­Ø§Ø±Ø³ (${top.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
            if (r.stop) return;
            protectedId = pick(top.candidates);
          }
        }

        const skVotes = s.votes?.night?.serial || {};
        let skVictimId = "";
        if (Object.keys(skVotes).length) {
          const top = getTopCandidates(skVotes);
          if (top.candidates.length === 1) skVictimId = top.candidates[0] || "";
          else if (top.candidates.length > 1) {
            const r = await tieRevote("votes/night/serial", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ (${top.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
            if (r.stop) return;
            skVictimId = pick(top.candidates);
          }
        }

        const detVotes = s.votes?.night?.detective || {};
        for (const [detPid, targetId] of Object.entries(detVotes || {})) {
          const t = playersObj[targetId];
          const res = t ? (t.role === "mafia" ? "ğŸŸ¥ Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù…Ø§ÙÙŠØ§" : "ğŸŸ© Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù„ÙŠØ³ Ù…Ø§ÙÙŠØ§") : "Ø§Ù„Ù‡Ø¯Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
          await SESS(code).child(`private/detectiveResults/${detPid}`).set(res);
        }

        if (mafiaVictimId && aliveObj[mafiaVictimId]) {
          if (mafiaVictimId === savedId) killedMsgs.push(`ğŸ©º ØªÙ… Ø¥Ù†Ù‚Ø§Ø° ${aliveObj[mafiaVictimId].name}`);
          else if (mafiaVictimId === protectedId) {
            const bgAlive = alive.filter(p => p.role === "bodyguard")[0];
            if (bgAlive) {
              await SESS(code).child(`players/${bgAlive.id}/alive`).set(false);
              killedMsgs.push(`ğŸ›¡ï¸ Ø§Ù„Ø­Ø§Ø±Ø³ Ù…Ø§Øª Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù† ${aliveObj[mafiaVictimId].name}`);
            } else {
              await SESS(code).child(`players/${mafiaVictimId}/alive`).set(false);
              killedMsgs.push(`ğŸŒ™ Ù‚ØªÙ„ Ø§Ù„Ù…Ø§ÙÙŠØ§: ${aliveObj[mafiaVictimId].name}`);
            }
          } else {
            await SESS(code).child(`players/${mafiaVictimId}/alive`).set(false);
            killedMsgs.push(`ğŸŒ™ Ù‚ØªÙ„ Ø§Ù„Ù…Ø§ÙÙŠØ§: ${aliveObj[mafiaVictimId].name}`);
          }
        }

        if (skVictimId && aliveObj[skVictimId]) {
          if (skVictimId === savedId) killedMsgs.push(`ğŸ©º ØªÙ… Ø¥Ù†Ù‚Ø§Ø° ${aliveObj[skVictimId].name} (Ù…Ù† Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„)`);
          else if (skVictimId === protectedId) {
            const bgAlive = alive.filter(p => p.role === "bodyguard")[0];
            if (bgAlive) {
              await SESS(code).child(`players/${bgAlive.id}/alive`).set(false);
              killedMsgs.push(`ğŸ›¡ï¸ Ø§Ù„Ø­Ø§Ø±Ø³ Ù…Ø§Øª Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù† ${aliveObj[skVictimId].name} (Ù‡Ø¬ÙˆÙ… Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„)`);
            } else {
              await SESS(code).child(`players/${skVictimId}/alive`).set(false);
              killedMsgs.push(`ğŸ”ª Ù‚ØªÙ„ Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„: ${aliveObj[skVictimId].name}`);
            }
          } else {
            await SESS(code).child(`players/${skVictimId}/alive`).set(false);
            killedMsgs.push(`ğŸ”ª Ù‚ØªÙ„ Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„: ${aliveObj[skVictimId].name}`);
          }
        }

        await SESS(code).child("log").set(killedMsgs.length ? killedMsgs.join(" | ") : "ğŸŒ™ Ù„Ù… ÙŠØ­Ø¯Ø« Ø´ÙŠØ¡ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©.");

        await SESS(code).update({
          phase: "day",
          round: Number(s.round || 1),
          phaseEndAt: now() + seconds*1000,
          votes: { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{} }, day: { public:{} }, dayExtra: { sniper:{} } }
        });

      } else if (phase === "day") {
        const dayVotes = s.votes?.day?.public || {};
        const top = getTopCandidates(dayVotes);

        if (!top.candidates.length) {
          await SESS(code).child("log").set("â˜€ï¸ Ù„Ù… ÙŠØµÙˆÙ‘Øª Ø£Ø­Ø¯.");
        } else {
          let outId = top.candidates[0];
          if (top.candidates.length > 1) {
            const r = await tieRevote("votes/day/public", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± (${top.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
            if (r.stop) return;
            outId = pick(top.candidates);
          }
          const out = aliveObj[outId];
          if (out) {
            await SESS(code).child(`players/${outId}/alive`).set(false);
            if (out.role === "jester") {
              await SESS(code).update({ winner:"jester", log:"ğŸ¤¡ ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ÙˆØ­Ø¯Ù‡! (ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ù‡ Ø¨Ø§Ù„ØªØµÙˆÙŠØª)" });
              return;
            }
            await SESS(code).child("log").set(`â˜€ï¸ ØªÙ… Ø¥Ù‚ØµØ§Ø¡ Ù„Ø§Ø¹Ø¨: ${out.name}`);
          }
        }

        const sniperVotes = s.votes?.dayExtra?.sniper || {};
        for (const [snPid, targetId] of Object.entries(sniperVotes || {})) {
          const usedBy = s.config?.sniperUsedBy || {};
          if (usedBy[snPid]) continue;
          if (playersObj[snPid]?.role !== "sniper") continue;
          if (playersObj[targetId]?.alive) {
            await SESS(code).child(`players/${targetId}/alive`).set(false);
            await SESS(code).child(`config/sniperUsedBy/${snPid}`).set(true);
            await SESS(code).child("log").set(`ğŸ¯ Ø§Ù„Ù‚Ù†Ø§Øµ Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨: ${playersObj[targetId].name}`);
          }
        }

        await SESS(code).update({
          phase: "night",
          round: Number(s.round || 0) + 1,
          phaseEndAt: now() + seconds*1000,
          votes: { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{} }, day: { public:{} }, dayExtra: { sniper:{} } }
        });
      }

      const after = (await SESS(code).get()).val();
      const w = computeWinner(Object.values(after.players || {}));
      if (w) {
        await SESS(code).update({
          winner: w,
          log: w === "serial" ? "ğŸ† ÙØ§Ø² Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„!" : (w === "mafia" ? "ğŸ† ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§!" : "ğŸ† ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†!")
        });
      }
    } finally {
      await renewLock(code, pid).catch(()=>{});
    }
  }

  function startEngine(code, pid){
    if (engineTimer) clearInterval(engineTimer);
    engineTimer = setInterval(() => engineStep(code, pid).catch(()=>{}), 1200);
  }

  async function startGameIfCreator(){
    if (!me?.code || !me?.pid) return;

    const snap = await SESS(me.code).get();
    const s = snap.val();
    if (!s) return alert("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
    if (s.creatorPid !== me.pid) return alert("ÙÙ‚Ø· Ù…ÙÙ†Ø´Ø¦ Ø§Ù„Ø¬Ù„Ø³Ø© ÙŠØ³ØªØ·ÙŠØ¹ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.");
    if (s.status !== "lobby") return alert("Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„.");

    const players = Object.values(s.players || {});
    if (players.length < 5) return alert("Ù„Ø§Ø²Ù… 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");

    const seconds = clampInt(s.config?.phaseSeconds, 15, 3600);
    const mafiaCount = Math.max(1, Number(s.config?.mafiaCount || 1));
    const rolesCfg = s.config?.roles || {};

    const roles = [];
    for (let i=0;i<mafiaCount;i++) roles.push("mafia");
    const addRole = (key) => {
      const r = rolesCfg[key];
      if (!r?.on) return;
      const cnt = Math.max(0, Number(r.count || 0));
      for (let i=0;i<cnt;i++) roles.push(key);
    };
    ["sniper","jester","doctor","detective","bodyguard","serial"].forEach(addRole);

    if (roles.length > players.length) return alert(`Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ø§Ù„Ø£Ø¯ÙˆØ§Ø±=${roles.length} Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†=${players.length}`);
    while (roles.length < players.length) roles.push("citizen");

    const rolesShuffled = shuffle(roles);
    const playersShuffled = shuffle(players);

    const updates = {};
    playersShuffled.forEach((p, idx) => {
      updates[`players/${p.id}/role`] = rolesShuffled[idx];
      updates[`players/${p.id}/alive`] = true;
    });

    updates["status"] = "playing";
    updates["phase"] = "night";
    updates["round"] = 1;
    updates["winner"] = "";
    updates["phaseEndAt"] = now() + seconds*1000;
    updates["config/sniperUsedBy"] = {};
    updates["votes"] = { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{} }, day: { public:{} }, dayExtra: { sniper:{} } };
    updates["private/detectiveResults"] = {};
    updates["log"] = "Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: Ù„ÙŠÙ„ ğŸŒ™";

    await SESS(me.code).update(updates);
    alert("ØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ âœ…");
  }

  function subscribe(code, pid){
    if (sub) sub.off();
    sub = SESS(code);

    setScreen("player");
    pName.textContent = me.name;
    pCode.textContent = code;

    startEngine(code, pid);

    sub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      me.isCreator = (me.pid === s.creatorPid);
      setMe(me);
      badgeMini.textContent = me.isCreator ? "Ù…ÙÙ†Ø´Ø¦" : "Ù„Ø§Ø¹Ø¨";

      publicLog.textContent = s.log || "â€”";

      if (s.status === "lobby") {
        pPhase.textContent = "Ù„ÙˆØ¨Ù‘ÙŠ";
        pRound.textContent = "â€”";
        phaseLeft.textContent = "â€”";
        lobbyHint.innerHTML = `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©â€¦ Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¯Ø®Ù„ÙˆØ§ ÙƒÙ„Ù‘ÙƒÙ….`;
        lobbyBox.classList.remove("hidden");

        const players = Object.values(s.players || {});
        playerCount.textContent = `${players.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†`;
        playersList.innerHTML = players.length ? "" : `<div class="text-slate-400 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¹Ø¯.</div>`;
        players.forEach(p => {
          playersList.innerHTML += `
            <div class="flex items-center justify-between rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
              <div class="font-bold">${escapeHtml(p.name)}</div>
              <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">Ø¬Ø§Ù‡Ø²</div>
            </div>`;
        });

        btnStartGame.classList.toggle("hidden", !(me.isCreator && players.length >= 5));
        myVoteStatus.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©â€¦";
        pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©â€¦</div>`;
        myRoleText.textContent = "â€”";
        myRoleHint.textContent = "â€”";
        roleExtraBox.classList.add("hidden");
        return;
      }

      lobbyBox.classList.add("hidden");

      const phase = s.phase;
      pPhase.textContent = phase === "night" ? "Ù„ÙŠÙ„ ğŸŒ™" : "Ù†Ù‡Ø§Ø± â˜€ï¸";
      pRound.textContent = String(s.round || 1);

      const endAt = Number(s.phaseEndAt || 0);
      phaseLeft.textContent = endAt ? fmtLeft(endAt - now()) : "â€”";
      lobbyHint.innerHTML = `Ø§Ù„Ù„Ø¹Ø¨Ø© ØªÙØ¯Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§. ØµÙˆÙ‘Øª/Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø­Ø³Ø¨ Ø¯ÙˆØ±Ùƒ.`;

      if (s.winner) {
        winnerBanner.classList.remove("hidden");
        winnerText.textContent =
          s.winner === "jester" ? "ğŸ¤¡ğŸ† ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ÙˆØ­Ø¯Ù‡!" :
          s.winner === "serial" ? "ğŸ”ªğŸ† ÙØ§Ø² Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„!" :
          s.winner === "mafia" ? "ğŸŸ¥ğŸ† ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§!" : "ğŸŸ©ğŸ† ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†!";
      } else winnerBanner.classList.add("hidden");

      const meObj = s.players?.[pid];
      if (!meObj) return;

      const roleKey = meObj.role || "";
      if (!roleKey) {
        myRoleText.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±â€¦";
        myRoleHint.textContent = "Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.";
      } else {
        myRoleText.textContent = ROLE_UI[roleKey]?.name || roleKey;
        myRoleHint.textContent = ROLE_UI[roleKey]?.hint || "â€”";
      }

      const detRes = s.private?.detectiveResults?.[pid];
      if (detRes) { roleExtraBox.classList.remove("hidden"); roleExtraText.textContent = detRes; }
      else roleExtraBox.classList.add("hidden");

      liveTally.textContent = (phase === "night") ? tallyText(s.votes?.night?.mafia) : tallyText(s.votes?.day?.public);

      renderPlayerAction(s, pid, meObj, roleKey);
    });
  }

  function renderPlayerAction(s, pid, meObj, roleKey){
    const phase = s.phase;
    const playersObj = s.players || {};

    if (!meObj.alive) {
      myVoteStatus.textContent = "âŒ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø©";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø© âŒ</div>`;
      return;
    }
    if (!roleKey) {
      myVoteStatus.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©â€¦";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©â€¦</div>`;
      return;
    }
    if (s.winner) {
      myVoteStatus.textContent = "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ</div>`;
      return;
    }

    if (phase === "night") {
      const parts = [];
      if (roleKey === "mafia") parts.push(s.votes?.night?.mafia?.[pid] ? "âœ… ØµÙˆÙ‘Øª (Ù…Ø§ÙÙŠØ§)" : "â³ Ù„Ù… ØªØµÙˆÙ‘Øª (Ù…Ø§ÙÙŠØ§)");
      if (roleKey === "doctor") parts.push(s.votes?.night?.doctor?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª Ø¥Ù†Ù‚Ø§Ø°" : "â³ Ù„Ù… ØªØ®ØªØ± Ø¥Ù†Ù‚Ø§Ø°");
      if (roleKey === "detective") parts.push(s.votes?.night?.detective?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª ØªØ­Ù‚ÙŠÙ‚" : "â³ Ù„Ù… ØªØ®ØªØ± ØªØ­Ù‚ÙŠÙ‚");
      if (roleKey === "bodyguard") parts.push(s.votes?.night?.bodyguard?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª Ø­Ù…Ø§ÙŠØ©" : "â³ Ù„Ù… ØªØ®ØªØ± Ø­Ù…Ø§ÙŠØ©");
      if (roleKey === "serial") parts.push(s.votes?.night?.serial?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª Ù‚ØªÙ„" : "â³ Ù„Ù… ØªØ®ØªØ± Ù‚ØªÙ„");
      myVoteStatus.textContent = parts.length ? parts.join(" | ") : "Ù„ÙŠÙ„: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ùƒ.";

      if (roleKey === "mafia") {
        const aliveOptions = buildAliveOptions(playersObj, pid, false);
        const already = s.votes?.night?.mafia?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ (Ù‚ØªÙ„)</div>
            <select id="selNightKill" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©</option>${aliveOptions}
            </select>
            <button id="btnNightKill" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnNightKill").addEventListener("click", async () => {
          const victimId = $("selNightKill").value || "";
          if (!victimId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©.");
          await SESS(me.code).child(`votes/night/mafia/${pid}`).set(victimId);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "doctor") {
        const aliveOptions = buildAliveOptions(playersObj, pid, true);
        const already = s.votes?.night?.doctor?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ©º Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø¥Ù†Ù‚Ø§Ø°)</div>
            <select id="selDoc" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ù…Ù† ØªÙ†Ù‚Ø°Ù‡</option>${aliveOptions}
            </select>
            <button id="btnDoc" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-emerald-600 hover:bg-emerald-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnDoc").addEventListener("click", async () => {
          const t = $("selDoc").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨.");
          await SESS(me.code).child(`votes/night/doctor/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "detective") {
        const aliveOptions = buildAliveOptions(playersObj, pid, false);
        const already = s.votes?.night?.detective?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ” Ø§Ù„Ù…Ø­Ù‚Ù‚ (ØªØ­Ù‚ÙŠÙ‚)</div>
            <select id="selDet" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù</option>${aliveOptions}
            </select>
            <button id="btnDet" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-sky-600 hover:bg-sky-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
            <div class="text-xs text-slate-400">Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªØ¸Ù‡Ø± Ù„Ùƒ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°.</div>
          </div>`;
        if (!already) $("btnDet").addEventListener("click", async () => {
          const t = $("selDet").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ù‡Ø¯Ù.");
          await SESS(me.code).child(`votes/night/detective/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "bodyguard") {
        const aliveOptions = buildAliveOptions(playersObj, pid, true);
        const already = s.votes?.night?.bodyguard?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ›¡ï¸ Ø§Ù„Ø­Ø§Ø±Ø³ (Ø­Ù…Ø§ÙŠØ©)</div>
            <select id="selBg" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ù…Ù† ØªØ­Ù…ÙŠÙ‡</option>${aliveOptions}
            </select>
            <button id="btnBg" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-indigo-600 hover:bg-indigo-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnBg").addEventListener("click", async () => {
          const t = $("selBg").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨.");
          await SESS(me.code).child(`votes/night/bodyguard/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "serial") {
        const aliveOptions = buildAliveOptions(playersObj, pid, false);
        const already = s.votes?.night?.serial?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ (Ù‚ØªÙ„)</div>
            <select id="selSk" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©</option>${aliveOptions}
            </select>
            <button id="btnSk" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnSk").addEventListener("click", async () => {
          const t = $("selSk").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©.");
          await SESS(me.code).child(`votes/night/serial/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ù„ÙŠÙ„â€¦ Ø§Ù†ØªØ¸Ø±.</div>`;
      return;
    }

    // Day
    const v = s.votes?.day?.public?.[pid];
    const used = !!s.config?.sniperUsedBy?.[pid];
    const sv = s.votes?.dayExtra?.sniper?.[pid];
    const extra = (roleKey === "sniper") ? (used ? " | ğŸ¯ Ø§Ù„Ø·Ù„Ù‚Ø© Ù…Ø³ØªÙ‡Ù„ÙƒØ©." : (sv ? " | ğŸ¯ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù." : " | ğŸ¯ Ù„Ù… ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ù„Ù‚Ø©.")) : "";
    myVoteStatus.textContent = (v ? "âœ… ØªÙ… ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø±." : "â³ Ù„Ù… ØªØµÙˆÙ‘Øª Ø¨Ø¹Ø¯.") + extra;

    const aliveOptionsNoSelf = buildAliveOptions(playersObj, pid, false);
    const dayAlready = !!v;
    const sniperDisabled = used || !!sv;

    pActionBox.innerHTML = `
      <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
        <div class="font-extrabold text-lg">ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± (Ø¥Ù‚ØµØ§Ø¡)</div>
        <select id="selDayVote" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${dayAlready ? "disabled" : ""}>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</option>${aliveOptionsNoSelf}
        </select>
        <button id="btnDayVote" class="tap w-full px-4 py-4 rounded-3xl ${dayAlready ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-amber-600 hover:bg-amber-500"} font-extrabold" ${dayAlready ? "disabled" : ""}>
          ${dayAlready ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª"}
        </button>
      </div>

      ${roleKey === "sniper" ? `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ğŸ¯ Ø§Ù„Ù‚Ù†Ø§Øµ</div>
            <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">
              ${used ? "Ù…Ø³ØªØ®Ø¯Ù…" : (sv ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ù…ØªØ§Ø­")}
            </div>
          </div>
          <select id="selSniper" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${sniperDisabled ? "disabled" : ""}>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù</option>${aliveOptionsNoSelf}
          </select>
          <button id="btnSniper" class="tap w-full px-4 py-4 rounded-3xl ${sniperDisabled ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${sniperDisabled ? "disabled" : ""}>
            ${used ? "ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ù„Ù‚Ø©" : (sv ? "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù" : "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù (Ø³Ø±ÙŠ)")}
          </button>
        </div>
      ` : "" }
    `;

    if (!dayAlready) $("btnDayVote").addEventListener("click", async () => {
      const targetId = $("selDayVote").value || "";
      if (!targetId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ.");
      await SESS(me.code).child(`votes/day/public/${pid}`).set(targetId);
      alert("ØªÙ… âœ…");
    });

    if (roleKey === "sniper" && !sniperDisabled) $("btnSniper").addEventListener("click", async () => {
      const targetId = $("selSniper").value || "";
      if (!targetId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù.");
      await SESS(me.code).child(`votes/dayExtra/sniper/${pid}`).set(targetId);
      alert("ØªÙ… âœ…");
    });
  }

  // Events
  btnGoCreate.addEventListener("click", () => setScreen("create"));
  btnGoJoin.addEventListener("click", () => setScreen("join"));
  btnBackFromCreate.addEventListener("click", () => setScreen("mode"));
  btnBackFromJoin.addEventListener("click", () => setScreen("mode"));
  btnCreateSession.addEventListener("click", createSessionAsPlayer);
  btnPlayerJoin.addEventListener("click", joinSession);
  btnToggleRole.addEventListener("click", () => myRoleCard.classList.toggle("hidden"));
  btnCopyShare.addEventListener("click", () => me?.code && shareLink(me.code));
  btnStartGame.addEventListener("click", startGameIfCreator);
  btnResetLocal.addEventListener("click", () => { clearMe(); location.href = location.pathname; });

  // Countdown
  setInterval(() => {
    if (!me?.code) return;
    SESS(me.code).child("phaseEndAt").get().then(snap => {
      const endAt = Number(snap.val() || 0);
      if (!endAt) return;
      phaseLeft.textContent = fmtLeft(endAt - now());
    }).catch(()=>{});
  }, 1000);

  // Resume
  if (me?.code && me?.pid) {
    setScreen("player");
    pName.textContent = me.name;
    pCode.textContent = me.code;
    subscribe(me.code, me.pid);
    startEngine(me.code, me.pid);
  } else if (preCode) {
    setScreen("join");
  } else {
    setScreen("mode");
  }
})();
</script>
</body>
</html>
