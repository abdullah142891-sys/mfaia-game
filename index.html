<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ูุงููุง โ ุฌูุณุฉ ูุดุชุฑูุฉ</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <style>
    body { padding-bottom: env(safe-area-inset-bottom); }
    .tap { -webkit-tap-highlight-color: transparent; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-40 bg-slate-950/90 backdrop-blur border-b border-slate-800">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="font-extrabold text-lg">๐ต๏ธโโ๏ธ ูุงููุง (ุฌูุณุฉ)</div>
      <button id="btnResetLocal" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
        ูุณุญ ุจูุงูุงุช ุฌูุงุฒู
      </button>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 py-5 space-y-4">

    <!-- ุดุงุดุฉ ุงุฎุชูุงุฑ: ูุฏูุฑ / ูุงุนุจ -->
    <section id="screenMode" class="space-y-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
        <h1 class="text-xl font-extrabold">ุงุฎุชุฑ ูุถุนู</h1>
        <p class="text-slate-300 text-sm mt-1">ุงููุฏูุฑ = ุฃูุช ููุท. ุงููุงุนุจ = ูู ุดุฎุต ูุฏุฎู ูู ุฌูุงูู.</p>
      </div>

      <button id="btnGoHost" class="tap w-full px-4 py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
        ุฃูุง ุงููุฏูุฑ (ุฅูุดุงุก ุฌูุณุฉ)
      </button>

      <button id="btnGoPlayer" class="tap w-full px-4 py-4 rounded-2xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
        ุฃูุง ูุงุนุจ (ุฏุฎูู ุฌูุณุฉ)
      </button>
    </section>

    <!-- ุดุงุดุฉ ุงููุฏูุฑ -->
    <section id="screenHost" class="hidden space-y-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-2">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-300">ููุฏ ุงูุฌูุณุฉ</div>
            <div id="hostCode" class="text-3xl font-extrabold tracking-widest">โ</div>
          </div>
          <button id="btnCopyJoin" class="tap px-4 py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">
            ูุณุฎ ุฑุงุจุท ุงูุฏุฎูู
          </button>
        </div>
        <div class="text-sm text-slate-300">
          ุดุงุฑู ุงูููุฏ (ุฃู ุงูุฑุงุจุท) ูุน ุงููุงุนุจูู. ูู ูุงุนุจ ูุฏุฎู ุจุงุณู ูุฎุชูู.
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-3">
        <h2 class="font-extrabold">ุฅุนุฏุงุฏ ุงูุฃุฏูุงุฑ (ุจุฏูู ูุง ุชุดูู ุชูุฒูุนูุง)</h2>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-300">ุนุฏุฏ ุงููุงููุง</label>
            <input id="hostMafia" type="number" min="1" value="1"
              class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
          </div>
          <div>
            <label class="text-sm text-slate-300">ุฃุฏูุงุฑ ุฅุถุงููุฉ ูุงุญููุง</label>
            <div class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 text-slate-400 text-sm">
              (ููุงุต + ููุฑูุฌ ุณููุนูููู ุจุนุฏ ุงูุชุฃูุฏ)
            </div>
          </div>
        </div>

        <button id="btnHostLockAndAssign" class="tap w-full px-4 py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          ููู ุงููุงุนุจูู + ุชูุฒูุน ุงูุฃุฏูุงุฑ
        </button>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 text-sm text-slate-300">
          <div class="font-extrabold">ูุงุฆูุฉ ุงููุงุนุจูู (ุฃุญูุงุก/ูุณุฌููู)</div>
          <div id="hostPlayers" class="mt-2 space-y-2"></div>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-300">ุงููุฑุญูุฉ</div>
            <div id="hostPhase" class="text-2xl font-extrabold">โ</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-300">ุงูุฌููุฉ</div>
            <div id="hostRound" class="text-2xl font-extrabold">โ</div>
          </div>
        </div>

        <button id="btnHostTogglePhase" class="tap w-full px-4 py-4 rounded-2xl bg-sky-600 hover:bg-sky-500 font-extrabold">
          ุชุจุฏูู ููู/ููุงุฑ
        </button>

        <button id="btnHostResolve" class="tap w-full px-4 py-4 rounded-2xl bg-amber-600 hover:bg-amber-500 font-extrabold">
          ุชูููุฐ ูุชุงุฆุฌ ุงููุฑุญูุฉ ุงูุญุงููุฉ
        </button>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 text-sm text-slate-300">
          <div class="font-extrabold">ุงููุชูุฌุฉ ุงูุฃุฎูุฑุฉ</div>
          <div id="hostLog" class="mt-1 text-slate-300">โ</div>
        </div>
      </div>

      <button id="btnBackMode1" class="tap w-full px-4 py-4 rounded-2xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
        ุฑุฌูุน
      </button>
    </section>

    <!-- ุดุงุดุฉ ุงููุงุนุจ -->
    <section id="screenPlayer" class="hidden space-y-4">
      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4 space-y-3">
        <h2 class="text-xl font-extrabold">ุฏุฎูู ุฌูุณุฉ</h2>

        <label class="text-sm text-slate-300">ููุฏ ุงูุฌูุณุฉ</label>
        <input id="playerCode" placeholder="ูุซุงู: 482913"
          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <label class="text-sm text-slate-300">ุงุณูู</label>
        <input id="playerName" placeholder="ูุซุงู: ุนุจุฏุงููู"
          class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <button id="btnPlayerJoin" class="tap w-full px-4 py-4 rounded-2xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
          ุฏุฎูู
        </button>

        <div class="text-xs text-slate-400">ุจุนุฏ ุงูุฏุฎูู ุณูุธูุฑ ุฏูุฑู ุฃูุช ููุท.</div>
      </div>

      <div id="playerAfterJoin" class="hidden space-y-4">
        <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
          <div class="text-xs text-slate-300">ุฃูุช ุฏุงุฎู ุฌูุณุฉ</div>
          <div class="text-2xl font-extrabold mt-1">
            <span id="pName">โ</span> ยท <span class="tracking-widest" id="pCode">โ</span>
          </div>
          <div class="mt-3 text-sm text-slate-300">
            ุฏูุฑู ูู ูุธูุฑ ูุบูุฑู.
          </div>
        </div>

        <button id="btnRevealMyRole" class="tap w-full px-4 py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          ๐๏ธ ุฅุธูุงุฑ ุฏูุฑู
        </button>

        <button id="btnHideMyRole" class="hidden tap w-full px-4 py-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">
          ๐ ุฅุฎูุงุก
        </button>

        <div id="myRoleCard" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
          <div class="text-xs text-slate-300">ุฏูุฑู</div>
          <div id="myRoleText" class="text-3xl font-extrabold mt-1">โ</div>
          <div id="myRoleHint" class="text-sm text-slate-300 mt-2">โ</div>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="text-xs text-slate-300">ุงููุฑุญูุฉ</div>
              <div id="pPhase" class="text-2xl font-extrabold">โ</div>
            </div>
            <div class="text-right">
              <div class="text-xs text-slate-300">ุงูุฌููุฉ</div>
              <div id="pRound" class="text-2xl font-extrabold">โ</div>
            </div>
          </div>

          <div id="pActionBox" class="mt-4 space-y-3">
            <!-- ุชุธูุฑ ููุง ูุงุฌูุฉ ุงูุชุตููุช ุญุณุจ ุงูุฏูุฑ/ุงููุฑุญูุฉ -->
          </div>
        </div>

        <button id="btnBackMode2" class="tap w-full px-4 py-4 rounded-2xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          ุฑุฌูุน
        </button>
      </div>
    </section>
  </main>

<script>
(() => {
  // ================== 1) ุถุน firebaseConfig ููุง ==================
const firebaseConfig = {
  apiKey: "AIzaSyC4YdqgiAfJmRmvkLH4wspzclAzKs3wyLw",
  authDomain: "mafia-game-7e488.firebaseapp.com",
  databaseURL: "https://mafia-game-7e488-default-rtdb.firebaseio.com",
  projectId: "mafia-game-7e488",
  storageBucket: "mafia-game-7e488.firebasestorage.app",
  messagingSenderId: "513186840934",
  appId: "1:513186840934:web:ccf858b27cea91be1448a7"
};

  // =============================================================

  const $ = (id) => document.getElementById(id);
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ---------- Helpers ----------
  const rid = () => (crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint32Array(2))].map(x=>x.toString(16)).join("") : String(Math.random()).slice(2));
  const code6 = () => String(Math.floor(100000 + Math.random() * 900000));
  const now = () => Date.now();
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const shuffle = (arr) => {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  };
  function setScreen(name){
    ["screenMode","screenHost","screenPlayer"].forEach(x=>$(x).classList.add("hidden"));
    $(name).classList.remove("hidden");
  }
  function toast(msg){ alert(msg); }

  // ---------- Local identity (ููู ุฌูุงุฒ ูุงุนุจ) ----------
  const LS_KEY = "mafia_player_identity_v1";
  function getIdentity(){
    const raw = localStorage.getItem(LS_KEY);
    return raw ? JSON.parse(raw) : null;
  }
  function setIdentity(obj){
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }
  function clearIdentity(){
    localStorage.removeItem(LS_KEY);
  }

  // ---------- Roles (MVP) ----------
  const ROLE_HINT = {
    mafia: "ุฃูุช ูุงููุง: ุจุงูููู ุตููุช ููุชู ูุงุนุจ ุจุฏูู ูุง ุชููุดู.",
    citizen: "ุฃูุช ููุงุทู: ุฑุงูุจ ุงูููุงู ูุตููุช ุตุญ ูู ุงูููุงุฑ.",
    // ุจูุถูู ุงูุทุจูุจ/ุงููุญูู/ุงูููุงุต/ุงูููุฑูุฌ ูุจุงุดุฑุฉ ุจุนุฏ ูุง ูุชุฃูุฏ ุงููุฒุงููุฉ ุดุบุงูุฉ
  };

  // ---------- Firebase paths ----------
  const SESS = (code) => db.ref(`sessions/${code}`);

  // ---------- UI refs ----------
  const btnGoHost = $("btnGoHost");
  const btnGoPlayer = $("btnGoPlayer");
  const btnResetLocal = $("btnResetLocal");

  // Host UI
  const hostCodeEl = $("hostCode");
  const btnCopyJoin = $("btnCopyJoin");
  const hostMafia = $("hostMafia");
  const btnHostLockAndAssign = $("btnHostLockAndAssign");
  const hostPlayers = $("hostPlayers");
  const hostPhase = $("hostPhase");
  const hostRound = $("hostRound");
  const btnHostTogglePhase = $("btnHostTogglePhase");
  const btnHostResolve = $("btnHostResolve");
  const hostLog = $("hostLog");
  const btnBackMode1 = $("btnBackMode1");

  // Player UI
  const playerCode = $("playerCode");
  const playerName = $("playerName");
  const btnPlayerJoin = $("btnPlayerJoin");
  const playerAfterJoin = $("playerAfterJoin");
  const pName = $("pName");
  const pCode = $("pCode");
  const btnRevealMyRole = $("btnRevealMyRole");
  const btnHideMyRole = $("btnHideMyRole");
  const myRoleCard = $("myRoleCard");
  const myRoleText = $("myRoleText");
  const myRoleHint = $("myRoleHint");
  const pPhase = $("pPhase");
  const pRound = $("pRound");
  const pActionBox = $("pActionBox");
  const btnBackMode2 = $("btnBackMode2");

  // ---------- URL join support ----------
  // ?code=XXXXXX
  const urlParams = new URLSearchParams(location.search);
  const preCode = urlParams.get("code");
  if (preCode) {
    playerCode.value = preCode;
    setScreen("screenPlayer");
  }

  // ---------- Host session state ----------
  let hostSessionCode = null;
  let hostUnsub = null;

  // ---------- Player session state ----------
  let me = getIdentity(); // {sessionCode, playerId, name}
  let playerUnsub = null;

  // ================== HOST FLOW ==================
  async function hostCreateSession(){
    const code = code6();
    hostSessionCode = code;

    const session = {
      code,
      createdAt: now(),
      status: "lobby",     // lobby | locked | playing
      phase: "night",      // night | day
      round: 1,
      config: { mafiaCount: 1 },
      log: "ุชู ุฅูุดุงุก ุงูุฌูุณุฉ.",
    };

    await SESS(code).set(session);
    await SESS(code).child("players").set({});     // players list
    await SESS(code).child("votes").set({});       // votes per phase

    hostCodeEl.textContent = code;
    setScreen("screenHost");
    subscribeHost(code);
  }

  function subscribeHost(code){
    if (hostUnsub) hostUnsub.off();
    hostUnsub = SESS(code);
    hostUnsub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      hostPhase.textContent = s.phase === "night" ? "ููู ๐" : "ููุงุฑ โ๏ธ";
      hostRound.textContent = String(s.round || 1);
      hostLog.textContent = s.log || "โ";

      // list players (without roles)
      const players = s.players ? Object.values(s.players) : [];
      hostPlayers.innerHTML = "";
      if (players.length === 0){
        hostPlayers.innerHTML = `<div class="text-slate-400 text-sm">ูุง ููุฌุฏ ูุงุนุจูู ุจุนุฏ.</div>`;
      } else {
        players.forEach(p => {
          hostPlayers.innerHTML += `
            <div class="flex items-center justify-between rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
              <div class="font-bold">${escapeHtml(p.name)}</div>
              <div class="text-xs px-2 py-1 rounded-xl border ${p.alive ? "border-emerald-700 bg-emerald-900/30 text-emerald-200" : "border-rose-800 bg-rose-900/20 text-rose-200"}">
                ${p.alive ? "ุญู" : "ููุช"}
              </div>
            </div>
          `;
        });
      }
    });
  }

  async function hostLockAndAssign(){
    const code = hostSessionCode;
    if (!code) return;

    const mafiaCount = Math.max(1, Number(hostMafia.value || 1));
    await SESS(code).child("config/mafiaCount").set(mafiaCount);

    const playersSnap = await SESS(code).child("players").get();
    const playersObj = playersSnap.val() || {};
    const players = Object.values(playersObj);

    if (players.length < 5) { toast("ุถูููุง ุนูู ุงูุฃูู 5 ูุงุนุจูู."); return; }

    // Build roles list (MVP: mafia + citizens ููุท)
    const roles = [];
    for (let i=0;i<mafiaCount;i++) roles.push("mafia");
    while (roles.length < players.length) roles.push("citizen");
    const shuffledRoles = shuffle(roles);
    const shuffledPlayers = shuffle(players);

    // Assign roles BUT DO NOT expose to host UI.
    // We store role under each player (they can read only theirs on their device by playerId)
    const updates = {};
    shuffledPlayers.forEach((p, idx) => {
      updates[`players/${p.id}/role`] = shuffledRoles[idx];
      updates[`players/${p.id}/alive`] = true;
      updates[`players/${p.id}/ready`] = true;
    });

    updates["status"] = "playing";
    updates["phase"] = "night";
    updates["round"] = 1;
    updates["log"] = "ุชู ููู ุงููุงุนุจูู ูุชูุฒูุน ุงูุฃุฏูุงุฑ. ุจุฏุฃุช ุงููุนุจุฉ (ููู).";
    updates["votes"] = {}; // reset votes

    await SESS(code).update(updates);
    toast("ุชู ุชูุฒูุน ุงูุฃุฏูุงุฑ! ุงูุขู ุงุจุฏุฃ ุงููุนุจ: ููู โ ุชุตููุช ุงููุงููุง ูู ุฌูุงูุงุชูู.");
  }

  async function hostTogglePhase(){
    const code = hostSessionCode;
    if (!code) return;

    const snap = await SESS(code).get();
    const s = snap.val();
    if (!s || s.status !== "playing") { toast("ุงูุฌูุณุฉ ุบูุฑ ุฌุงูุฒุฉ."); return; }

    const nextPhase = s.phase === "night" ? "day" : "night";
    const nextRound = (nextPhase === "night") ? (Number(s.round||1) + 1) : Number(s.round||1);

    await SESS(code).update({
      phase: nextPhase,
      round: nextRound,
      votes: {}, // reset votes each phase
      log: `ุชู ุงูุงูุชูุงู ุฅูู: ${nextPhase === "night" ? "ููู" : "ููุงุฑ"} (ุงูุฌููุฉ ${nextRound}).`
    });
  }

  async function hostResolvePhase(){
    const code = hostSessionCode;
    if (!code) return;

    const snap = await SESS(code).get();
    const s = snap.val();
    if (!s || s.status !== "playing") { toast("ุงูุฌูุณุฉ ุบูุฑ ุฌุงูุฒุฉ."); return; }

    const playersObj = s.players || {};
    const players = Object.values(playersObj).filter(p => p.alive);

    if (s.phase === "night") {
      // Night: mafia votes -> victim with max votes
      const votes = s.votes?.night?.mafia || {};
      const tally = {};
      Object.values(votes).forEach(victimId => {
        if (!victimId) return;
        tally[victimId] = (tally[victimId] || 0) + 1;
      });

      const victimId = Object.entries(tally).sort((a,b)=>b[1]-a[1])[0]?.[0] || null;
      if (!victimId) { toast("ูุง ููุฌุฏ ุชุตููุช ูุงููุง ูุงูู."); return; }

      // kill victim
      const victim = playersObj[victimId];
      if (victim) {
        await SESS(code).child(`players/${victimId}/alive`).set(false);
        await SESS(code).update({
          log: `ูุชูุฌุฉ ุงูููู: ุชู ูุชู ูุงุนุจ (ุงููุฏูุฑ ูุฑู ุงูุงุณู ููุท): ${victim.name}`
        });
      }
    } else {
      // Day: public vote -> eliminated with max votes
      const votes = s.votes?.day?.public || {};
      const tally = {};
      Object.values(votes).forEach(targetId => {
        if (!targetId) return;
        tally[targetId] = (tally[targetId] || 0) + 1;
      });

      const outId = Object.entries(tally).sort((a,b)=>b[1]-a[1])[0]?.[0] || null;
      if (!outId) { toast("ูุง ููุฌุฏ ุชุตููุช ููุงุฑ ูุงูู."); return; }

      const out = playersObj[outId];
      if (out) {
        await SESS(code).child(`players/${outId}/alive`).set(false);
        await SESS(code).update({
          log: `ูุชูุฌุฉ ุงูููุงุฑ: ุชู ุฅูุตุงุก ูุงุนุจ: ${out.name}`
        });
      }
    }

    toast("ุชู ุชูููุฐ ุงููุชูุฌุฉ.");
  }

  function hostCopyJoinLink(){
    if (!hostSessionCode) return;
    const url = `${location.origin}${location.pathname}?code=${hostSessionCode}`;
    navigator.clipboard?.writeText(url);
    toast("ุชู ูุณุฎ ุฑุงุจุท ุงูุฏุฎูู.");
  }

  // ================== PLAYER FLOW ==================
  async function playerJoin(){
    const code = String(playerCode.value || "").trim();
    const name = String(playerName.value || "").trim();

    if (!/^\d{6}$/.test(code)) { toast("ุงูุชุจ ููุฏ ุตุญูุญ (6 ุฃุฑูุงู)."); return; }
    if (!name) { toast("ุงูุชุจ ุงุณูู."); return; }

    const sessionSnap = await SESS(code).get();
    const s = sessionSnap.val();
    if (!s) { toast("ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ."); return; }
    if (s.status === "locked") { toast("ุงูุฌูุณุฉ ููููุฉ."); return; }

    // create player id for this device
    const playerId = rid();
    me = { sessionCode: code, playerId, name };
    setIdentity(me);

    await SESS(code).child(`players/${playerId}`).set({
      id: playerId,
      name,
      alive: true,
      role: null,   // assigned later
      joinedAt: now(),
      ready: false
    });

    showPlayerAfterJoin();
    subscribePlayer(code, playerId);
  }

  function showPlayerAfterJoin(){
    playerAfterJoin.classList.remove("hidden");
    pName.textContent = me.name;
    pCode.textContent = me.sessionCode;

    // Hide role
    myRoleCard.classList.add("hidden");
    btnHideMyRole.classList.add("hidden");
    btnRevealMyRole.classList.remove("hidden");
  }

  function subscribePlayer(code, playerId){
    if (playerUnsub) playerUnsub.off();
    playerUnsub = SESS(code);
    playerUnsub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      const p = s.players?.[playerId];
      if (!p) return;

      pPhase.textContent = s.phase === "night" ? "ููู ๐" : "ููุงุฑ โ๏ธ";
      pRound.textContent = String(s.round || 1);

      // render action UI depending on phase & role
      renderPlayerActions(s, p);
    });
  }

  function renderPlayerActions(session, player){
    const alivePlayers = Object.values(session.players || {}).filter(x => x.alive);

    // if dead => no actions
    if (!player.alive) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุฃูุช ุฎุงุฑุฌ ุงููุนุจุฉ โ</div>`;
      return;
    }

    // waiting for role assignment
    if (!player.role) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุจุงูุชุธุงุฑ ุชูุฒูุน ุงูุฃุฏูุงุฑ ูู ุงููุฏูุฑโฆ</div>`;
      return;
    }

    // NIGHT: mafia vote only (MVP)
    if (session.phase === "night") {
      if (player.role !== "mafia") {
        pActionBox.innerHTML = `<div class="text-center text-slate-300">ูููโฆ ุงูุชุธุฑ (ุชุตููุช ุงููุงููุง ููุท).</div>`;
        return;
      }

      // Mafia voting UI
      const options = alivePlayers.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
      pActionBox.innerHTML = `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 space-y-2">
          <div class="font-extrabold">ุชุตููุช ุงููุงููุง (ูุชู)</div>
          <select id="mafiaVoteSel"
            class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
            <option value="">ุงุฎุชุฑ ุงูุถุญูุฉ</option>
            ${options}
          </select>
          <button id="btnMafiaVote"
            class="tap w-full px-4 py-4 rounded-2xl bg-rose-600 hover:bg-rose-500 font-extrabold">
            ุฅุฑุณุงู ุงูุชุตููุช
          </button>
          <div class="text-xs text-slate-400">ุชุตููุชู ูุง ูุธูุฑ ูุฃุญุฏ.</div>
        </div>
      `;

      const btn = $("btnMafiaVote");
      btn.addEventListener("click", async () => {
        const victimId = $("mafiaVoteSel").value || "";
        if (!victimId) return toast("ุงุฎุชุฑ ุงูุถุญูุฉ.");
        await SESS(me.sessionCode).child(`votes/night/mafia/${me.playerId}`).set(victimId);
        toast("ุชู ุชุณุฌูู ุชุตููุชู.");
      });
      return;
    }

    // DAY: public vote for all alive
    if (session.phase === "day") {
      const options = alivePlayers.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
      pActionBox.innerHTML = `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 space-y-2">
          <div class="font-extrabold">ุชุตููุช ุงูููุงุฑ (ุฅูุตุงุก)</div>
          <select id="dayVoteSel"
            class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
            <option value="">ุงุฎุชุฑ ุงูุดุฎุต</option>
            ${options}
          </select>
          <button id="btnDayVote"
            class="tap w-full px-4 py-4 rounded-2xl bg-amber-600 hover:bg-amber-500 font-extrabold">
            ุฅุฑุณุงู ุงูุชุตููุช
          </button>
          <div class="text-xs text-slate-400">ูุฐุง ุงูุชุตููุช ูุญุฏุฏ ุงูุฅูุตุงุก ุนูุฏ ุชูููุฐ ุงููุฏูุฑ.</div>
        </div>
      `;

      const btn = $("btnDayVote");
      btn.addEventListener("click", async () => {
        const targetId = $("dayVoteSel").value || "";
        if (!targetId) return toast("ุงุฎุชุฑ ุดุฎุต.");
        await SESS(me.sessionCode).child(`votes/day/public/${me.playerId}`).set(targetId);
        toast("ุชู ุชุณุฌูู ุชุตููุชู.");
      });
      return;
    }
  }

  function revealMyRole(){
    if (!me) return;
    SESS(me.sessionCode).child(`players/${me.playerId}/role`).get().then(snap => {
      const role = snap.val();
      if (!role) return toast("ุจุงูุชุธุงุฑ ุชูุฒูุน ุงูุฃุฏูุงุฑ ูู ุงููุฏูุฑ.");
      myRoleText.textContent = role === "mafia" ? "ูุงููุง" : "ููุงุทู";
      myRoleHint.textContent = ROLE_HINT[role] || "โ";
      myRoleCard.classList.remove("hidden");
      btnRevealMyRole.classList.add("hidden");
      btnHideMyRole.classList.remove("hidden");
    });
  }
  function hideMyRole(){
    myRoleCard.classList.add("hidden");
    btnHideMyRole.classList.add("hidden");
    btnRevealMyRole.classList.remove("hidden");
  }

  // ================== Buttons wiring ==================
  btnGoHost.addEventListener("click", hostCreateSession);
  btnGoPlayer.addEventListener("click", () => setScreen("screenPlayer"));

  btnCopyJoin.addEventListener("click", hostCopyJoinLink);
  btnHostLockAndAssign.addEventListener("click", hostLockAndAssign);
  btnHostTogglePhase.addEventListener("click", hostTogglePhase);
  btnHostResolve.addEventListener("click", hostResolvePhase);

  btnPlayerJoin.addEventListener("click", playerJoin);

  btnRevealMyRole.addEventListener("click", revealMyRole);
  btnHideMyRole.addEventListener("click", hideMyRole);

  $("btnBackMode1").addEventListener("click", () => setScreen("screenMode"));
  $("btnBackMode2").addEventListener("click", () => setScreen("screenMode"));

  btnResetLocal.addEventListener("click", () => {
    clearIdentity();
    toast("ุชู ูุณุญ ุจูุงูุงุช ูุฐุง ุงูุฌูุงุฒ.");
    location.href = location.pathname; // remove query
  });

  // ================== Auto-resume if player already joined ==================
  if (me?.sessionCode && me?.playerId) {
    setScreen("screenPlayer");
    playerAfterJoin.classList.remove("hidden");
    pName.textContent = me.name;
    pCode.textContent = me.sessionCode;
    subscribePlayer(me.sessionCode, me.playerId);
  } else {
    setScreen("screenMode");
  }
})();
</script>
</body>
</html>
