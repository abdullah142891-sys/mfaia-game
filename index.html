<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ูุงููุง โ ูุนุจ ุขูู ุจุฏูู ูุฏูุฑ</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <style>
    body { padding-bottom: env(safe-area-inset-bottom); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }
    .no-spin::-webkit-outer-spin-button,
    .no-spin::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .no-spin { -moz-appearance: textfield; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-40 bg-slate-950/80 glass border-b border-slate-800">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="text-lg font-extrabold">๐ต๏ธโโ๏ธ ูุงููุง</div>
        <div id="badgeMini" class="hidden text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">โ</div>
      </div>
      <div class="flex gap-2">
        <button id="btnHow" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          ููู ุชูุนุจุ
        </button>
        <button id="btnCopyShare" class="hidden tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          ูุดุงุฑูุฉ
        </button>
        <button id="btnLeave" class="hidden tap text-sm px-3 py-2 rounded-xl bg-rose-700/40 hover:bg-rose-700/60 border border-rose-700">
          ุฎุฑูุฌ
        </button>
      </div>
    </div>
  </header>

  <!-- Modal: How to play -->
  <div id="howModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-x-0 bottom-0 max-w-md mx-auto p-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-950 shadow-xl p-5 space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-xl font-extrabold">๐ ููู ุชูุนุจุ</div>
          <button id="btnCloseHow" class="tap px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">ุฅุบูุงู</button>
        </div>
        <div class="text-sm text-slate-300 leading-7">
          <div class="font-bold text-slate-100 mb-1">ุงูููุฑุฉ</div>
          ูู ูุงุนุจ ุนูุฏู ุฏูุฑ ุณุฑู. ุงููุนุจุฉ ุชูุดู ุชููุงุฆููุง: <b>ููู</b> ุซู <b>ููุงุฑ</b> ุจูุคููุช. ูุง ููู ูุฏูุฑ.
          <div class="mt-3 font-bold text-slate-100 mb-1">ุงูููู ๐</div>
          โข ุงููุงููุง ุชุตููุช ููุชู ูุงุนุจ.<br>
          โข ุงูุฃุฏูุงุฑ ุงูููููุฉ (ุฅุฐุง ููุนููุฉ): ุทุจูุจ/ูุญูู/ุญุงุฑุณ/ูุงุชู ูุชุณูุณู/ุณุงุญุฑุฉ ุชุฎุชุงุฑ ูุฑุงุฑุงุชูุง.<br>
          <div class="mt-3 font-bold text-slate-100 mb-1">ุงูููุงุฑ โ๏ธ</div>
          โข ุงูุฌููุน ูุตููุช ูุฅูุตุงุก ูุงุนุจ.<br>
          โข ุงูููุงุต (ุฅุฐุง ููุนูู) ุนูุฏู ุทููุฉ ูุงุญุฏุฉ ุทูุงู ุงููุนุจุฉ (ุจุงูููุงุฑ).<br>
          โข ุงูุนูุฏุฉ (ุฅุฐุง ููุนูู) ุตูุชู ูุญุณูุจ <b>ูุฑุชูู</b> ุจุฏูู ูุง ูุนุฑู ุฃุญุฏ.
          <div class="mt-3 text-xs text-slate-400">
            ุงููุธุงู ููููุฐ ุงููุชุงุฆุฌ ุนูุฏ ุงูุชูุงู ุงูุชุตููุช ุงููุทููุจ ุฃู ุงูุชูุงุก ุงูููุช.
          </div>
        </div>
      </div>
    </div>
  </div>

  <main class="max-w-md mx-auto px-4 py-5 space-y-4">

    <!-- Screen: Mode -->
    <section id="screenMode" class="space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 shadow">
        <h1 class="text-2xl font-extrabold">ูุงููุง โ ุจุฏูู ูุฏูุฑ</h1>
        <p class="text-slate-300 text-sm mt-2 leading-6">
          โข ุฃูู ุดุฎุต ููุดุฆ ุงูุฌูุณุฉ ูุฏุฎู ููุงุนุจ ููุถุจุท ุงูุฅุนุฏุงุฏุงุช ุซู ูุถุบุท <b>ุงุจุฏุฃ ุงููุนุจุฉ</b>.<br>
          โข ุจุนุฏ ุงูุจุฏุก: <b>ุงููุฑุงุญู + ุงููุคูุช + ุชูููุฐ ุงููุชุงุฆุฌ</b> ูููุง ุชุชู ุชููุงุฆููุง.
        </p>
      </div>

      <button id="btnGoCreate" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
        ุฅูุดุงุก ุฌูุณุฉ (ูุฃูุง ูุงุนุจ)
      </button>

      <button id="btnGoJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
        ุฏุฎูู ุฌูุณุฉ
      </button>

      <div class="text-xs text-slate-400 text-center">
        ุชูุฏุฑ ุชุฑุณู โุฑุงุจุท ุงูุฏุฎููโ ุจุฏู ุงูููุฏ.
      </div>
    </section>

    <!-- Screen: Create -->
    <section id="screenCreate" class="hidden space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">ุฅูุดุงุก ุฌูุณุฉ</h2>

        <label class="text-sm text-slate-300">ุงุณูู</label>
        <input id="createName" placeholder="ูุซุงู: ุนุจุฏุงููู"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <div class="grid grid-cols-2 gap-2 mt-2">
          <div>
            <label class="text-sm text-slate-300">ูุฏุฉ ุงููุฑุญูุฉ (ุซุงููุฉ)</label>
            <input id="cfgSeconds" type="number" min="15" value="120"
              class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
          </div>
          <div>
            <label class="text-sm text-slate-300">ุญู ุงูุชุนุงุฏู</label>
            <select id="cfgTieMode"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
              <option value="revote">ุฅุนุงุฏุฉ ุงูุชุตููุช</option>
              <option value="random">ุงุฎุชูุงุฑ ุนุดูุงุฆู</option>
            </select>
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-300">ุนุฏุฏ ุงููุงููุง</label>
          <input id="cfgMafia" type="number" min="1" value="1"
            class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">ุงูุฃุฏูุงุฑ (ุชูุนูู/ุฅูุบุงุก + ุนุฏุฏ)</div>
            <div class="text-xs text-slate-400">ุงูุจุงูู โููุงุทูโ</div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <!-- sniper -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ฏ ููุงุต</span>
                <input id="roleSniperOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleSniperCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <!-- jester -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐คก ููุฑูุฌ</span>
                <input id="roleJesterOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleJesterCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <!-- doctor -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ฉบ ุทุจูุจ</span>
                <input id="roleDoctorOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleDoctorCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <!-- detective -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ ูุญูู</span>
                <input id="roleDetectiveOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleDetectiveCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <!-- bodyguard -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ก๏ธ ุญุงุฑุณ</span>
                <input id="roleBodyguardOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleBodyguardCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <!-- serial -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ช ูุงุชู ูุชุณูุณู</span>
                <input id="roleSerialOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleSerialCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <!-- witch (role 3) -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐งช ุณุงุญุฑุฉ</span>
                <input id="roleWitchOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleWitchCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>

            <!-- mayor (role 4) -->
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ ุนูุฏุฉ</span>
                <input id="roleMayorOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleMayorCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>
          </div>

          <div class="text-xs text-slate-400 leading-6">
            โข ุงูุทุจูุจ: ูุฎุชุงุฑ ุดุฎุตูุง ูุฅููุงุฐู (ููู).<br>
            โข ุงููุญูู: ูุญูู ููุธูุฑ ูู ููุท โูุงููุง/ููุณ ูุงููุงโ (ููู).<br>
            โข ุงูุญุงุฑุณ: ูุญูู ุดุฎุตูุงุ ุฅุฐุง ูุงุฌูุช ุงููุงููุง ูุฏูู ูููุช ุงูุญุงุฑุณ ุจุฏููุง ุนูู (ููู).<br>
            โข ุงููุงุชู ุงููุชุณูุณู: ููุชู ุดุฎุตูุง (ููู) ููู ุทุฑู ูุณุชูู (ูููุฒ ุฅุฐุง ุจูู ููุญุฏู).<br>
            โข ุงูุณุงุญุฑุฉ: ุนูุฏูุง ุฅููุงุฐ <b>ูุฑุฉ</b> ูุณู <b>ูุฑุฉ</b> ุทูุงู ุงููุนุจุฉ (ููู).<br>
            โข ุงูุนูุฏุฉ: ุตูุชู ุจุงูููุงุฑ ูุญุณูุจ <b>ูุฑุชูู</b> (ุจุฏูู ูุง ูุนุฑู ุฃุญุฏ).
          </div>
        </div>

        <button id="btnCreateSession" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          ุฅูุดุงุก ุงูุฌูุณุฉ
        </button>

        <button id="btnBackFromCreate" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          ุฑุฌูุน
        </button>
      </div>
    </section>

    <!-- Screen: Player -->
    <section id="screenPlayer" class="hidden space-y-4">
      <div id="joinBox" class="hidden rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">ุฏุฎูู ุฌูุณุฉ</h2>

        <label class="text-sm text-slate-300">ููุฏ ุงูุฌูุณุฉ</label>
        <input id="playerCode" placeholder="ูุซุงู: 482913"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <label class="text-sm text-slate-300">ุงุณูู</label>
        <input id="playerName" placeholder="ูุซุงู: ุนุจุฏุงููู"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <button id="btnPlayerJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
          ุฏุฎูู
        </button>

        <button id="btnBackFromJoin" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          ุฑุฌูุน
        </button>

        <div class="text-xs text-slate-400">ููุงุญุธุฉ: ูุง ูููู ุชูุฑุงุฑ ููุณ ุงูุงุณู ุฏุงุฎู ุงูุฌูุณุฉ.</div>
      </div>

      <div id="playerBox" class="hidden space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xs text-slate-300">ุงูุฌูุณุฉ</div>
              <div class="text-2xl font-extrabold mt-1">
                <span id="pName">โ</span> ยท <span class="tracking-widest" id="pCode">โ</span>
              </div>
              <div id="lobbyHint" class="text-sm text-slate-300 mt-2 leading-6">โ</div>
            </div>
            <div class="text-left">
              <div class="text-xs text-slate-300">ุงูููุช ุงููุชุจูู</div>
              <div id="phaseLeft" class="text-2xl font-extrabold mt-1">โ</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
              <div class="text-xs text-slate-300">ุงููุฑุญูุฉ</div>
              <div id="pPhase" class="text-2xl font-extrabold mt-1">โ</div>
            </div>
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 text-right">
              <div class="text-xs text-slate-300">ุงูุฌููุฉ</div>
              <div id="pRound" class="text-2xl font-extrabold mt-1">โ</div>
            </div>
          </div>

          <div id="winnerBanner" class="hidden rounded-2xl border border-amber-700 bg-amber-900/20 p-3">
            <div class="font-extrabold" id="winnerText">โ</div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">ุงูููุฎุต</div>
            <div id="publicLog" class="mt-1 text-slate-300 text-sm leading-6">โ</div>
          </div>
        </div>

        <div id="lobbyBox" class="hidden rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ุงููุงุนุจูู</div>
            <div class="text-xs text-slate-400"><span id="playerCount">โ</span></div>
          </div>
          <div id="playersList" class="space-y-2"></div>

          <button id="btnStartGame" class="hidden tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
            ุงุจุฏุฃ ุงููุนุจุฉ
          </button>

          <div class="text-xs text-slate-400 leading-6">
            ุงูุดุฑุท: 5 ูุงุนุจูู ุฃู ุฃูุซุฑ. ุจุนุฏ ุงูุจุฏุก ูู ุดูุก ูุตูุฑ ุขูู.
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ุฏูุฑู</div>
            <button id="btnToggleRole" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
              ุฅุธูุงุฑ/ุฅุฎูุงุก
            </button>
          </div>

          <div id="myRoleCard" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
            <div id="myRoleText" class="text-3xl font-extrabold">โ</div>
            <div id="myRoleHint" class="text-sm text-slate-300 mt-2 leading-6">โ</div>
            <div id="roleExtraBox" class="mt-3 hidden rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <div class="text-xs text-slate-300">ูุนูููุฉ ุฎุงุตุฉ</div>
              <div id="roleExtraText" class="mt-1 font-bold">โ</div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">ุญุงูุฉ ุฅุฌุฑุงุกู</div>
            <div id="myVoteStatus" class="text-sm text-slate-300 mt-1">โ</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ุงูุฅุฌุฑุงุก</div>
            <div class="text-xs text-slate-400">๐ <span id="liveTally">โ</span></div>
          </div>
          <div id="pActionBox" class="mt-3 space-y-3"></div>
        </div>
      </div>
    </section>
  </main>

<script>
(() => {
  // Firebase config (ูู ุนูุฏู)
  const firebaseConfig = {
    apiKey: "AIzaSyC4YdqgiAfJmRmvkLH4wspzclAzKs3wyLw",
    authDomain: "mafia-game-7e488.firebaseapp.com",
    databaseURL: "https://mafia-game-7e488-default-rtdb.firebaseio.com",
    projectId: "mafia-game-7e488",
    storageBucket: "mafia-game-7e488.firebasestorage.app",
    messagingSenderId: "513186840934",
    appId: "1:513186840934:web:ccf858b27cea91be1448a7"
  };

  const $ = (id) => document.getElementById(id);
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Helpers
  const rid = () => (crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint32Array(2))].map(x=>x.toString(16)).join("") : String(Math.random()).slice(2));
  const now = () => Date.now();
  const code6 = () => String(Math.floor(100000 + Math.random() * 900000));
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const shuffle = (arr) => { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
  const normName = (s) => String(s || "").trim().replace(/\s+/g, " ").toLowerCase();
  const clampInt = (x, lo, hi) => Math.max(lo, Math.min(hi, Number(x || 0)));

  function fmtLeft(ms){
    const s = Math.max(0, Math.ceil(ms / 1000));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return m > 0 ? `${m}:${String(r).padStart(2,"0")}` : `${r}s`;
  }

  function getTopCandidatesWeighted(votesByPid, playersObj, weightFn){
    const tally = {};
    for (const [voterPid, targetId] of Object.entries(votesByPid || {})) {
      if (!targetId) continue;
      const w = weightFn(voterPid, playersObj);
      tally[targetId] = (tally[targetId] || 0) + w;
    }
    const entries = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
    if (!entries.length) return { max: 0, candidates: [] };
    const max = entries[0][1];
    const candidates = entries.filter(([,c]) => c === max).map(([id]) => id);
    return { max, candidates, totalWeight: Object.values(tally).reduce((a,b)=>a+b,0) };
  }

  function tallyTextWeighted(votesByPid, playersObj, weightFn){
    const seen = Object.keys(votesByPid || {}).length;
    if (seen === 0) return "ูุง ุชูุฌุฏ ุฃุตูุงุช ุจุนุฏ.";
    const top = getTopCandidatesWeighted(votesByPid || {}, playersObj, weightFn);
    return `ุชู ุชุณุฌูู ${seen} ุตูุช. ุฃุนูู ุฎูุงุฑ ุนููู ${top.max} (ูุฒู).`;
  }

  // Identity storage
  const LS_KEY = "mafia_identity_auto_v2";
  const getMe = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; } };
  const setMe = (o) => localStorage.setItem(LS_KEY, JSON.stringify(o));
  const clearMe = () => localStorage.removeItem(LS_KEY);

  const SESS = (code) => db.ref(`sessions/${code}`);

  // UI refs
  const badgeMini = $("badgeMini");
  const btnCopyShare = $("btnCopyShare");
  const btnLeave = $("btnLeave");
  const btnHow = $("btnHow");
  const howModal = $("howModal");
  const btnCloseHow = $("btnCloseHow");

  const screenMode = $("screenMode");
  const screenCreate = $("screenCreate");
  const screenPlayer = $("screenPlayer");

  const btnGoCreate = $("btnGoCreate");
  const btnGoJoin = $("btnGoJoin");

  // Create form
  const createName = $("createName");
  const cfgSeconds = $("cfgSeconds");
  const cfgTieMode = $("cfgTieMode");
  const cfgMafia = $("cfgMafia");

  const roleSniperOn = $("roleSniperOn");
  const roleJesterOn = $("roleJesterOn");
  const roleDoctorOn = $("roleDoctorOn");
  const roleDetectiveOn = $("roleDetectiveOn");
  const roleBodyguardOn = $("roleBodyguardOn");
  const roleSerialOn = $("roleSerialOn");
  const roleWitchOn = $("roleWitchOn");
  const roleMayorOn = $("roleMayorOn");

  const roleSniperCount = $("roleSniperCount");
  const roleJesterCount = $("roleJesterCount");
  const roleDoctorCount = $("roleDoctorCount");
  const roleDetectiveCount = $("roleDetectiveCount");
  const roleBodyguardCount = $("roleBodyguardCount");
  const roleSerialCount = $("roleSerialCount");
  const roleWitchCount = $("roleWitchCount");
  const roleMayorCount = $("roleMayorCount");

  const btnCreateSession = $("btnCreateSession");
  const btnBackFromCreate = $("btnBackFromCreate");

  // Join form
  const joinBox = $("joinBox");
  const playerCode = $("playerCode");
  const playerName = $("playerName");
  const btnPlayerJoin = $("btnPlayerJoin");
  const btnBackFromJoin = $("btnBackFromJoin");

  // Player UI
  const playerBox = $("playerBox");
  const pName = $("pName");
  const pCode = $("pCode");
  const pPhase = $("pPhase");
  const pRound = $("pRound");
  const phaseLeft = $("phaseLeft");
  const lobbyHint = $("lobbyHint");
  const publicLog = $("publicLog");

  const winnerBanner = $("winnerBanner");
  const winnerText = $("winnerText");

  const lobbyBox = $("lobbyBox");
  const playerCount = $("playerCount");
  const playersList = $("playersList");
  const btnStartGame = $("btnStartGame");

  const btnToggleRole = $("btnToggleRole");
  const myRoleCard = $("myRoleCard");
  const myRoleText = $("myRoleText");
  const myRoleHint = $("myRoleHint");
  const roleExtraBox = $("roleExtraBox");
  const roleExtraText = $("roleExtraText");
  const myVoteStatus = $("myVoteStatus");
  const liveTally = $("liveTally");
  const pActionBox = $("pActionBox");

  const ROLE_UI = {
    mafia: { name:"ูุงููุง", hint:"ุจุงูููู: ุตููุช ููุชู ูุงุนุจ. ุจุงูููุงุฑ: ุญุงูู ูุง ุชููุดู." },
    citizen: { name:"ููุงุทู", hint:"ุจุงูููุงุฑ: ุตููุช ุตุญ. ุจุงูููู: ุงูุชุธุฑ." },
    sniper: { name:"ููุงุต", hint:"๐ฏ ุทููุฉ ูุงุญุฏุฉ ุทูุงู ุงููุนุจุฉ (ุจุงูููุงุฑ). ุงุฎุชูุงุฑู ุณุฑู." },
    jester: { name:"ููุฑูุฌ", hint:"๐คก ูุฏูู ูุชู ุฅูุตุงุคู ุจุงูุชุตููุช ูู ุงูููุงุฑ ูุชููุฒ ูุญุฏู ููุฑูุง." },
    doctor: { name:"ุทุจูุจ", hint:"๐ฉบ ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ูุฅููุงุฐู ูู ุงููุชู." },
    detective: { name:"ูุญูู", hint:"๐ ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ููุชุญููู (ูุธูุฑ ูู: ูุงููุง/ููุณ ูุงููุง)." },
    bodyguard: { name:"ุญุงุฑุณ", hint:"๐ก๏ธ ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ูุชุญููู. ุฅุฐุง ูุงุฌูุชู ุงููุงููุง ูุฏูู ุชููุช ุฃูุช ุจุฏููุง ุนูู." },
    serial: { name:"ูุงุชู ูุชุณูุณู", hint:"๐ช ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ููุชูู. ูุฏูู ุชุจูู ุขุฎุฑ ุดุฎุต ุญู." },
    witch: { name:"ุณุงุญุฑุฉ", hint:"๐งช ุจุงูููู: ุนูุฏู ุฅููุงุฐ ูุฑุฉ ูุณู ูุฑุฉ ุทูุงู ุงููุนุจุฉ." },
    mayor: { name:"ุนูุฏุฉ", hint:"๐ ุจุงูููุงุฑ: ุตูุชู ูุญุณูุจ ูุฑุชูู (ุณุฑู)." },
  };

  // State
  let me = getMe(); // {code,pid,name,isCreator}
  let sub = null;

  // Render guards (fix issue 1)
  let lastRenderKey = "";
  let lastActionKey = "";

  // Engine heartbeat (reduce UI churn)
  let engineTimer = null;
  let lockExpiresAtLocal = 0;

  function setScreen(which){
    screenMode.classList.add("hidden");
    screenCreate.classList.add("hidden");
    screenPlayer.classList.add("hidden");
    joinBox.classList.add("hidden");
    playerBox.classList.add("hidden");
    btnCopyShare.classList.add("hidden");
    btnLeave.classList.add("hidden");
    badgeMini.classList.add("hidden");

    if (which === "mode") screenMode.classList.remove("hidden");
    if (which === "create") screenCreate.classList.remove("hidden");
    if (which === "join") { screenPlayer.classList.remove("hidden"); joinBox.classList.remove("hidden"); }
    if (which === "player") {
      screenPlayer.classList.remove("hidden");
      playerBox.classList.remove("hidden");
      btnCopyShare.classList.remove("hidden");
      btnLeave.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = me?.isCreator ? "ูููุดุฆ" : "ูุงุนุจ";
    }
  }

  function shareLink(code){
    const url = `${location.origin}${location.pathname}?code=${code}`;
    navigator.clipboard?.writeText(url);
    alert("ุชู ูุณุฎ ุฑุงุจุท ุงูุฏุฎูู.");
  }

  // URL join ?code=
  const urlParams = new URLSearchParams(location.search);
  const preCode = urlParams.get("code");
  if (preCode && !me) {
    setScreen("join");
    playerCode.value = preCode;
  }

  function readRolesFromUI(){
    const mk = (onEl, cntEl) => ({ on: !!onEl?.checked, count: clampInt(cntEl?.value, 0, 20) });
    return {
      sniper: mk(roleSniperOn, roleSniperCount),
      jester: mk(roleJesterOn, roleJesterCount),
      doctor: mk(roleDoctorOn, roleDoctorCount),
      detective: mk(roleDetectiveOn, roleDetectiveCount),
      bodyguard: mk(roleBodyguardOn, roleBodyguardCount),
      serial: mk(roleSerialOn, roleSerialCount),
      witch: mk(roleWitchOn, roleWitchCount),
      mayor: mk(roleMayorOn, roleMayorCount),
    };
  }

  async function createSessionAsPlayer(){
    const name = String(createName.value || "").trim();
    if (!name) return alert("ุงูุชุจ ุงุณูู.");

    const seconds = clampInt(cfgSeconds.value, 15, 3600);
    const tieMode = String(cfgTieMode.value || "revote");
    const mafiaCount = Math.max(1, Number(cfgMafia.value || 1));
    const rolesCfg = readRolesFromUI();

    const code = code6();
    const pid = rid();

    await SESS(code).set({
      code,
      createdAt: now(),
      status: "lobby",
      phase: "lobby",
      round: 0,
      phaseEndAt: 0,
      creatorPid: pid,
      config: {
        phaseSeconds: seconds,
        tieMode,
        mafiaCount,
        roles: rolesCfg,
        sniperUsedBy: {},
        witchUsedBy: {}
      },
      winner: "",
      log: "ุชู ุฅูุดุงุก ุงูุฌูุณุฉ. ุจุงูุชุธุงุฑ ุงููุงุนุจููโฆ",
      votes: {
        night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} },
        day: { public:{} },
        dayExtra: { sniper:{} }
      },
      private: { detectiveResults:{} },
      engine: { lock: { holder:"", expiresAt: 0 }, lastResolveAt: 0 }
    });

    await SESS(code).child(`players/${pid}`).set({ id: pid, name, alive:true, role:"", joinedAt: now(), left:false });

    // onDisconnect: ูุจู ุจุฏุก ุงููุนุจุฉ ุงูุฃูุถู ุฅุฒุงูุฉ ุงููุงุนุจ ูู ุงูููุจู
    SESS(code).child(`players/${pid}`).onDisconnect().update({ left:true, alive:false, leftAt: now() });

    me = { code, pid, name, isCreator:true };
    setMe(me);

    setScreen("player");
    pName.textContent = name;
    pCode.textContent = code;
    subscribe(code, pid);
  }

  async function joinSession(){
    const code = String(playerCode.value || "").trim();
    const name = String(playerName.value || "").trim();
    if (!/^\d{6}$/.test(code)) return alert("ุงูุชุจ ููุฏ ุตุญูุญ (6 ุฃุฑูุงู).");
    if (!name) return alert("ุงูุชุจ ุงุณูู.");

    const snap = await SESS(code).get();
    const s = snap.val();
    if (!s) return alert("ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ.");

    const wanted = normName(name);
    const existing = Object.values(s.players || {}).some(p => normName(p.name) === wanted && !p.left);
    if (existing) return alert("ูุฐุง ุงูุงุณู ูุณุชุฎุฏู ุฏุงุฎู ุงูุฌูุณุฉ. ุงุฎุชุฑ ุงุณููุง ุขุฎุฑ.");

    const pid = rid();
    await SESS(code).child(`players/${pid}`).set({ id: pid, name, alive:true, role:"", joinedAt: now(), left:false });

    // onDisconnect: ุฅุฐุง ููู ุงูุตูุญุฉ
    SESS(code).child(`players/${pid}`).onDisconnect().update({ left:true, alive:false, leftAt: now() });

    me = { code, pid, name, isCreator:false };
    setMe(me);

    setScreen("player");
    pName.textContent = name;
    pCode.textContent = code;
    subscribe(code, pid);
  }

  async function leaveSession(){
    if (!me?.code || !me?.pid) { clearMe(); location.href = location.pathname; return; }
    try {
      await SESS(me.code).child(`players/${me.pid}`).update({ left:true, alive:false, leftAt: now() });
    } catch {}
    clearMe();
    location.href = location.pathname;
  }

  function computeWinner(players){
    const alive = players.filter(p => p.alive && !p.left);
    if (alive.length === 0) return "";
    const mafiaAlive = alive.filter(p => p.role === "mafia").length;
    const serialAlive = alive.filter(p => p.role === "serial").length;
    if (alive.length === 1 && alive[0].role === "serial") return "serial";
    if (mafiaAlive === 0 && serialAlive === 0) return "citizens";
    if (mafiaAlive > 0 && mafiaAlive >= (alive.length - mafiaAlive)) return "mafia";
    return "";
  }

  function buildAliveOptions(playersObj, excludeId, allowSelf){
    const alive = Object.values(playersObj || {}).filter(p => p.alive && !p.left && (allowSelf || p.id !== excludeId));
    return alive.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
  }

  // -------- Engine (auto) --------
  async function tryAcquireLock(code, pid){
    const lockRef = SESS(code).child("engine/lock");
    const leaseMs = 12000;

    const res = await lockRef.transaction((cur) => {
      const c = cur || { holder:"", expiresAt:0 };
      if (!c.holder || (c.expiresAt || 0) < now() || c.holder === pid) {
        return { holder: pid, expiresAt: now() + leaseMs };
      }
      return;
    });
    if (res.committed) lockExpiresAtLocal = res.snapshot.val()?.expiresAt || (now()+leaseMs);
    return !!res.committed;
  }

  async function maybeRenewLock(code, pid){
    // renew only when close to expiry (avoid constant session updates)
    if (!lockExpiresAtLocal || lockExpiresAtLocal - now() > 3500) return;
    const lockRef = SESS(code).child("engine/lock");
    const leaseMs = 12000;
    const res = await lockRef.transaction((cur) => {
      const c = cur || { holder:"", expiresAt:0 };
      if (c.holder === pid) return { holder: pid, expiresAt: now() + leaseMs };
      return;
    });
    if (res.committed) lockExpiresAtLocal = res.snapshot.val()?.expiresAt || (now()+leaseMs);
  }

  function aliveRoleCount(players, role){
    return players.filter(p => p.alive && !p.left && p.role === role).length;
  }

  async function engineStep(code, pid){
    const acquired = await tryAcquireLock(code, pid);
    if (!acquired) return;

    try {
      const snap = await SESS(code).get();
      const s = snap.val();
      if (!s || s.winner) return;
      if (s.status !== "playing") return;

      const phase = s.phase;
      const phaseEndAt = Number(s.phaseEndAt || 0);
      const playersObj = s.players || {};
      const players = Object.values(playersObj);
      const alive = players.filter(p => p.alive && !p.left);

      let ready = false;

      if (phase === "night") {
        const required = [];
        if (aliveRoleCount(alive, "mafia") > 0) required.push(["votes/night/mafia", "mafia"]);
        if (aliveRoleCount(alive, "doctor") > 0) required.push(["votes/night/doctor", "doctor"]);
        if (aliveRoleCount(alive, "detective") > 0) required.push(["votes/night/detective", "detective"]);
        if (aliveRoleCount(alive, "bodyguard") > 0) required.push(["votes/night/bodyguard", "bodyguard"]);
        if (aliveRoleCount(alive, "serial") > 0) required.push(["votes/night/serial", "serial"]);
        if (aliveRoleCount(alive, "witch") > 0) required.push(["votes/night/witchSave", "witch"]); // save optional but we count as action if present (see below)

        // If time ended, resolve regardless.
        if (now() >= phaseEndAt) ready = true;
        else {
          // require each alive role to have action OR allow "no action" by voting empty? We'll treat missing vote as not ready.
          let allDone = true;

          // Mafia must vote
          const aliveMafia = alive.filter(p => p.role === "mafia").map(p => p.id);
          const mv = s.votes?.night?.mafia || {};
          if (aliveMafia.some(id => !mv[id])) allDone = false;

          // Doctor (optional): must choose or explicitly skip by setting "skip"
          const docAlive = alive.filter(p => p.role === "doctor").map(p => p.id);
          const dv = s.votes?.night?.doctor || {};
          if (docAlive.some(id => !dv[id])) allDone = false;

          // Detective
          const detAlive = alive.filter(p => p.role === "detective").map(p => p.id);
          const detv = s.votes?.night?.detective || {};
          if (detAlive.some(id => !detv[id])) allDone = false;

          // Bodyguard
          const bgAlive = alive.filter(p => p.role === "bodyguard").map(p => p.id);
          const bgv = s.votes?.night?.bodyguard || {};
          if (bgAlive.some(id => !bgv[id])) allDone = false;

          // Serial
          const skAlive = alive.filter(p => p.role === "serial").map(p => p.id);
          const skv = s.votes?.night?.serial || {};
          if (skAlive.some(id => !skv[id])) allDone = false;

          // Witch: she can do nothing; we allow "skip" vote key
          const wiAlive = alive.filter(p => p.role === "witch").map(p => p.id);
          const wsv = s.votes?.night?.witchSave || {};
          const wpv = s.votes?.night?.witchPoison || {};
          if (wiAlive.some(id => (!wsv[id] && !wpv[id] && !((wsv[id] === "skip") || (wpv[id] === "skip"))))) {
            // they didn't choose anything; still allow to be not ready
            allDone = false;
          }

          ready = allDone;
        }
      }

      if (phase === "day") {
        if (now() >= phaseEndAt) ready = true;
        else {
          const aliveIds = alive.map(p => p.id);
          const dv = s.votes?.day?.public || {};
          ready = aliveIds.every(id => !!dv[id]);
        }
      }

      if (!ready) return;

      // Resolve idempotency
      const lastResolveAt = Number(s.engine?.lastResolveAt || 0);
      if (now() - lastResolveAt < 1500) return;
      await SESS(code).child("engine/lastResolveAt").set(now());

      const tieMode = String(s.config?.tieMode || "revote");
      const seconds = clampInt(s.config?.phaseSeconds, 15, 3600);
      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

      async function tieRevote(path, msg){
        if (tieMode === "revote") {
          const upd = {};
          upd[path] = {};
          upd["log"] = msg + " ุชูุช ุฅุนุงุฏุฉ ุงูุชุตููุช.";
          upd["phaseEndAt"] = now() + seconds*1000;
          await SESS(code).update(upd);
          return { stop:true };
        }
        return { stop:false };
      }

      const aliveObj = Object.fromEntries(alive.map(p => [p.id, p]));

      if (phase === "night") {
        const events = [];

        // Mafia target (weighted by 1 each)
        const mafiaVotes = s.votes?.night?.mafia || {};
        let mafiaVictimId = "";
        const mafiaTop = getTopCandidatesWeighted(mafiaVotes, playersObj, () => 1);
        if (mafiaTop.candidates.length === 1) mafiaVictimId = mafiaTop.candidates[0];
        else if (mafiaTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/mafia", `ุชุนุงุฏู ูู ุชุตููุช ุงููุงููุง (${mafiaTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          mafiaVictimId = (tieMode === "random") ? pick(mafiaTop.candidates) : pick(mafiaTop.candidates);
        }

        // Doctor save
        const docVotes = s.votes?.night?.doctor || {};
        let doctorSaveId = "";
        const docTop = getTopCandidatesWeighted(docVotes, playersObj, () => 1);
        if (docTop.candidates.length === 1) doctorSaveId = docTop.candidates[0] || "";
        else if (docTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/doctor", `ุชุนุงุฏู ูู ุชุตููุช ุงูุทุจูุจ (${docTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          doctorSaveId = pick(docTop.candidates);
        }

        // Witch save/poison (once each)
        const wsv = s.votes?.night?.witchSave || {};
        const wpv = s.votes?.night?.witchPoison || {};
        let witchSaveId = "";
        let witchPoisonId = "";

        for (const [wid, target] of Object.entries(wsv)) {
          if (target === "skip") continue;
          const used = s.config?.witchUsedBy?.[wid] || {};
          if (used.saveUsed) continue;
          if (target) { witchSaveId = target; await SESS(code).child(`config/witchUsedBy/${wid}/saveUsed`).set(true); }
        }
        for (const [wid, target] of Object.entries(wpv)) {
          if (target === "skip") continue;
          const used = s.config?.witchUsedBy?.[wid] || {};
          if (used.poisonUsed) continue;
          if (target) { witchPoisonId = target; await SESS(code).child(`config/witchUsedBy/${wid}/poisonUsed`).set(true); }
        }

        const savedId = doctorSaveId || witchSaveId || "";

        // Bodyguard protect
        const bgVotes = s.votes?.night?.bodyguard || {};
        let protectedId = "";
        const bgTop = getTopCandidatesWeighted(bgVotes, playersObj, () => 1);
        if (bgTop.candidates.length === 1) protectedId = bgTop.candidates[0] || "";
        else if (bgTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/bodyguard", `ุชุนุงุฏู ูู ุชุตููุช ุงูุญุงุฑุณ (${bgTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          protectedId = pick(bgTop.candidates);
        }

        // Serial kill
        const skVotes = s.votes?.night?.serial || {};
        let skVictimId = "";
        const skTop = getTopCandidatesWeighted(skVotes, playersObj, () => 1);
        if (skTop.candidates.length === 1) skVictimId = skTop.candidates[0] || "";
        else if (skTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/serial", `ุชุนุงุฏู ูู ุชุตููุช ุงููุงุชู ุงููุชุณูุณู (${skTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          skVictimId = pick(skTop.candidates);
        }

        // Detective results (private)
        const detVotes = s.votes?.night?.detective || {};
        for (const [detPid, targetId] of Object.entries(detVotes || {})) {
          const t = playersObj[targetId];
          const res = t ? (t.role === "mafia" ? "๐ฅ ุงููุชูุฌุฉ: ูุงููุง" : "๐ฉ ุงููุชูุฌุฉ: ููุณ ูุงููุง") : "ุงููุฏู ุบูุฑ ููุฌูุฏ";
          await SESS(code).child(`private/detectiveResults/${detPid}`).set(res);
        }

        // Apply mafia attack
        const applyAttack = async (victimId, label) => {
          if (!victimId || !aliveObj[victimId]) return;
          const victimName = aliveObj[victimId].name;

          if (victimId === savedId) { events.push(`๐ฉบ ุชู ุฅููุงุฐ ูุงุนุจ`); return; }

          if (victimId === protectedId) {
            const bgAliveOne = alive.find(p => p.role === "bodyguard" && p.alive && !p.left);
            if (bgAliveOne) {
              await SESS(code).child(`players/${bgAliveOne.id}/alive`).set(false);
              events.push(`๐ก๏ธ ุงูุญุงุฑุณ ุถุญูู ุจููุณู`);
              return;
            }
          }
          await SESS(code).child(`players/${victimId}/alive`).set(false);
          events.push(label);
        };

        await applyAttack(mafiaVictimId, "๐ ุชู ูุชู ูุงุนุจ (ูุฌูู ุงููุงููุง)");
        await applyAttack(skVictimId, "๐ช ุชู ูุชู ูุงุนุจ (ูุฌูู ุงููุงุชู ุงููุชุณูุณู)");
        await applyAttack(witchPoisonId, "๐งช ุชู ุชุณููู ูุงุนุจ (ุงูุณุงุญุฑุฉ)");

        await SESS(code).child("log").set(events.length ? events.join(" | ") : "๐ ูู ูุญุฏุซ ุดูุก ูุฐู ุงููููุฉ.");

        // next => day
        await SESS(code).update({
          phase: "day",
          phaseEndAt: now() + seconds*1000,
          votes: { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} }, day: { public:{} }, dayExtra: { sniper:{} } }
        });

      } else if (phase === "day") {
        const events = [];

        const dayVotes = s.votes?.day?.public || {};
        const weightFn = (voterPid, playersObj) => {
          const p = playersObj[voterPid];
          if (p?.role === "mayor" && p.alive && !p.left) return 2;
          return 1;
        };
        const top = getTopCandidatesWeighted(dayVotes, playersObj, weightFn);

        if (!top.candidates.length) {
          events.push("โ๏ธ ูู ูุตููุช ุฃุญุฏ.");
        } else {
          let outId = top.candidates[0];
          if (top.candidates.length > 1) {
            const r = await tieRevote("votes/day/public", `ุชุนุงุฏู ูู ุชุตููุช ุงูููุงุฑ (${top.candidates.length} ุฎูุงุฑุงุช).`);
            if (r.stop) return;
            outId = pick(top.candidates);
          }
          const out = aliveObj[outId];
          if (out) {
            await SESS(code).child(`players/${outId}/alive`).set(false);
            if (out.role === "jester") {
              await SESS(code).update({ winner:"jester", log:"๐คก๐ ูุงุฒ ุงูููุฑูุฌ ูุญุฏู! (ุชู ุฅูุตุงุคู ุจุงูุชุตููุช)" });
              return;
            }
            events.push("โ๏ธ ุชู ุฅูุตุงุก ูุงุนุจ ุจุงูุชุตููุช");
          }
        }

        // Sniper (one shot)
        const sniperVotes = s.votes?.dayExtra?.sniper || {};
        for (const [snPid, targetId] of Object.entries(sniperVotes || {})) {
          const usedBy = s.config?.sniperUsedBy || {};
          if (usedBy[snPid]) continue;
          if (playersObj[snPid]?.role !== "sniper") continue;
          if (playersObj[targetId]?.alive && !playersObj[targetId]?.left) {
            await SESS(code).child(`players/${targetId}/alive`).set(false);
            await SESS(code).child(`config/sniperUsedBy/${snPid}`).set(true);
            events.push("๐ฏ ุงูููุงุต ูููุฐ ูุชููุง");
          }
        }

        await SESS(code).child("log").set(events.join(" | ") || "โ๏ธ ุงูุชูู ุงูููุงุฑ.");

        // next => night
        await SESS(code).update({
          phase: "night",
          round: Number(s.round || 0) + 1,
          phaseEndAt: now() + seconds*1000,
          votes: { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} }, day: { public:{} }, dayExtra: { sniper:{} } }
        });
      }

      // Winner check
      const after = (await SESS(code).get()).val();
      const w = computeWinner(Object.values(after.players || {}));
      if (w) {
        await SESS(code).update({
          winner: w,
          log: w === "serial" ? "๐ ูุงุฒ ุงููุงุชู ุงููุชุณูุณู!" : (w === "mafia" ? "๐ ูุงุฒุช ุงููุงููุง!" : "๐ ูุงุฒ ุงูููุงุทููู!")
        });
      }

    } finally {
      await maybeRenewLock(code, pid).catch(()=>{});
    }
  }

  function startEngine(code, pid){
    if (engineTimer) clearInterval(engineTimer);
    engineTimer = setInterval(() => engineStep(code, pid).catch(()=>{}), 2000);
  }

  // -------- Start Game --------
  async function startGameIfCreator(){
    if (!me?.code || !me?.pid) return;

    const snap = await SESS(me.code).get();
    const s = snap.val();
    if (!s) return alert("ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ.");
    if (s.creatorPid !== me.pid) return alert("ููุท ูููุดุฆ ุงูุฌูุณุฉ ูุณุชุทูุน ุจุฏุก ุงููุนุจุฉ.");
    if (s.status !== "lobby") return alert("ุงููุนุจุฉ ุจุฏุฃุช ุจุงููุนู.");

    const players = Object.values(s.players || {}).filter(p => !p.left);
    if (players.length < 5) return alert("ูุงุฒู 5 ูุงุนุจูู ุนูู ุงูุฃูู.");

    const seconds = clampInt(s.config?.phaseSeconds, 15, 3600);
    const mafiaCount = Math.max(1, Number(s.config?.mafiaCount || 1));
    const rolesCfg = s.config?.roles || {};

    const roles = [];
    for (let i=0;i<mafiaCount;i++) roles.push("mafia");

    const addRole = (key) => {
      const r = rolesCfg[key];
      if (!r?.on) return;
      const cnt = Math.max(0, Number(r.count || 0));
      for (let i=0;i<cnt;i++) roles.push(key);
    };
    ["sniper","jester","doctor","detective","bodyguard","serial","witch","mayor"].forEach(addRole);

    if (roles.length > players.length) return alert(`ุงูุฃุฏูุงุฑ ุฃูุซุฑ ูู ุงููุงุนุจูู. ุงูุฃุฏูุงุฑ=${roles.length} ุงููุงุนุจูู=${players.length}`);
    while (roles.length < players.length) roles.push("citizen");

    const rolesShuffled = shuffle(roles);
    const playersShuffled = shuffle(players);

    const updates = {};
    playersShuffled.forEach((p, idx) => {
      updates[`players/${p.id}/role`] = rolesShuffled[idx];
      updates[`players/${p.id}/alive`] = true;
      updates[`players/${p.id}/left`] = false;
    });

    updates["status"] = "playing";
    updates["phase"] = "night";
    updates["round"] = 1;
    updates["winner"] = "";
    updates["phaseEndAt"] = now() + seconds*1000;
    updates["config/sniperUsedBy"] = {};
    updates["config/witchUsedBy"] = {};
    updates["votes"] = { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} }, day: { public:{} }, dayExtra: { sniper:{} } };
    updates["private/detectiveResults"] = {};
    updates["log"] = "ุจุฏุฃุช ุงููุนุจุฉ ุชููุงุฆููุง: ููู ๐";

    await SESS(me.code).update(updates);
    alert("ุชู ุงูุจุฏุก โ");
  }

  // -------- Subscribe & Render --------
  function buildRenderKey(s, pid){
    // Only include parts that affect UI; ignore engine.lock to stop re-render spam (fix issue 1)
    const meObj = s.players?.[pid] || {};
    const subset = {
      status: s.status, phase: s.phase, round: s.round, phaseEndAt: s.phaseEndAt,
      winner: s.winner, log: s.log,
      players: Object.fromEntries(Object.entries(s.players || {}).map(([k,v]) => [k, {id:v.id,name:v.name,alive:v.alive,left:v.left,role:v.role}])),
      votes: s.votes,
      meRole: meObj.role, meAlive: meObj.alive, meLeft: meObj.left,
      detRes: s.private?.detectiveResults?.[pid] || "",
      sniperUsed: s.config?.sniperUsedBy?.[pid] || false,
      witchUsed: s.config?.witchUsedBy?.[pid] || {}
    };
    return JSON.stringify(subset);
  }

  function subscribe(code, pid){
    if (sub) sub.off();
    sub = SESS(code);

    setScreen("player");
    pName.textContent = me.name;
    pCode.textContent = code;

    startEngine(code, pid);

    sub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      // update creator badge
      me.isCreator = (me.pid === s.creatorPid);
      setMe(me);
      badgeMini.textContent = me.isCreator ? "ูููุดุฆ" : "ูุงุนุจ";

      const key = buildRenderKey(s, pid);
      if (key === lastRenderKey) return; // ignore lock churn
      lastRenderKey = key;

      // base info
      publicLog.textContent = s.log || "โ";

      // status: lobby
      if (s.status === "lobby") {
        pPhase.textContent = "ููุจูู";
        pRound.textContent = "โ";
        phaseLeft.textContent = "โ";
        lobbyHint.innerHTML = `ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ ุดุงุฑู ุงูุฑุงุจุท ูุฏุฎููุง ููููู.`;
        lobbyBox.classList.remove("hidden");

        const players = Object.values(s.players || {}).filter(p => !p.left);
        playerCount.textContent = `${players.length} ูุงุนุจูู`;
        playersList.innerHTML = players.length ? "" : `<div class="text-slate-400 text-sm">ูุง ููุฌุฏ ูุงุนุจูู ุจุนุฏ.</div>`;
        players.forEach(p => {
          playersList.innerHTML += `
            <div class="flex items-center justify-between rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
              <div class="font-bold">${escapeHtml(p.name)}</div>
              <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">ุฌุงูุฒ</div>
            </div>`;
        });

        btnStartGame.classList.toggle("hidden", !(me.isCreator && players.length >= 5));
        myVoteStatus.textContent = "ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ";
        pActionBox.innerHTML = `<div class="text-center text-slate-300">ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ</div>`;
        myRoleText.textContent = "โ";
        myRoleHint.textContent = "โ";
        roleExtraBox.classList.add("hidden");
        return;
      }

      lobbyBox.classList.add("hidden");

      // playing
      const phase = s.phase;
      pPhase.textContent = phase === "night" ? "ููู ๐" : "ููุงุฑ โ๏ธ";
      pRound.textContent = String(s.round || 1);

      const endAt = Number(s.phaseEndAt || 0);
      phaseLeft.textContent = endAt ? fmtLeft(endAt - now()) : "โ";
      lobbyHint.innerHTML = `ุงููุนุจุฉ ุชูุฏุงุฑ ุชููุงุฆููุง. ุงุฎุชุฑ ุงูุฅุฌุฑุงุก ุญุณุจ ุฏูุฑู.`;

      if (s.winner) {
        winnerBanner.classList.remove("hidden");
        winnerText.textContent =
          s.winner === "jester" ? "๐คก๐ ูุงุฒ ุงูููุฑูุฌ ูุญุฏู!" :
          s.winner === "serial" ? "๐ช๐ ูุงุฒ ุงููุงุชู ุงููุชุณูุณู!" :
          s.winner === "mafia" ? "๐ฅ๐ ูุงุฒุช ุงููุงููุง!" : "๐ฉ๐ ูุงุฒ ุงูููุงุทููู!";
      } else winnerBanner.classList.add("hidden");

      const meObj = s.players?.[pid];
      if (!meObj) return;

      const roleKey = meObj.role || "";
      if (!roleKey) {
        myRoleText.textContent = "ุจุงูุชุธุงุฑ ุชูุฒูุน ุงูุฃุฏูุงุฑโฆ";
        myRoleHint.textContent = "ุณูุชู ุงูุชูุฒูุน ุนูุฏ ุจุฏุก ุงููุนุจุฉ.";
      } else {
        myRoleText.textContent = ROLE_UI[roleKey]?.name || roleKey;
        myRoleHint.textContent = ROLE_UI[roleKey]?.hint || "โ";
      }

      const detRes = s.private?.detectiveResults?.[pid];
      if (detRes) { roleExtraBox.classList.remove("hidden"); roleExtraText.textContent = detRes; }
      else roleExtraBox.classList.add("hidden");

      // live tally (no names)
      if (phase === "night") {
        liveTally.textContent = tallyTextWeighted(s.votes?.night?.mafia || {}, s.players || {}, () => 1);
      } else {
        const weightFn = (voterPid, playersObj) => {
          const p = playersObj[voterPid];
          return (p?.role === "mayor" && p.alive && !p.left) ? 2 : 1;
        };
        liveTally.textContent = tallyTextWeighted(s.votes?.day?.public || {}, s.players || {}, weightFn);
      }

      renderPlayerAction(s, pid, meObj, roleKey);
    });
  }

  function renderPlayerAction(s, pid, meObj, roleKey){
    // Guard: don't rebuild action UI if it hasn't changed (fix issue 1)
    const actionKey = JSON.stringify({
      status: s.status, phase: s.phase, winner: s.winner,
      roleKey, alive: meObj.alive, left: meObj.left,
      votes: s.votes,
      used: s.config?.sniperUsedBy?.[pid] || false,
      witchUsed: s.config?.witchUsedBy?.[pid] || {}
    });
    if (actionKey === lastActionKey) return;
    lastActionKey = actionKey;

    const phase = s.phase;
    const playersObj = s.players || {};

    if (meObj.left) {
      myVoteStatus.textContent = "ุฎุฑุฌุช ูู ุงูุฌูุณุฉ.";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุฎุฑุฌุช ูู ุงูุฌูุณุฉ.</div>`;
      return;
    }
    if (!meObj.alive) {
      myVoteStatus.textContent = "โ ุฎุงุฑุฌ ุงููุนุจุฉ";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุฃูุช ุฎุงุฑุฌ ุงููุนุจุฉ โ</div>`;
      return;
    }
    if (!roleKey) {
      myVoteStatus.textContent = "ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ</div>`;
      return;
    }
    if (s.winner) {
      myVoteStatus.textContent = "ุงูุชูุช ุงููุนุจุฉ ๐";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุงูุชูุช ุงููุนุจุฉ ๐</div>`;
      return;
    }

    // NIGHT
    if (phase === "night") {
      const parts = [];
      if (roleKey === "mafia") parts.push(s.votes?.night?.mafia?.[pid] ? "โ ุตููุช (ูุงููุง)" : "โณ ูู ุชุตููุช (ูุงููุง)");
      if (roleKey === "doctor") parts.push(s.votes?.night?.doctor?.[pid] ? "โ ุงุฎุชุฑุช ุฅููุงุฐ" : "โณ ูู ุชุฎุชุฑ ุฅููุงุฐ");
      if (roleKey === "detective") parts.push(s.votes?.night?.detective?.[pid] ? "โ ุงุฎุชุฑุช ุชุญููู" : "โณ ูู ุชุฎุชุฑ ุชุญููู");
      if (roleKey === "bodyguard") parts.push(s.votes?.night?.bodyguard?.[pid] ? "โ ุงุฎุชุฑุช ุญูุงูุฉ" : "โณ ูู ุชุฎุชุฑ ุญูุงูุฉ");
      if (roleKey === "serial") parts.push(s.votes?.night?.serial?.[pid] ? "โ ุงุฎุชุฑุช ูุชู" : "โณ ูู ุชุฎุชุฑ ูุชู");
      if (roleKey === "witch") {
        const ws = s.votes?.night?.witchSave?.[pid];
        const wp = s.votes?.night?.witchPoison?.[pid];
        parts.push((ws || wp) ? "โ ูุฑุงุฑุงุช ุงูุณุงุญุฑุฉ ูุณุฌููุฉ" : "โณ ูู ุชุฎุชุงุฑู ูุฑุงุฑ");
      }
      myVoteStatus.textContent = parts.length ? parts.join(" | ") : "ููู: ูุง ููุฌุฏ ุฅุฌุฑุงุก ูู.";

      const aliveNoSelf = buildAliveOptions(playersObj, pid, false);
      const aliveAllowSelf = buildAliveOptions(playersObj, pid, true);

      if (roleKey === "mafia") {
        const already = s.votes?.night?.mafia?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ุชุตููุช ุงููุงููุง (ูุชู)</div>
            <select id="selNightKill" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">ุงุฎุชุฑ ุงูุถุญูุฉ</option>${aliveNoSelf}
            </select>
            <button id="btnNightKill" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnNightKillSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">
              (ุงุฎุชูุงุฑู) ุชุฎุทู
            </button>
          </div>`;
        if (!already) {
          $("btnNightKill").addEventListener("click", async () => {
            const victimId = $("selNightKill").value || "";
            if (!victimId) return alert("ุงุฎุชุฑ ุงูุถุญูุฉ.");
            await SESS(me.code).child(`votes/night/mafia/${pid}`).set(victimId);
            alert("ุชู โ");
          });
        }
        $("btnNightKillSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/mafia/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "doctor") {
        const already = s.votes?.night?.doctor?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">๐ฉบ ุงูุทุจูุจ (ุฅููุงุฐ)</div>
            <select id="selDoc" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">ุงุฎุชุฑ ูู ุชููุฐู</option>${aliveAllowSelf}
            </select>
            <button id="btnDoc" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-emerald-600 hover:bg-emerald-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnDocSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">
              ุชุฎุทู
            </button>
          </div>`;
        if (!already) $("btnDoc").addEventListener("click", async () => {
          const t = $("selDoc").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/doctor/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnDocSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/doctor/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "detective") {
        const already = s.votes?.night?.detective?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">๐ ุงููุญูู (ุชุญููู)</div>
            <select id="selDet" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">ุงุฎุชุฑ ุงููุฏู</option>${aliveNoSelf}
            </select>
            <button id="btnDet" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-sky-600 hover:bg-sky-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnDetSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">
              ุชุฎุทู
            </button>
            <div class="text-xs text-slate-400">ุงููุชูุฌุฉ ุชุธูุฑ ูู ููุท ุจุนุฏ ุงูุชูููุฐ.</div>
          </div>`;
        if (!already) $("btnDet").addEventListener("click", async () => {
          const t = $("selDet").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุฏู.");
          await SESS(me.code).child(`votes/night/detective/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnDetSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/detective/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "bodyguard") {
        const already = s.votes?.night?.bodyguard?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">๐ก๏ธ ุงูุญุงุฑุณ (ุญูุงูุฉ)</div>
            <select id="selBg" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">ุงุฎุชุฑ ูู ุชุญููู</option>${aliveAllowSelf}
            </select>
            <button id="btnBg" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-indigo-600 hover:bg-indigo-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnBgSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">
              ุชุฎุทู
            </button>
          </div>`;
        if (!already) $("btnBg").addEventListener("click", async () => {
          const t = $("selBg").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/bodyguard/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnBgSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/bodyguard/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "serial") {
        const already = s.votes?.night?.serial?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">๐ช ุงููุงุชู ุงููุชุณูุณู (ูุชู)</div>
            <select id="selSk" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">ุงุฎุชุฑ ุงูุถุญูุฉ</option>${aliveNoSelf}
            </select>
            <button id="btnSk" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnSkSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">
              ุชุฎุทู
            </button>
          </div>`;
        if (!already) $("btnSk").addEventListener("click", async () => {
          const t = $("selSk").value || "";
          if (!t) return alert("ุงุฎุชุฑ ุงูุถุญูุฉ.");
          await SESS(me.code).child(`votes/night/serial/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnSkSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/serial/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "witch") {
        const used = s.config?.witchUsedBy?.[pid] || {};
        const saveUsed = !!used.saveUsed;
        const poisonUsed = !!used.poisonUsed;
        const ws = s.votes?.night?.witchSave?.[pid];
        const wp = s.votes?.night?.witchPoison?.[pid];

        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="flex items-center justify-between">
              <div class="font-extrabold text-lg">๐งช ุงูุณุงุญุฑุฉ</div>
              <div class="text-xs text-slate-400">ุฅููุงุฐ ูุฑุฉ + ุณู ูุฑุฉ</div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3 space-y-2">
              <div class="flex items-center justify-between">
                <div class="font-bold">๐ฉบ ุฅููุงุฐ</div>
                <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">${saveUsed ? "ูุณุชุฎุฏู" : (ws ? "ูุฑุณูู" : "ูุชุงุญ")}</div>
              </div>
              <select id="selWitchSave" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${saveUsed || ws ? "disabled" : ""}>
                <option value="">ุงุฎุชุฑ ูู ุชููุฐู</option>${aliveAllowSelf}
              </select>
              <button id="btnWitchSave" class="tap w-full px-4 py-3 rounded-3xl ${saveUsed || ws ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-emerald-600 hover:bg-emerald-500"} font-extrabold" ${saveUsed || ws ? "disabled" : ""}>
                ุฅุฑุณุงู ุงูุฅููุงุฐ
              </button>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3 space-y-2">
              <div class="flex items-center justify-between">
                <div class="font-bold">โ๏ธ ุณู</div>
                <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">${poisonUsed ? "ูุณุชุฎุฏู" : (wp ? "ูุฑุณูู" : "ูุชุงุญ")}</div>
              </div>
              <select id="selWitchPoison" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${poisonUsed || wp ? "disabled" : ""}>
                <option value="">ุงุฎุชุฑ ูู ุชุณููู</option>${aliveNoSelf}
              </select>
              <button id="btnWitchPoison" class="tap w-full px-4 py-3 rounded-3xl ${poisonUsed || wp ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${poisonUsed || wp ? "disabled" : ""}>
                ุฅุฑุณุงู ุงูุณู
              </button>
            </div>

            <button id="btnWitchSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">
              ุชุฎุทู (ูุง ุดูุก)
            </button>
          </div>`;

        $("btnWitchSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/witchSave/${pid}`).set("skip");
          await SESS(me.code).child(`votes/night/witchPoison/${pid}`).set("skip");
          alert("ุชู โ");
        });

        const bs = $("btnWitchSave");
        if (bs && !saveUsed && !ws) bs.addEventListener("click", async () => {
          const t = $("selWitchSave").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/witchSave/${pid}`).set(t);
          alert("ุชู โ");
        });

        const bp = $("btnWitchPoison");
        if (bp && !poisonUsed && !wp) bp.addEventListener("click", async () => {
          const t = $("selWitchPoison").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/witchPoison/${pid}`).set(t);
          alert("ุชู โ");
        });

        return;
      }

      pActionBox.innerHTML = `<div class="text-center text-slate-300">ูููโฆ ุงูุชุธุฑ.</div>`;
      return;
    }

    // DAY
    const v = s.votes?.day?.public?.[pid];
    const used = !!s.config?.sniperUsedBy?.[pid];
    const sv = s.votes?.dayExtra?.sniper?.[pid];
    const extra = (roleKey === "sniper") ? (used ? " | ๐ฏ ุงูุทููุฉ ูุณุชูููุฉ." : (sv ? " | ๐ฏ ุชู ุชุญุฏูุฏ ุงููุฏู." : " | ๐ฏ ูู ุชุณุชุฎุฏู ุงูุทููุฉ.")) : "";
    myVoteStatus.textContent = (v ? "โ ุชู ุชุตููุช ุงูููุงุฑ." : "โณ ูู ุชุตููุช ุจุนุฏ.") + extra;

    const aliveOptionsNoSelf = buildAliveOptions(playersObj, pid, false);
    const dayAlready = !!v;
    const sniperDisabled = used || !!sv;

    pActionBox.innerHTML = `
      <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
        <div class="font-extrabold text-lg">ุชุตููุช ุงูููุงุฑ (ุฅูุตุงุก)</div>
        <select id="selDayVote" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${dayAlready ? "disabled" : ""}>
          <option value="">ุงุฎุชุฑ ุงูุดุฎุต</option>${aliveOptionsNoSelf}
        </select>
        <button id="btnDayVote" class="tap w-full px-4 py-4 rounded-3xl ${dayAlready ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-amber-600 hover:bg-amber-500"} font-extrabold" ${dayAlready ? "disabled" : ""}>
          ${dayAlready ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู ุงูุชุตููุช"}
        </button>
      </div>

      ${roleKey === "sniper" ? `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">๐ฏ ุงูููุงุต</div>
            <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">
              ${used ? "ูุณุชุฎุฏู" : (sv ? "ุชู ุงูุฅุฑุณุงู" : "ูุชุงุญ")}
            </div>
          </div>
          <select id="selSniper" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${sniperDisabled ? "disabled" : ""}>
            <option value="">ุงุฎุชุฑ ุงููุฏู</option>${aliveOptionsNoSelf}
          </select>
          <button id="btnSniper" class="tap w-full px-4 py-4 rounded-3xl ${sniperDisabled ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${sniperDisabled ? "disabled" : ""}>
            ${used ? "ุชู ุงุณุชุฎุฏุงู ุงูุทููุฉ" : (sv ? "ุชู ุชุญุฏูุฏ ุงููุฏู" : "ุชุญุฏูุฏ ุงููุฏู (ุณุฑู)")}
          </button>
        </div>
      ` : "" }
    `;

    if (!dayAlready) $("btnDayVote").addEventListener("click", async () => {
      const targetId = $("selDayVote").value || "";
      if (!targetId) return alert("ุงุฎุชุฑ ุงูุดุฎุต.");
      await SESS(me.code).child(`votes/day/public/${pid}`).set(targetId);
      alert("ุชู โ");
    });

    if (roleKey === "sniper" && !sniperDisabled) $("btnSniper").addEventListener("click", async () => {
      const targetId = $("selSniper").value || "";
      if (!targetId) return alert("ุงุฎุชุฑ ุงููุฏู.");
      await SESS(me.code).child(`votes/dayExtra/sniper/${pid}`).set(targetId);
      alert("ุชู โ");
    });
  }

  // ---------- UI Events ----------
  btnGoCreate.addEventListener("click", () => setScreen("create"));
  btnGoJoin.addEventListener("click", () => setScreen("join"));
  btnBackFromCreate.addEventListener("click", () => setScreen("mode"));
  btnBackFromJoin.addEventListener("click", () => setScreen("mode"));

  btnCreateSession.addEventListener("click", createSessionAsPlayer);
  btnPlayerJoin.addEventListener("click", joinSession);

  btnToggleRole.addEventListener("click", () => myRoleCard.classList.toggle("hidden"));
  btnCopyShare.addEventListener("click", () => me?.code && shareLink(me.code));
  btnStartGame.addEventListener("click", startGameIfCreator);

  btnLeave.addEventListener("click", leaveSession);

  btnHow.addEventListener("click", () => howModal.classList.remove("hidden"));
  btnCloseHow.addEventListener("click", () => howModal.classList.add("hidden"));
  howModal.addEventListener("click", (e) => { if (e.target === howModal) howModal.classList.add("hidden"); });

  // Countdown (local only)
  setInterval(() => {
    if (!me?.code) return;
    SESS(me.code).child("phaseEndAt").get().then(snap => {
      const endAt = Number(snap.val() || 0);
      if (!endAt) return;
      phaseLeft.textContent = fmtLeft(endAt - now());
    }).catch(()=>{});
  }, 900);

  // ---------- Resume ----------
  if (me?.code && me?.pid) {
    setScreen("player");
    pName.textContent = me.name;
    pCode.textContent = me.code;
    subscribe(me.code, me.pid);
  } else if (preCode) {
    setScreen("join");
  } else {
    setScreen("mode");
  }
})();
</script>
</body>
</html>
