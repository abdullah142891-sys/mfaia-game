<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø§ÙÙŠØ§ â€” Ø¬Ù„Ø³Ø© Ù…Ø´ØªØ±ÙƒØ©</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <style>
    body { padding-bottom: env(safe-area-inset-bottom); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-40 bg-slate-950/80 glass border-b border-slate-800">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="text-lg font-extrabold">ğŸ•µï¸â€â™‚ï¸ Ù…Ø§ÙÙŠØ§</div>
        <div id="badgeMini" class="hidden text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">â€”</div>
      </div>
      <div class="flex gap-2">
        <button id="btnCopyShare" class="hidden tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          Ù…Ø´Ø§Ø±ÙƒØ©
        </button>
        <button id="btnResetLocal" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 py-5 space-y-4">

    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± -->
    <section id="screenMode" class="space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 shadow">
        <h1 class="text-2xl font-extrabold">Ø¬Ù„Ø³Ø© Ù…Ø´ØªØ±ÙƒØ©</h1>
        <p class="text-slate-300 text-sm mt-2 leading-6">
          <span class="font-bold text-slate-100">Ø§Ù„Ù…Ø¯ÙŠØ±:</span> ÙŠØ¯ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø¨Ø¯ÙˆÙ† Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±).<br>
          <span class="font-bold text-slate-100">Ø§Ù„Ù„Ø§Ø¹Ø¨:</span> ÙƒÙ„ Ø´Ø®Øµ ÙŠØ´ÙˆÙ Ø¯ÙˆØ±Ù‡ ÙÙ‚Ø· ÙˆÙŠØµÙˆÙ‘Øª/ÙŠØªØµØ±Ù Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©.
        </p>
      </div>

      <button id="btnGoHost" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
        Ø£Ù†Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± (Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø©)
      </button>

      <button id="btnGoPlayer" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
        Ø£Ù†Ø§ Ù„Ø§Ø¹Ø¨ (Ø¯Ø®ÙˆÙ„ Ø¬Ù„Ø³Ø©)
      </button>

      <div class="text-xs text-slate-400 text-center">
        ØªÙ„Ù…ÙŠØ­: ØªÙ‚Ø¯Ø± ØªØ±Ø³Ù„ â€œØ±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„â€ Ø¨Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯.
      </div>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <section id="screenHost" class="hidden space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-slate-300">ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©</div>
            <div id="hostCode" class="text-4xl font-extrabold tracking-widest mt-1">â€”</div>
            <div class="text-sm text-slate-300 mt-2">Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø¶ØºØ· â€œÙ…Ø´Ø§Ø±ÙƒØ©â€ Ù„Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø¯Ø®ÙˆÙ„ Ø¬Ø§Ù‡Ø².</div>
          </div>
          <button id="btnCopyJoin" class="tap px-4 py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">
            Ù†Ø³Ø®
          </button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</div>
            <div id="hostStatus" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
            <div id="hostCount" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
        </div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-4">
        <h2 class="font-extrabold text-lg">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-300">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§</label>
            <input id="hostMafia" type="number" min="1" value="1"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
          </div>

          <div>
            <label class="text-sm text-slate-300">Ø­Ù„ Ø§Ù„ØªØ¹Ø§Ø¯Ù„</label>
            <select id="hostTieMode"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
              <option value="revote">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØª</option>
              <option value="random">Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
            </select>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">Ø§Ù„Ø£Ø¯ÙˆØ§Ø± (ØªÙØ¹ÙŠÙ„/Ø¥Ù„ØºØ§Ø¡ + Ø¹Ø¯Ø¯)</div>
            <div class="text-xs text-slate-400">Ø§Ù„Ø¨Ø§Ù‚ÙŠ ÙŠØµØ¨Ø­ â€œÙ…ÙˆØ§Ø·Ù†â€</div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ¯ Ù‚Ù†Ø§Øµ</span>
                <input id="roleSniperOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <div class="mt-2">
                <input id="roleSniperCount" type="number" min="0" max="3" value="1"
                  class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
              </div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ¤¡ Ù…Ù‡Ø±Ù‘Ø¬</span>
                <input id="roleJesterOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <div class="mt-2">
                <input id="roleJesterCount" type="number" min="0" max="3" value="1"
                  class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
              </div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ©º Ø·Ø¨ÙŠØ¨</span>
                <input id="roleDoctorOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <div class="mt-2">
                <input id="roleDoctorCount" type="number" min="0" max="3" value="1"
                  class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
              </div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ” Ù…Ø­Ù‚Ù‚</span>
                <input id="roleDetectiveOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <div class="mt-2">
                <input id="roleDetectiveCount" type="number" min="0" max="3" value="1"
                  class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
              </div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ›¡ï¸ Ø­Ø§Ø±Ø³</span>
                <input id="roleBodyguardOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <div class="mt-2">
                <input id="roleBodyguardCount" type="number" min="0" max="3" value="1"
                  class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
              </div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">ğŸ”ª Ù‚Ø§ØªÙ„ Ù…ØªØ³Ù„Ø³Ù„</span>
                <input id="roleSerialOn" type="checkbox" class="h-5 w-5 accent-sky-500">
              </label>
              <div class="mt-2">
                <input id="roleSerialCount" type="number" min="0" max="3" value="1"
                  class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
              </div>
            </div>
          </div>

          <div class="text-xs text-slate-400 leading-6">
            â€¢ Ø§Ù„Ø·Ø¨ÙŠØ¨: ÙŠØ®ØªØ§Ø± Ø´Ø®ØµÙ‹Ø§ Ù„Ø¥Ù†Ù‚Ø§Ø°Ù‡ (Ù„ÙŠÙ„).<br>
            â€¢ Ø§Ù„Ù…Ø­Ù‚Ù‚: ÙŠØ­Ù‚Ù‚ ÙˆÙŠØ¸Ù‡Ø± Ù„Ù‡ ÙÙ‚Ø· â€œÙ…Ø§ÙÙŠØ§/Ù„ÙŠØ³ Ù…Ø§ÙÙŠØ§â€ (Ù„ÙŠÙ„).<br>
            â€¢ Ø§Ù„Ø­Ø§Ø±Ø³: ÙŠØ­Ù…ÙŠ Ø´Ø®ØµÙ‹Ø§Ø› Ø¥Ø°Ø§ Ù‡Ø§Ø¬Ù…Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ Ù‡Ø¯ÙÙ‡ ÙŠÙ…ÙˆØª Ø§Ù„Ø­Ø§Ø±Ø³ Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù†Ù‡ (Ù„ÙŠÙ„).<br>
            â€¢ Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„: ÙŠÙ‚ØªÙ„ Ø´Ø®ØµÙ‹Ø§ (Ù„ÙŠÙ„) ÙˆÙ‡Ùˆ Ø·Ø±Ù Ù…Ø³ØªÙ‚Ù„ (ÙŠÙÙˆØ² Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ù„ÙˆØ­Ø¯Ù‡).
          </div>
        </div>

        <button id="btnHostLockAndAssign" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          Ù‚ÙÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† + ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        </button>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</div>
            <div class="text-xs text-slate-400">Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù…Ø®ÙÙŠØ©</div>
          </div>
          <div id="hostPlayers" class="mt-3 space-y-2"></div>
        </div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-300">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
            <div id="hostPhase" class="text-2xl font-extrabold">â€”</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-300">Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
            <div id="hostRound" class="text-2xl font-extrabold">â€”</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnHostTogglePhase" class="tap px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold">
            ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„/Ù†Ù‡Ø§Ø±
          </button>
          <button id="btnHostResolve" class="tap px-4 py-4 rounded-3xl bg-amber-600 hover:bg-amber-500 font-extrabold">
            ØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªÙŠØ¬Ø©
          </button>
        </div>

        <!-- Timer -->
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">â±ï¸ Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
            <div id="hostTimerText" class="text-lg font-extrabold">â€”</div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-slate-300">Ø§Ù„Ù…Ø¯Ø© (Ø«Ø§Ù†ÙŠØ©)</label>
              <input id="hostPhaseSeconds" type="number" min="15" value="120"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>
            <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-3 text-xs text-slate-300 leading-6">
              Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª Ø«Ù… Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡ Ù†ÙÙ‘Ø° Ø§Ù„Ù†ØªÙŠØ¬Ø©.
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <button id="btnTimerStart" class="tap px-4 py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-500 font-extrabold">Ø¨Ø¯Ø¡</button>
            <button id="btnTimerStop" class="tap px-4 py-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">Ø¥ÙŠÙ‚Ø§Ù</button>
            <button id="btnTimerReset" class="tap px-4 py-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª</div>
            <div id="hostVoteInfo" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø§Ù„ÙØ§Ø¦Ø²</div>
            <div id="hostWinner" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
          <div class="font-extrabold">Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©</div>
          <div id="hostLog" class="mt-1 text-slate-300 text-sm leading-6">â€”</div>
        </div>
      </div>

      <button id="btnBackMode1" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
        Ø±Ø¬ÙˆØ¹
      </button>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
    <section id="screenPlayer" class="hidden space-y-4">
      <div id="joinBox" class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">Ø¯Ø®ÙˆÙ„ Ø¬Ù„Ø³Ø©</h2>

        <label class="text-sm text-slate-300">ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©</label>
        <input id="playerCode" placeholder="Ù…Ø«Ø§Ù„: 482913"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <label class="text-sm text-slate-300">Ø§Ø³Ù…Ùƒ</label>
        <input id="playerName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <button id="btnPlayerJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
          Ø¯Ø®ÙˆÙ„
        </button>

        <div class="text-xs text-slate-400">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©.</div>
      </div>

      <div id="playerBox" class="hidden space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="text-xs text-slate-300">Ø£Ù†Øª Ø¯Ø§Ø®Ù„ Ø¬Ù„Ø³Ø©</div>
          <div class="text-2xl font-extrabold mt-1">
            <span id="pName">â€”</span> Â· <span class="tracking-widest" id="pCode">â€”</span>
          </div>

          <div class="mt-3 rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-slate-300">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
                <div id="pPhase" class="text-2xl font-extrabold mt-1">â€”</div>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-300">Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
                <div id="pRound" class="text-2xl font-extrabold mt-1">â€”</div>
              </div>
            </div>
          </div>

          <div id="winnerBanner" class="hidden mt-3 rounded-2xl border border-amber-700 bg-amber-900/20 p-3">
            <div class="font-extrabold" id="winnerText">â€”</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Ø¯ÙˆØ±Ùƒ</div>
            <button id="btnToggleRole" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
              Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡
            </button>
          </div>

          <div id="myRoleCard" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
            <div id="myRoleText" class="text-3xl font-extrabold">â€”</div>
            <div id="myRoleHint" class="text-sm text-slate-300 mt-2 leading-6">â€”</div>
            <div id="roleExtraBox" class="mt-3 hidden rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <div class="text-xs text-slate-300">Ù…Ø¹Ù„ÙˆÙ…Ø© Ø®Ø§ØµØ©</div>
              <div id="roleExtraText" class="mt-1 font-bold">â€”</div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">ØªØµÙˆÙŠØªÙƒ</div>
            <div id="myVoteStatus" class="text-sm text-slate-300 mt-1">â€”</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
            <div class="text-xs text-slate-400">ğŸ“Š <span id="liveTally">â€”</span></div>
          </div>
          <div id="pActionBox" class="mt-3 space-y-3"></div>
        </div>

        <button id="btnBackMode2" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          Ø±Ø¬ÙˆØ¹
        </button>
      </div>
    </section>
  </main>

<script>
(() => {
  const firebaseConfig = {
    apiKey: "AIzaSyC4YdqgiAfJmRmvkLH4wspzclAzKs3wyLw",
    authDomain: "mafia-game-7e488.firebaseapp.com",
    databaseURL: "https://mafia-game-7e488-default-rtdb.firebaseio.com",
    projectId: "mafia-game-7e488",
    storageBucket: "mafia-game-7e488.firebasestorage.app",
    messagingSenderId: "513186840934",
    appId: "1:513186840934:web:ccf858b27cea91be1448a7"
  };

  const $ = (id) => document.getElementById(id);
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const rid = () => (crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint32Array(2))].map(x=>x.toString(16)).join("") : String(Math.random()).slice(2));
  const now = () => Date.now();
  const code6 = () => String(Math.floor(100000 + Math.random() * 900000));
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const shuffle = (arr) => { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
  const normName = (s) => String(s || "").trim().replace(/\s+/g, " ").toLowerCase();

  function fmtLeft(ms){
    const s = Math.max(0, Math.ceil(ms / 1000));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return m > 0 ? `${m}:${String(r).padStart(2,"0")}` : `${r}s`;
  }

  function tallyText(votesObj){
    const tally = {};
    Object.values(votesObj || {}).forEach(id => { if (!id) return; tally[id] = (tally[id] || 0) + 1; });
    const total = Object.keys(votesObj || {}).length;
    const arr = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
    if (total === 0) return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆØ§Øª Ø¨Ø¹Ø¯.";
    const top = arr.length ? arr[0][1] : 0;
    return `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${total} ØµÙˆØª. Ø£Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø¹Ù„ÙŠÙ‡ ${top} ØµÙˆØª.`;
  }

  function getTopCandidates(votes){
    const tally = {};
    Object.values(votes || {}).forEach(id => { if (!id) return; tally[id] = (tally[id] || 0) + 1; });
    const entries = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
    if (!entries.length) return { max: 0, candidates: [] };
    const max = entries[0][1];
    const candidates = entries.filter(([,c]) => c === max).map(([id]) => id);
    return { max, candidates };
  }

  const LS_KEY = "mafia_identity_v5_roles";
  const getMe = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; } };
  const setMe = (o) => localStorage.setItem(LS_KEY, JSON.stringify(o));
  const clearMe = () => localStorage.removeItem(LS_KEY);

  const SESS = (code) => db.ref(`sessions/${code}`);

  // UI refs
  const badgeMini = $("badgeMini");
  const btnCopyShare = $("btnCopyShare");
  const btnResetLocal = $("btnResetLocal");
  const screenMode = $("screenMode");
  const screenHost = $("screenHost");
  const screenPlayer = $("screenPlayer");
  const btnGoHost = $("btnGoHost");
  const btnGoPlayer = $("btnGoPlayer");

  // Host refs
  const hostCodeEl = $("hostCode");
  const btnCopyJoin = $("btnCopyJoin");
  const hostStatus = $("hostStatus");
  const hostCount = $("hostCount");
  const hostMafia = $("hostMafia");
  const hostTieMode = $("hostTieMode");
  const btnHostLockAndAssign = $("btnHostLockAndAssign");
  const hostPlayers = $("hostPlayers");
  const hostPhase = $("hostPhase");
  const hostRound = $("hostRound");
  const btnHostTogglePhase = $("btnHostTogglePhase");
  const btnHostResolve = $("btnHostResolve");
  const hostVoteInfo = $("hostVoteInfo");
  const hostWinner = $("hostWinner");
  const hostLog = $("hostLog");
  const btnBackMode1 = $("btnBackMode1");

  // Roles controls
  const roleSniperOn = $("roleSniperOn");
  const roleJesterOn = $("roleJesterOn");
  const roleDoctorOn = $("roleDoctorOn");
  const roleDetectiveOn = $("roleDetectiveOn");
  const roleBodyguardOn = $("roleBodyguardOn");
  const roleSerialOn = $("roleSerialOn");
  const roleSniperCount = $("roleSniperCount");
  const roleJesterCount = $("roleJesterCount");
  const roleDoctorCount = $("roleDoctorCount");
  const roleDetectiveCount = $("roleDetectiveCount");
  const roleBodyguardCount = $("roleBodyguardCount");
  const roleSerialCount = $("roleSerialCount");

  // Timer
  const hostTimerText = $("hostTimerText");
  const hostPhaseSeconds = $("hostPhaseSeconds");
  const btnTimerStart = $("btnTimerStart");
  const btnTimerStop = $("btnTimerStop");
  const btnTimerReset = $("btnTimerReset");

  // Player refs
  const joinBox = $("joinBox");
  const playerBox = $("playerBox");
  const playerCode = $("playerCode");
  const playerName = $("playerName");
  const btnPlayerJoin = $("btnPlayerJoin");
  const pName = $("pName");
  const pCode = $("pCode");
  const pPhase = $("pPhase");
  const pRound = $("pRound");
  const winnerBanner = $("winnerBanner");
  const winnerText = $("winnerText");
  const btnToggleRole = $("btnToggleRole");
  const myRoleCard = $("myRoleCard");
  const myRoleText = $("myRoleText");
  const myRoleHint = $("myRoleHint");
  const roleExtraBox = $("roleExtraBox");
  const roleExtraText = $("roleExtraText");
  const myVoteStatus = $("myVoteStatus");
  const liveTally = $("liveTally");
  const pActionBox = $("pActionBox");
  const btnBackMode2 = $("btnBackMode2");

  const ROLE_UI = {
    mafia: { name:"Ù…Ø§ÙÙŠØ§", hint:"Ø¨Ø§Ù„Ù„ÙŠÙ„: ØµÙˆÙ‘Øª Ù„Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨. Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±: Ø­Ø§ÙˆÙ„ Ù…Ø§ ØªÙ†ÙƒØ´Ù." },
    citizen: { name:"Ù…ÙˆØ§Ø·Ù†", hint:"Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±: ØµÙˆÙ‘Øª ØµØ­. Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ù†ØªØ¸Ø±." },
    sniper: { name:"Ù‚Ù†Ø§Øµ", hint:"ğŸ¯ Ø·Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø·ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±). Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ø³Ø±ÙŠ." },
    jester: { name:"Ù…Ù‡Ø±Ù‘Ø¬", hint:"ğŸ¤¡ Ù‡Ø¯ÙÙƒ ÙŠØªÙ… Ø¥Ù‚ØµØ§Ø¤Ùƒ Ø¨Ø§Ù„ØªØµÙˆÙŠØª ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø± Ù„ØªÙÙˆØ² ÙˆØ­Ø¯Ùƒ ÙÙˆØ±Ù‹Ø§." },
    doctor: { name:"Ø·Ø¨ÙŠØ¨", hint:"ğŸ©º Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„Ø¥Ù†Ù‚Ø§Ø°Ù‡ Ù…Ù† Ø§Ù„Ù‚ØªÙ„." },
    detective: { name:"Ù…Ø­Ù‚Ù‚", hint:"ğŸ” Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„Ù„ØªØ­Ù‚ÙŠÙ‚ (ÙŠØ¸Ù‡Ø± Ù„Ùƒ: Ù…Ø§ÙÙŠØ§/Ù„ÙŠØ³ Ù…Ø§ÙÙŠØ§)." },
    bodyguard: { name:"Ø­Ø§Ø±Ø³", hint:"ğŸ›¡ï¸ Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„ØªØ­Ù…ÙŠÙ‡. Ø¥Ø°Ø§ Ù‡Ø§Ø¬Ù…ØªÙ‡ Ø§Ù„Ù…Ø§ÙÙŠØ§ ØªÙ…ÙˆØª Ø£Ù†Øª Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù†Ù‡." },
    serial: { name:"Ù‚Ø§ØªÙ„ Ù…ØªØ³Ù„Ø³Ù„", hint:"ğŸ”ª Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ù‹Ø§ Ù„Ù‚ØªÙ„Ù‡. Ù‡Ø¯ÙÙƒ ØªØ¨Ù‚Ù‰ Ø¢Ø®Ø± Ø´Ø®Øµ Ø­ÙŠ." }
  };

  // State
  let hostCode = null;
  let hostSub = null;
  let playerSub = null;
  let me = getMe();

  function setScreen(which){
    screenMode.classList.add("hidden");
    screenHost.classList.add("hidden");
    screenPlayer.classList.add("hidden");
    btnCopyShare.classList.add("hidden");
    badgeMini.classList.add("hidden");

    if (which === "mode") screenMode.classList.remove("hidden");
    if (which === "host") {
      screenHost.classList.remove("hidden");
      btnCopyShare.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = "Ù…Ø¯ÙŠØ±";
    }
    if (which === "player") {
      screenPlayer.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = "Ù„Ø§Ø¹Ø¨";
    }
  }

  function shareLink(code){
    const url = `${location.origin}${location.pathname}?code=${code}`;
    navigator.clipboard?.writeText(url);
    alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„.");
  }

  // URL join
  const urlParams = new URLSearchParams(location.search);
  const preCode = urlParams.get("code");
  if (preCode && !me) {
    setScreen("player");
    playerCode.value = preCode;
  }

  // Timer helpers
  async function timerStart(code){
    const seconds = Math.max(15, Number(hostPhaseSeconds?.value || 120));
    await SESS(code).update({ "config/phaseSeconds": seconds, "config/timer": { running: true, endAt: now() + seconds * 1000 } });
  }
  async function timerStop(code){
    await SESS(code).update({ "config/timer": { running: false, endAt: 0 } });
  }
  async function timerReset(code){
    const snap = await SESS(code).get();
    const s = snap.val();
    const seconds = Math.max(15, Number(s?.config?.phaseSeconds || 120));
    await SESS(code).update({ "config/timer": { running: false, endAt: now() + seconds * 1000 } });
  }

  // Create session
  async function createSession(){
    const code = code6();
    hostCode = code;

    await SESS(code).set({
      code,
      createdAt: now(),
      status: "lobby",
      phase: "night",
      round: 1,
      config: {
        mafiaCount: 1,
        phaseSeconds: 120,
        timer: { running: false, endAt: 0 },
        tieMode: "revote",
        roles: {
          sniper: { on: true, count: 1 },
          jester: { on: true, count: 1 },
          doctor: { on: false, count: 1 },
          detective: { on: false, count: 1 },
          bodyguard: { on: false, count: 1 },
          serial: { on: false, count: 1 }
        },
        sniperUsedBy: {}
      },
      winner: "",
      log: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©.",
      votes: {
        night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{} },
        day: { public:{} },
        dayExtra: { sniper:{} }
      },
      private: { detectiveResults:{} }
    });
    await SESS(code).child("players").set({});

    me = { mode:"host", code };
    setMe(me);

    hostCodeEl.textContent = code;
    setScreen("host");
    subscribeHost(code);
  }

  function computeWinner(players){
    const alive = players.filter(p => p.alive);
    if (alive.length === 0) return "";
    const mafiaAlive = alive.filter(p => p.role === "mafia").length;
    const serialAlive = alive.filter(p => p.role === "serial").length;

    if (alive.length === 1 && alive[0].role === "serial") return "serial";
    if (mafiaAlive === 0 && serialAlive === 0) return "citizens";
    if (mafiaAlive > 0 && mafiaAlive >= (alive.length - mafiaAlive)) return "mafia";
    return "";
  }

  function subscribeHost(code){
    if (hostSub) hostSub.off();
    hostSub = SESS(code);

    hostSub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      hostStatus.textContent = s.status === "lobby" ? "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†" : "Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©";
      hostPhase.textContent = s.phase === "night" ? "Ù„ÙŠÙ„ ğŸŒ™" : "Ù†Ù‡Ø§Ø± â˜€ï¸";
      hostRound.textContent = String(s.round || 1);
      hostLog.textContent = s.log || "â€”";
      hostWinner.textContent = s.winner ? (
        s.winner === "jester" ? "ğŸ¤¡ Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬" :
        s.winner === "serial" ? "ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„" :
        s.winner === "mafia" ? "ğŸŸ¥ Ø§Ù„Ù…Ø§ÙÙŠØ§" : "ğŸŸ© Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†"
      ) : "â€”";

      if (hostPhaseSeconds) hostPhaseSeconds.value = String(s.config?.phaseSeconds || 120);
      if (hostTieMode) hostTieMode.value = String(s.config?.tieMode || "revote");

      // roles sync
      const rc = s.config?.roles || {};
      const setRoleUI = (onEl, cntEl, key, defOn, defCnt) => {
        const v = rc[key] || { on: defOn, count: defCnt };
        if (onEl) onEl.checked = !!v.on;
        if (cntEl) cntEl.value = String(v.count ?? defCnt);
      };
      setRoleUI(roleSniperOn, roleSniperCount, "sniper", true, 1);
      setRoleUI(roleJesterOn, roleJesterCount, "jester", true, 1);
      setRoleUI(roleDoctorOn, roleDoctorCount, "doctor", false, 1);
      setRoleUI(roleDetectiveOn, roleDetectiveCount, "detective", false, 1);
      setRoleUI(roleBodyguardOn, roleBodyguardCount, "bodyguard", false, 1);
      setRoleUI(roleSerialOn, roleSerialCount, "serial", false, 1);

      const t = s.config?.timer || { running:false, endAt:0 };
      if (hostTimerText) hostTimerText.textContent = t.running ? fmtLeft((t.endAt || 0) - now()) : "Ù…ØªÙˆÙ‚Ù";

      // players
      const playersObj = s.players || {};
      const players = Object.values(playersObj);
      hostCount.textContent = String(players.length || 0);

      hostPlayers.innerHTML = "";
      if (players.length === 0) hostPlayers.innerHTML = `<div class="text-slate-400 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¹Ø¯.</div>`;
      else {
        players.forEach(p => {
          hostPlayers.innerHTML += `
            <div class="flex items-center justify-between rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
              <div class="font-bold">${escapeHtml(p.name)}</div>
              <div class="text-xs px-2 py-1 rounded-xl border ${p.alive ? "border-emerald-700 bg-emerald-900/30 text-emerald-200" : "border-rose-800 bg-rose-900/20 text-rose-200"}">
                ${p.alive ? "Ø­ÙŠ" : "Ù…ÙŠØª"}
              </div>
            </div>`;
        });
      }

      // completion info
      const aliveAll = players.filter(x => x.alive);
      const aliveMafia = aliveAll.filter(x => x.role === "mafia");
      if (s.phase === "night") {
        const mv = s.votes?.night?.mafia || {};
        hostVoteInfo.textContent = `${Object.keys(mv).length}/${Math.max(1, aliveMafia.length)} (Ù…Ø§ÙÙŠØ§)`;
      } else {
        const dv = s.votes?.day?.public || {};
        hostVoteInfo.textContent = `${Object.keys(dv).length}/${Math.max(1, aliveAll.length)} (Ù†Ù‡Ø§Ø±)`;
      }
    });
  }

  function readRoleConfigFromUI(){
    const clampInt = (x, lo, hi) => Math.max(lo, Math.min(hi, Number(x || 0)));
    const mk = (onEl, cntEl) => ({ on: !!onEl?.checked, count: clampInt(cntEl?.value, 0, 20) });
    return {
      sniper: mk(roleSniperOn, roleSniperCount),
      jester: mk(roleJesterOn, roleJesterCount),
      doctor: mk(roleDoctorOn, roleDoctorCount),
      detective: mk(roleDetectiveOn, roleDetectiveCount),
      bodyguard: mk(roleBodyguardOn, roleBodyguardCount),
      serial: mk(roleSerialOn, roleSerialCount)
    };
  }

  async function lockAndAssign(){
    if (!hostCode) return;

    const snap = await SESS(hostCode).get();
    const s = snap.val();
    const playersObj = s?.players || {};
    const players = Object.values(playersObj);
    if (players.length < 5) return alert("Ù„Ø§Ø²Ù… 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");

    const mafiaCount = Math.max(1, Number(hostMafia.value || 1));
    const tieMode = String(hostTieMode?.value || "revote");
    const rolesCfg = readRoleConfigFromUI();

    await SESS(hostCode).update({ "config/mafiaCount": mafiaCount, "config/tieMode": tieMode, "config/roles": rolesCfg });

    const roles = [];
    for (let i=0;i<mafiaCount;i++) roles.push("mafia");

    const addRole = (key) => {
      const r = rolesCfg[key];
      if (!r?.on) return;
      const cnt = Math.max(0, Number(r.count || 0));
      for (let i=0;i<cnt;i++) roles.push(key);
    };

    addRole("sniper");
    addRole("jester");
    addRole("doctor");
    addRole("detective");
    addRole("bodyguard");
    addRole("serial");

    if (roles.length > players.length) return alert(`Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†. Ø§Ù„Ø£Ø¯ÙˆØ§Ø±=${roles.length} Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†=${players.length}`);
    while (roles.length < players.length) roles.push("citizen");

    const rolesShuffled = shuffle(roles);
    const playersShuffled = shuffle(players);

    const updates = {};
    playersShuffled.forEach((p, idx) => {
      updates[`players/${p.id}/role`] = rolesShuffled[idx];
      updates[`players/${p.id}/alive`] = true;
      updates[`players/${p.id}/joinedAt`] = p.joinedAt || now();
    });

    updates["status"] = "playing";
    updates["phase"] = "night";
    updates["round"] = 1;
    updates["winner"] = "";
    updates["config/timer"] = { running:false, endAt:0 };
    updates["config/sniperUsedBy"] = {};
    updates["votes"] = { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{} }, day: { public:{} }, dayExtra: { sniper:{} } };
    updates["private/detectiveResults"] = {};
    updates["log"] = "ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±. Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©: Ù„ÙŠÙ„ ğŸŒ™";

    await SESS(hostCode).update(updates);
    alert("ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ âœ…");
  }

  async function togglePhase(){
    if (!hostCode) return;
    const snap = await SESS(hostCode).get();
    const s = snap.val();
    if (!s || s.winner) return alert("Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù†ØªÙ‡ÙŠØ©.");

    const next = s.phase === "night" ? "day" : "night";
    const nextRound = next === "night" ? (Number(s.round||1)+1) : Number(s.round||1);

    await SESS(hostCode).update({
      phase: next,
      round: nextRound,
      votes: { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{} }, day: { public:{} }, dayExtra: { sniper:{} } },
      "config/timer": { running:false, endAt:0 },
      log: `ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ${next === "night" ? "Ù„ÙŠÙ„ ğŸŒ™" : "Ù†Ù‡Ø§Ø± â˜€ï¸"} (Ø§Ù„Ø¬ÙˆÙ„Ø© ${nextRound}).`
    });
  }

  async function resolvePhase(){
    if (!hostCode) return;

    const snap = await SESS(hostCode).get();
    const s = snap.val();
    if (!s || s.status !== "playing") return alert("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");
    if (s.winner) return alert("Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù†ØªÙ‡ÙŠØ©.");

    const tieMode = String(s.config?.tieMode || "revote");
    const playersObj = s.players || {};
    const players = Object.values(playersObj);
    const aliveObj = Object.fromEntries(players.filter(p => p.alive).map(p => [p.id, p]));
    const pickFromCandidates = (candidates) => candidates[Math.floor(Math.random() * candidates.length)];

    async function handleTieReset(path, msg){
      if (tieMode === "revote") {
        const upd = {}; upd[path] = {}; upd["log"] = msg + " ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØª.";
        await SESS(hostCode).update(upd);
        alert("ØªØ¹Ø§Ø¯Ù„: ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØµÙˆÙŠØª.");
        return { stop:true };
      }
      return { stop:false };
    }

    if (s.phase === "night") {
      const aliveMafiaIds = Object.values(playersObj).filter(p => p.alive && p.role === "mafia").map(p => p.id);
      const mafiaVotes = s.votes?.night?.mafia || {};
      const votedMafia = aliveMafiaIds.filter(id => mafiaVotes[id]);
      if (aliveMafiaIds.length > 0 && votedMafia.length !== aliveMafiaIds.length) {
        return alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ†ÙÙŠØ°: ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ (${votedMafia.length}/${aliveMafiaIds.length}).`);
      }

      let mafiaVictimId = "";
      if (aliveMafiaIds.length > 0) {
        const mTop = getTopCandidates(mafiaVotes);
        if (!mTop.candidates.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØª Ù…Ø§ÙÙŠØ§.");
        if (mTop.candidates.length > 1) {
          const r = await handleTieReset("votes/night/mafia", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ (${mTop.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
          if (r.stop) return;
          mafiaVictimId = pickFromCandidates(mTop.candidates);
        } else mafiaVictimId = mTop.candidates[0];
      }

      const docVotes = s.votes?.night?.doctor || {};
      let savedId = "";
      if (Object.keys(docVotes).length) {
        const dTop = getTopCandidates(docVotes);
        if (dTop.candidates.length > 1) {
          const r = await handleTieReset("votes/night/doctor", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ø·Ø¨ÙŠØ¨ (${dTop.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
          if (r.stop) return;
          savedId = pickFromCandidates(dTop.candidates);
        } else savedId = dTop.candidates[0] || "";
      }

      const bgVotes = s.votes?.night?.bodyguard || {};
      let protectedId = "";
      if (Object.keys(bgVotes).length) {
        const bTop = getTopCandidates(bgVotes);
        if (bTop.candidates.length > 1) {
          const r = await handleTieReset("votes/night/bodyguard", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ø­Ø§Ø±Ø³ (${bTop.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
          if (r.stop) return;
          protectedId = pickFromCandidates(bTop.candidates);
        } else protectedId = bTop.candidates[0] || "";
      }

      const skVotes = s.votes?.night?.serial || {};
      let skVictimId = "";
      if (Object.keys(skVotes).length) {
        const sTop = getTopCandidates(skVotes);
        if (sTop.candidates.length > 1) {
          const r = await handleTieReset("votes/night/serial", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ (${sTop.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
          if (r.stop) return;
          skVictimId = pickFromCandidates(sTop.candidates);
        } else skVictimId = sTop.candidates[0] || "";
      }

      // Detective results
      const detVotes = s.votes?.night?.detective || {};
      const detPairs = Object.entries(detVotes || {});
      for (const [detPid, targetId] of detPairs) {
        const t = playersObj[targetId];
        const res = t ? (t.role === "mafia" ? "ğŸŸ¥ Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù…Ø§ÙÙŠØ§" : "ğŸŸ© Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ù„ÙŠØ³ Ù…Ø§ÙÙŠØ§") : "Ø§Ù„Ù‡Ø¯Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        await SESS(hostCode).child(`private/detectiveResults/${detPid}`).set(res);
      }

      const killed = [];

      // Mafia attack
      if (mafiaVictimId && aliveObj[mafiaVictimId]) {
        if (mafiaVictimId === savedId) {
          killed.push(`ğŸ©º ØªÙ… Ø¥Ù†Ù‚Ø§Ø° ${aliveObj[mafiaVictimId].name}`);
        } else if (mafiaVictimId === protectedId) {
          const aliveBodyguards = Object.values(playersObj).filter(p => p.alive && p.role === "bodyguard");
          const bgToDie = aliveBodyguards[0];
          if (bgToDie) {
            await SESS(hostCode).child(`players/${bgToDie.id}/alive`).set(false);
            killed.push(`ğŸ›¡ï¸ Ø§Ù„Ø­Ø§Ø±Ø³ Ù…Ø§Øª Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù† ${aliveObj[mafiaVictimId].name}`);
          } else {
            await SESS(hostCode).child(`players/${mafiaVictimId}/alive`).set(false);
            killed.push(`ğŸŒ™ Ù‚ØªÙ„ Ø§Ù„Ù…Ø§ÙÙŠØ§: ${aliveObj[mafiaVictimId].name}`);
          }
        } else {
          await SESS(hostCode).child(`players/${mafiaVictimId}/alive`).set(false);
          killed.push(`ğŸŒ™ Ù‚ØªÙ„ Ø§Ù„Ù…Ø§ÙÙŠØ§: ${aliveObj[mafiaVictimId].name}`);
        }
      }

      // Serial kill
      if (skVictimId && aliveObj[skVictimId]) {
        if (skVictimId === savedId) {
          killed.push(`ğŸ©º ØªÙ… Ø¥Ù†Ù‚Ø§Ø° ${aliveObj[skVictimId].name} (Ù…Ù† Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„)`);
        } else if (skVictimId === protectedId) {
          const aliveBodyguards = Object.values(playersObj).filter(p => p.alive && p.role === "bodyguard");
          const bgToDie = aliveBodyguards[0];
          if (bgToDie) {
            await SESS(hostCode).child(`players/${bgToDie.id}/alive`).set(false);
            killed.push(`ğŸ›¡ï¸ Ø§Ù„Ø­Ø§Ø±Ø³ Ù…Ø§Øª Ø¨Ø¯Ù„Ù‹Ø§ Ø¹Ù† ${aliveObj[skVictimId].name} (Ù‡Ø¬ÙˆÙ… Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„)`);
          } else {
            await SESS(hostCode).child(`players/${skVictimId}/alive`).set(false);
            killed.push(`ğŸ”ª Ù‚ØªÙ„ Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„: ${aliveObj[skVictimId].name}`);
          }
        } else {
          await SESS(hostCode).child(`players/${skVictimId}/alive`).set(false);
          killed.push(`ğŸ”ª Ù‚ØªÙ„ Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„: ${aliveObj[skVictimId].name}`);
        }
      }

      await SESS(hostCode).child("log").set(killed.length ? killed.join(" | ") : "ğŸŒ™ Ù„Ù… ÙŠØ­Ø¯Ø« Ø´ÙŠØ¡ Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙŠÙ„Ø©.");

    } else {
      const aliveAllIds = Object.values(playersObj).filter(p => p.alive).map(p => p.id);
      const dayVotes = s.votes?.day?.public || {};
      const votedAll = aliveAllIds.filter(id => dayVotes[id]);
      if (votedAll.length !== aliveAllIds.length) return alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ†ÙÙŠØ°: ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ (${votedAll.length}/${aliveAllIds.length}).`);

      // Sniper (each sniper once)
      const sniperVotes = s.votes?.dayExtra?.sniper || {};
      const sniperPairs = Object.entries(sniperVotes || {});
      for (const [snPid, targetId] of sniperPairs) {
        const usedBy = s.config?.sniperUsedBy || {};
        if (usedBy[snPid]) continue;
        if (aliveObj[snPid]?.role !== "sniper") continue;
        if (aliveObj[targetId]) {
          await SESS(hostCode).child(`players/${targetId}/alive`).set(false);
          await SESS(hostCode).child(`config/sniperUsedBy/${snPid}`).set(true);
          await SESS(hostCode).child("log").set(`ğŸ¯ Ø§Ù„Ù‚Ù†Ø§Øµ Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨: ${aliveObj[targetId].name}`);
        }
      }

      const dTop = getTopCandidates(dayVotes);
      if (!dTop.candidates.length) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØª Ù†Ù‡Ø§Ø±.");

      let outId = dTop.candidates[0];
      if (dTop.candidates.length > 1) {
        const r = await handleTieReset("votes/day/public", `ØªØ¹Ø§Ø¯Ù„ ÙÙŠ ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± (${dTop.candidates.length} Ø®ÙŠØ§Ø±Ø§Øª).`);
        if (r.stop) return;
        outId = pickFromCandidates(dTop.candidates);
      }

      const out = aliveObj[outId];
      if (out) {
        await SESS(hostCode).child(`players/${outId}/alive`).set(false);
        if (out.role === "jester") {
          await SESS(hostCode).update({ winner: "jester", log: "ğŸ¤¡ ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ÙˆØ­Ø¯Ù‡! (ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ù‡ Ø¨Ø§Ù„ØªØµÙˆÙŠØª)" });
          alert("ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ğŸ¤¡ğŸ†");
          return;
        } else {
          await SESS(hostCode).child("log").set(`â˜€ï¸ ØªÙ… Ø¥Ù‚ØµØ§Ø¡ Ù„Ø§Ø¹Ø¨: ${out.name}`);
        }
      }
    }

    const newSnap = await SESS(hostCode).get();
    const ns = newSnap.val();
    const w = computeWinner(Object.values(ns.players || {}));
    if (w) {
      await SESS(hostCode).update({
        winner: w,
        log: w === "serial" ? "ğŸ† ÙØ§Ø² Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„!" : (w === "mafia" ? "ğŸ† ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§!" : "ğŸ† ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†!")
      });
      alert(w === "serial" ? "ÙØ§Ø² Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ ğŸ”ªğŸ†" : (w === "mafia" ? "ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ ğŸŸ¥ğŸ†" : "ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ† ğŸŸ©ğŸ†"));
    } else {
      alert("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªÙŠØ¬Ø© âœ…");
    }
  }

  // Player join
  async function joinSession(){
    const code = String(playerCode.value || "").trim();
    const name = String(playerName.value || "").trim();
    if (!/^\d{6}$/.test(code)) return alert("Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ ØµØ­ÙŠØ­ (6 Ø£Ø±Ù‚Ø§Ù…).");
    if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ.");

    const sessSnap = await SESS(code).get();
    const s = sessSnap.val();
    if (!s) return alert("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

    const wanted = normName(name);
    const existing = Object.values(s.players || {}).some(p => normName(p.name) === wanted);
    if (existing) return alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©. Ø§Ø®ØªØ± Ø§Ø³Ù…Ù‹Ø§ Ø¢Ø®Ø±.");

    const pid = rid();
    me = { mode:"player", code, pid, name };
    setMe(me);

    await SESS(code).child(`players/${pid}`).set({ id: pid, name, alive: true, role: "", joinedAt: now() });

    setScreen("player");
    joinBox.classList.add("hidden");
    playerBox.classList.remove("hidden");
    pName.textContent = name;
    pCode.textContent = code;

    subscribePlayer(code, pid);
  }

  function buildAliveOptions(playersObj, excludeId, allowSelf){
    const alive = Object.values(playersObj || {}).filter(p => p.alive && (allowSelf || p.id !== excludeId));
    return alive.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
  }

  function subscribePlayer(code, pid){
    if (playerSub) playerSub.off();
    playerSub = SESS(code);

    playerSub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      if (s.winner) {
        winnerBanner.classList.remove("hidden");
        winnerText.textContent =
          s.winner === "jester" ? "ğŸ¤¡ğŸ† ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ÙˆØ­Ø¯Ù‡!" :
          s.winner === "serial" ? "ğŸ”ªğŸ† ÙØ§Ø² Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„!" :
          s.winner === "mafia" ? "ğŸŸ¥ğŸ† ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§!" : "ğŸŸ©ğŸ† ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†!";
      } else winnerBanner.classList.add("hidden");

      const meObj = s.players?.[pid];
      if (!meObj) return;

      pPhase.textContent = s.phase === "night" ? "Ù„ÙŠÙ„ ğŸŒ™" : "Ù†Ù‡Ø§Ø± â˜€ï¸";
      pRound.textContent = String(s.round || 1);

      if (liveTally) liveTally.textContent = s.phase === "night" ? tallyText(s.votes?.night?.mafia) : tallyText(s.votes?.day?.public);

      const roleKey = meObj.role || "";
      if (!roleKey) {
        myRoleText.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±â€¦";
        myRoleHint.textContent = "Ø§Ù„Ù…Ø¯ÙŠØ± Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù‚Ø±ÙŠØ¨Ù‹Ø§.";
      } else {
        myRoleText.textContent = ROLE_UI[roleKey]?.name || roleKey;
        myRoleHint.textContent = ROLE_UI[roleKey]?.hint || "â€”";
      }

      const detRes = s.private?.detectiveResults?.[pid];
      if (detRes) { roleExtraBox.classList.remove("hidden"); roleExtraText.textContent = detRes; }
      else roleExtraBox.classList.add("hidden");

      // Vote status
      if (!meObj.alive) myVoteStatus.textContent = "âŒ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø©";
      else if (s.phase === "night") {
        const parts = [];
        if (roleKey === "mafia") parts.push(s.votes?.night?.mafia?.[pid] ? "âœ… ØµÙˆÙ‘Øª (Ù…Ø§ÙÙŠØ§)" : "â³ Ù„Ù… ØªØµÙˆÙ‘Øª (Ù…Ø§ÙÙŠØ§)");
        if (roleKey === "doctor") parts.push(s.votes?.night?.doctor?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª Ø¥Ù†Ù‚Ø§Ø°" : "â³ Ù„Ù… ØªØ®ØªØ± Ø¥Ù†Ù‚Ø§Ø°");
        if (roleKey === "detective") parts.push(s.votes?.night?.detective?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª ØªØ­Ù‚ÙŠÙ‚" : "â³ Ù„Ù… ØªØ®ØªØ± ØªØ­Ù‚ÙŠÙ‚");
        if (roleKey === "bodyguard") parts.push(s.votes?.night?.bodyguard?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª Ø­Ù…Ø§ÙŠØ©" : "â³ Ù„Ù… ØªØ®ØªØ± Ø­Ù…Ø§ÙŠØ©");
        if (roleKey === "serial") parts.push(s.votes?.night?.serial?.[pid] ? "âœ… Ø§Ø®ØªØ±Øª Ù‚ØªÙ„" : "â³ Ù„Ù… ØªØ®ØªØ± Ù‚ØªÙ„");
        myVoteStatus.textContent = parts.length ? parts.join(" | ") : "Ù„ÙŠÙ„: Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ùƒ.";
      } else {
        const v = s.votes?.day?.public?.[pid];
        let extra = "";
        if (roleKey === "sniper") {
          const used = !!s.config?.sniperUsedBy?.[pid];
          const sv = s.votes?.dayExtra?.sniper?.[pid];
          extra = used ? " | ğŸ¯ Ø§Ù„Ø·Ù„Ù‚Ø© Ù…Ø³ØªÙ‡Ù„ÙƒØ©." : (sv ? " | ğŸ¯ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù." : " | ğŸ¯ Ù„Ù… ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ù„Ù‚Ø©.");
        }
        myVoteStatus.textContent = (v ? "âœ… ØªÙ… ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø±." : "â³ Ù„Ù… ØªØµÙˆÙ‘Øª Ø¨Ø¹Ø¯.") + extra;
      }

      renderPlayerAction(s, pid, meObj, roleKey);
    });
  }

  function renderPlayerAction(s, pid, meObj, roleKey){
    const playersObj = s.players || {};
    if (!meObj.alive) { pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø© âŒ</div>`; return; }
    if (!roleKey) { pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±â€¦</div>`; return; }
    if (s.winner) { pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ</div>`; return; }

    if (s.phase === "night") {
      if (roleKey === "mafia") {
        const aliveOptions = buildAliveOptions(playersObj, pid, false);
        const already = s.votes?.night?.mafia?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ (Ù‚ØªÙ„)</div>
            <select id="selNightKill" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©</option>${aliveOptions}
            </select>
            <button id="btnNightKill" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnNightKill").addEventListener("click", async () => {
          const victimId = $("selNightKill").value || "";
          if (!victimId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©.");
          await SESS(me.code).child(`votes/night/mafia/${pid}`).set(victimId);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "doctor") {
        const aliveOptions = buildAliveOptions(playersObj, pid, true);
        const already = s.votes?.night?.doctor?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ©º Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø¥Ù†Ù‚Ø§Ø°)</div>
            <select id="selDoc" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ù…Ù† ØªÙ†Ù‚Ø°Ù‡</option>${aliveOptions}
            </select>
            <button id="btnDoc" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-emerald-600 hover:bg-emerald-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnDoc").addEventListener("click", async () => {
          const t = $("selDoc").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨.");
          await SESS(me.code).child(`votes/night/doctor/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "detective") {
        const aliveOptions = buildAliveOptions(playersObj, pid, false);
        const already = s.votes?.night?.detective?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ” Ø§Ù„Ù…Ø­Ù‚Ù‚ (ØªØ­Ù‚ÙŠÙ‚)</div>
            <select id="selDet" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù</option>${aliveOptions}
            </select>
            <button id="btnDet" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-sky-600 hover:bg-sky-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnDet").addEventListener("click", async () => {
          const t = $("selDet").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ù‡Ø¯Ù.");
          await SESS(me.code).child(`votes/night/detective/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "bodyguard") {
        const aliveOptions = buildAliveOptions(playersObj, pid, true);
        const already = s.votes?.night?.bodyguard?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ›¡ï¸ Ø§Ù„Ø­Ø§Ø±Ø³ (Ø­Ù…Ø§ÙŠØ©)</div>
            <select id="selBg" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ù…Ù† ØªØ­Ù…ÙŠÙ‡</option>${aliveOptions}
            </select>
            <button id="btnBg" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-indigo-600 hover:bg-indigo-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnBg").addEventListener("click", async () => {
          const t = $("selBg").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨.");
          await SESS(me.code).child(`votes/night/bodyguard/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      if (roleKey === "serial") {
        const aliveOptions = buildAliveOptions(playersObj, pid, false);
        const already = s.votes?.night?.serial?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ (Ù‚ØªÙ„)</div>
            <select id="selSk" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©</option>${aliveOptions}
            </select>
            <button id="btnSk" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„"}
            </button>
          </div>`;
        if (!already) $("btnSk").addEventListener("click", async () => {
          const t = $("selSk").value || "";
          if (!t) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©.");
          await SESS(me.code).child(`votes/night/serial/${pid}`).set(t);
          alert("ØªÙ… âœ…");
        });
        return;
      }

      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ù„ÙŠÙ„â€¦ Ø§Ù†ØªØ¸Ø±.</div>`;
      return;
    }

    // Day
    const aliveOptionsNoSelf = buildAliveOptions(playersObj, pid, false);
    const dayAlready = s.votes?.day?.public?.[pid];
    const sniperVote = s.votes?.dayExtra?.sniper?.[pid];
    const used = !!s.config?.sniperUsedBy?.[pid];
    const sniperDisabled = used || !!sniperVote;

    pActionBox.innerHTML = `
      <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
        <div class="font-extrabold text-lg">ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± (Ø¥Ù‚ØµØ§Ø¡)</div>
        <select id="selDayVote" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${dayAlready ? "disabled" : ""}>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</option>${aliveOptionsNoSelf}
        </select>
        <button id="btnDayVote" class="tap w-full px-4 py-4 rounded-3xl ${dayAlready ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-amber-600 hover:bg-amber-500"} font-extrabold" ${dayAlready ? "disabled" : ""}>
          ${dayAlready ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª"}
        </button>
      </div>
      ${roleKey === "sniper" ? `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ğŸ¯ Ø§Ù„Ù‚Ù†Ø§Øµ</div>
            <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">
              ${used ? "Ù…Ø³ØªØ®Ø¯Ù…" : (sniperVote ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ù…ØªØ§Ø­")}
            </div>
          </div>
          <select id="selSniper" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${sniperDisabled ? "disabled" : ""}>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù</option>${aliveOptionsNoSelf}
          </select>
          <button id="btnSniper" class="tap w-full px-4 py-4 rounded-3xl ${sniperDisabled ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${sniperDisabled ? "disabled" : ""}>
            ${used ? "ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ù„Ù‚Ø©" : (sniperVote ? "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù" : "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù (Ø³Ø±ÙŠ)")}
          </button>
        </div>
      ` : "" }
    `;

    if (!dayAlready) $("btnDayVote").addEventListener("click", async () => {
      const targetId = $("selDayVote").value || "";
      if (!targetId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ.");
      await SESS(me.code).child(`votes/day/public/${pid}`).set(targetId);
      alert("ØªÙ… âœ…");
    });

    if (roleKey === "sniper" && !sniperDisabled) $("btnSniper").addEventListener("click", async () => {
      const targetId = $("selSniper").value || "";
      if (!targetId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù.");
      await SESS(me.code).child(`votes/dayExtra/sniper/${pid}`).set(targetId);
      alert("ØªÙ… âœ…");
    });
  }

  // Controls
  btnToggleRole.addEventListener("click", () => myRoleCard.classList.toggle("hidden"));
  btnCopyShare.addEventListener("click", () => {
    if (me?.mode === "host" && hostCode) return shareLink(hostCode);
    if (me?.mode === "player" && me?.code) return shareLink(me.code);
  });
  btnResetLocal.addEventListener("click", () => { clearMe(); location.href = location.pathname; });

  btnTimerStart?.addEventListener("click", () => hostCode && timerStart(hostCode));
  btnTimerStop?.addEventListener("click", () => hostCode && timerStop(hostCode));
  btnTimerReset?.addEventListener("click", () => hostCode && timerReset(hostCode));

  hostTieMode?.addEventListener("change", async () => { if (!hostCode) return; await SESS(hostCode).child("config/tieMode").set(String(hostTieMode.value || "revote")); });

  btnGoHost.addEventListener("click", createSession);
  btnGoPlayer.addEventListener("click", () => setScreen("player"));
  btnCopyJoin.addEventListener("click", () => hostCode && shareLink(hostCode));
  btnHostLockAndAssign.addEventListener("click", lockAndAssign);
  btnHostTogglePhase.addEventListener("click", togglePhase);
  btnHostResolve.addEventListener("click", resolvePhase);
  btnPlayerJoin.addEventListener("click", joinSession);
  btnBackMode1.addEventListener("click", () => { clearMe(); setScreen("mode"); });
  btnBackMode2.addEventListener("click", () => { clearMe(); setScreen("mode"); });

  setInterval(() => {
    if (me?.mode === "host" && hostCode && hostTimerText) {
      SESS(hostCode).child("config/timer").get().then(snap => {
        const t = snap.val() || { running:false, endAt:0 };
        hostTimerText.textContent = t.running ? fmtLeft((t.endAt||0) - now()) : "Ù…ØªÙˆÙ‚Ù";
      }).catch(()=>{});
    }
  }, 1000);

  // Resume
  if (me?.mode === "host" && me?.code) {
    hostCode = me.code; hostCodeEl.textContent = hostCode; setScreen("host"); subscribeHost(hostCode);
  } else if (me?.mode === "player" && me?.code && me?.pid) {
    setScreen("player"); joinBox.classList.add("hidden"); playerBox.classList.remove("hidden");
    pName.textContent = me.name; pCode.textContent = me.code; subscribePlayer(me.code, me.pid);
  } else setScreen("mode");
})();
</script>
</body>
</html>
