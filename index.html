<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ù…Ø§ÙÙŠØ§ â€” Ø¬Ù„Ø³Ø© Ù…Ø´ØªØ±ÙƒØ©</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <style>
    body { padding-bottom: env(safe-area-inset-bottom); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <header class="sticky top-0 z-40 bg-slate-950/80 glass border-b border-slate-800">
    <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="text-lg font-extrabold">ğŸ•µï¸â€â™‚ï¸ Ù…Ø§ÙÙŠØ§</div>
        <div id="badgeMini" class="hidden text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">â€”</div>
      </div>
      <div class="flex gap-2">
        <button id="btnCopyShare" class="hidden tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          Ù…Ø´Ø§Ø±ÙƒØ©
        </button>
        <button id="btnResetLocal" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
          Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-md mx-auto px-4 py-5 space-y-4">

    <!-- Ø´Ø§Ø´Ø© Ø§Ø®ØªÙŠØ§Ø± -->
    <section id="screenMode" class="space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 shadow">
        <h1 class="text-2xl font-extrabold">Ø¬Ù„Ø³Ø© Ù…Ø´ØªØ±ÙƒØ©</h1>
        <p class="text-slate-300 text-sm mt-2 leading-6">
          <span class="font-bold text-slate-100">Ø§Ù„Ù…Ø¯ÙŠØ±:</span> Ø£Ù†Øª ÙÙ‚Ø· ØªØ¯ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø­Ù„ ÙˆØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (Ø¨Ø¯ÙˆÙ† Ø±Ø¤ÙŠØ© Ø§Ù„Ø£Ø¯ÙˆØ§Ø±).<br>
          <span class="font-bold text-slate-100">Ø§Ù„Ù„Ø§Ø¹Ø¨:</span> ÙƒÙ„ Ø´Ø®Øµ ÙŠØ¯Ø®Ù„ Ù…Ù† Ø¬ÙˆØ§Ù„Ù‡ ÙˆÙŠØ´ÙˆÙ Ø¯ÙˆØ±Ù‡ ÙÙ‚Ø· ÙˆÙŠØµÙˆÙ‘Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©.
        </p>
      </div>

      <button id="btnGoHost" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
        Ø£Ù†Ø§ Ø§Ù„Ù…Ø¯ÙŠØ± (Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø©)
      </button>

      <button id="btnGoPlayer" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
        Ø£Ù†Ø§ Ù„Ø§Ø¹Ø¨ (Ø¯Ø®ÙˆÙ„ Ø¬Ù„Ø³Ø©)
      </button>

      <div class="text-xs text-slate-400 text-center">
        ØªÙ„Ù…ÙŠØ­: ØªÙ‚Ø¯Ø± ØªØ±Ø³Ù„ â€œØ±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„â€ Ø¨Ø¯Ù„ Ø§Ù„ÙƒÙˆØ¯.
      </div>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <section id="screenHost" class="hidden space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xs text-slate-300">ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©</div>
            <div id="hostCode" class="text-4xl font-extrabold tracking-widest mt-1">â€”</div>
            <div class="text-sm text-slate-300 mt-2">Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ø¶ØºØ· â€œÙ…Ø´Ø§Ø±ÙƒØ©â€ Ù„Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø¯Ø®ÙˆÙ„ Ø¬Ø§Ù‡Ø².</div>
          </div>
          <button id="btnCopyJoin" class="tap px-4 py-3 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">
            Ù†Ø³Ø®
          </button>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù„Ø³Ø©</div>
            <div id="hostStatus" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
            <div id="hostCount" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
        </div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="font-extrabold text-lg">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-300">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ÙÙŠØ§</label>
            <input id="hostMafia" type="number" min="1" value="1"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</div>
            <div class="text-sm text-slate-200 mt-1">ğŸ¯ Ù‚Ù†Ø§Øµ (1)</div>
            <div class="text-sm text-slate-200">ğŸ¤¡ Ù…Ù‡Ø±Ù‘Ø¬ (1)</div>
          </div>
        </div>

        <button id="btnHostLockAndAssign" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          Ù‚ÙÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† + ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
        </button>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</div>
            <div class="text-xs text-slate-400">Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù…Ø®ÙÙŠØ©</div>
          </div>
          <div id="hostPlayers" class="mt-3 space-y-2"></div>
        </div>
      </div>

      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-xs text-slate-300">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
            <div id="hostPhase" class="text-2xl font-extrabold">â€”</div>
          </div>
          <div class="text-right">
            <div class="text-xs text-slate-300">Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
            <div id="hostRound" class="text-2xl font-extrabold">â€”</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <button id="btnHostTogglePhase" class="tap px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold">
            ØªØ¨Ø¯ÙŠÙ„ Ù„ÙŠÙ„/Ù†Ù‡Ø§Ø±
          </button>
          <button id="btnHostResolve" class="tap px-4 py-4 rounded-3xl bg-amber-600 hover:bg-amber-500 font-extrabold">
            ØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªÙŠØ¬Ø©
          </button>
        </div>

        <!-- Timer -->
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">â±ï¸ Ù…Ø¤Ù‚Øª Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
            <div id="hostTimerText" class="text-lg font-extrabold">â€”</div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="text-xs text-slate-300">Ø§Ù„Ù…Ø¯Ø© (Ø«Ø§Ù†ÙŠØ©)</label>
              <input id="hostPhaseSeconds" type="number" min="15" value="120"
                class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
            </div>
            <div class="rounded-2xl border border-slate-800 bg-slate-900/50 p-3 text-xs text-slate-300 leading-6">
              Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø¤Ù‚Øª Ø«Ù… Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¦Ù‡ Ù†ÙÙ‘Ø° Ø§Ù„Ù†ØªÙŠØ¬Ø©. (Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ø§ ÙŠÙ†ÙÙ‘Ø° ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø­ÙØ§Ø¸Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ÙƒÙ…)
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <button id="btnTimerStart" class="tap px-4 py-4 rounded-2xl bg-emerald-600 hover:bg-emerald-500 font-extrabold">Ø¨Ø¯Ø¡</button>
            <button id="btnTimerStop" class="tap px-4 py-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">Ø¥ÙŠÙ‚Ø§Ù</button>
            <button id="btnTimerReset" class="tap px-4 py-4 rounded-2xl bg-slate-800 hover:bg-slate-700 border border-slate-700 font-bold">Ø¥Ø¹Ø§Ø¯Ø©</button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª</div>
            <div id="hostVoteInfo" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="text-xs text-slate-300">Ø§Ù„ÙØ§Ø¦Ø²</div>
            <div id="hostWinner" class="text-lg font-extrabold mt-1">â€”</div>
          </div>
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
          <div class="font-extrabold">Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©</div>
          <div id="hostLog" class="mt-1 text-slate-300 text-sm leading-6">â€”</div>
        </div>
      </div>

      <button id="btnBackMode1" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
        Ø±Ø¬ÙˆØ¹
      </button>
    </section>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
    <section id="screenPlayer" class="hidden space-y-4">
      <div id="joinBox" class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">Ø¯Ø®ÙˆÙ„ Ø¬Ù„Ø³Ø©</h2>

        <label class="text-sm text-slate-300">ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù„Ø³Ø©</label>
        <input id="playerCode" placeholder="Ù…Ø«Ø§Ù„: 482913"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <label class="text-sm text-slate-300">Ø§Ø³Ù…Ùƒ</label>
        <input id="playerName" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <button id="btnPlayerJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
          Ø¯Ø®ÙˆÙ„
        </button>

        <div class="text-xs text-slate-400">Ø¨Ø¹Ø¯ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø³ÙŠØ¸Ù‡Ø± Ø¯ÙˆØ±Ùƒ Ø£Ù†Øª ÙÙ‚Ø·.</div>
      </div>

      <div id="playerBox" class="hidden space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="text-xs text-slate-300">Ø£Ù†Øª Ø¯Ø§Ø®Ù„ Ø¬Ù„Ø³Ø©</div>
          <div class="text-2xl font-extrabold mt-1">
            <span id="pName">â€”</span> Â· <span class="tracking-widest" id="pCode">â€”</span>
          </div>

          <div class="mt-3 rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-xs text-slate-300">Ø§Ù„Ù…Ø±Ø­Ù„Ø©</div>
                <div id="pPhase" class="text-2xl font-extrabold mt-1">â€”</div>
              </div>
              <div class="text-right">
                <div class="text-xs text-slate-300">Ø§Ù„Ø¬ÙˆÙ„Ø©</div>
                <div id="pRound" class="text-2xl font-extrabold mt-1">â€”</div>
              </div>
            </div>
          </div>

          <div id="winnerBanner" class="hidden mt-3 rounded-2xl border border-amber-700 bg-amber-900/20 p-3">
            <div class="font-extrabold" id="winnerText">â€”</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Ø¯ÙˆØ±Ùƒ</div>
            <button id="btnToggleRole" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
              Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡
            </button>
          </div>

          <div id="myRoleCard" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
            <div id="myRoleText" class="text-3xl font-extrabold">â€”</div>
            <div id="myRoleHint" class="text-sm text-slate-300 mt-2 leading-6">â€”</div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">ØªØµÙˆÙŠØªÙƒ</div>
            <div id="myVoteStatus" class="text-sm text-slate-300 mt-1">â€”</div>
          </div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</div>
            <div class="text-xs text-slate-400">ğŸ“Š <span id="liveTally">â€”</span></div>
          </div>
          <div id="pActionBox" class="mt-3 space-y-3"></div>
        </div>

        <button id="btnBackMode2" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          Ø±Ø¬ÙˆØ¹
        </button>
      </div>
    </section>
  </main>

<script>
(() => {
  // âœ… Firebase config (Ù…Ù† Ø¹Ù†Ø¯Ùƒ)
  const firebaseConfig = {
    apiKey: "AIzaSyC4YdqgiAfJmRmvkLH4wspzclAzKs3wyLw",
    authDomain: "mafia-game-7e488.firebaseapp.com",
    databaseURL: "https://mafia-game-7e488-default-rtdb.firebaseio.com",
    projectId: "mafia-game-7e488",
    storageBucket: "mafia-game-7e488.firebasestorage.app",
    messagingSenderId: "513186840934",
    appId: "1:513186840934:web:ccf858b27cea91be1448a7"
  };

  const $ = (id) => document.getElementById(id);
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Helpers
  const rid = () => (crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint32Array(2))].map(x=>x.toString(16)).join("") : String(Math.random()).slice(2));
  const now = () => Date.now();
  const code6 = () => String(Math.floor(100000 + Math.random() * 900000));
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const shuffle = (arr) => {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  };

  function fmtLeft(ms){
    const s = Math.max(0, Math.ceil(ms / 1000));
    const m = Math.floor(s / 60);
    const r = s % 60;
    return m > 0 ? `${m}:${String(r).padStart(2,"0")}` : `${r}s`;
  }
  function tallyText(votesObj){
    const tally = {};
    Object.values(votesObj || {}).forEach(id => {
      if (!id) return;
      tally[id] = (tally[id] || 0) + 1;
    });
    const total = Object.keys(votesObj || {}).length;
    const arr = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
    if (total === 0) return "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆØ§Øª Ø¨Ø¹Ø¯.";
    const top = arr.length ? arr[0][1] : 0;
    return `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${total} ØµÙˆØª. Ø£Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ø¹Ù„ÙŠÙ‡ ${top} ØµÙˆØª.`;
  }

  const LS_KEY = "mafia_identity_v3";
  const getMe = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; } };
  const setMe = (o) => localStorage.setItem(LS_KEY, JSON.stringify(o));
  const clearMe = () => localStorage.removeItem(LS_KEY);

  const SESS = (code) => db.ref(`sessions/${code}`);

  // UI
  const badgeMini = $("badgeMini");
  const btnCopyShare = $("btnCopyShare");
  const btnResetLocal = $("btnResetLocal");

  const screenMode = $("screenMode");
  const screenHost = $("screenHost");
  const screenPlayer = $("screenPlayer");

  const btnGoHost = $("btnGoHost");
  const btnGoPlayer = $("btnGoPlayer");

  // Host
  const hostCodeEl = $("hostCode");
  const btnCopyJoin = $("btnCopyJoin");
  const hostStatus = $("hostStatus");
  const hostCount = $("hostCount");
  const hostMafia = $("hostMafia");
  const btnHostLockAndAssign = $("btnHostLockAndAssign");
  const hostPlayers = $("hostPlayers");
  const hostPhase = $("hostPhase");
  const hostRound = $("hostRound");
  const btnHostTogglePhase = $("btnHostTogglePhase");
  const btnHostResolve = $("btnHostResolve");
  const hostVoteInfo = $("hostVoteInfo");
  const hostWinner = $("hostWinner");
  const hostLog = $("hostLog");
  const btnBackMode1 = $("btnBackMode1");

  // Timer host UI
  const hostTimerText = $("hostTimerText");
  const hostPhaseSeconds = $("hostPhaseSeconds");
  const btnTimerStart = $("btnTimerStart");
  const btnTimerStop = $("btnTimerStop");
  const btnTimerReset = $("btnTimerReset");

  // Player
  const joinBox = $("joinBox");
  const playerBox = $("playerBox");
  const playerCode = $("playerCode");
  const playerName = $("playerName");
  const btnPlayerJoin = $("btnPlayerJoin");
  const pName = $("pName");
  const pCode = $("pCode");
  const pPhase = $("pPhase");
  const pRound = $("pRound");
  const winnerBanner = $("winnerBanner");
  const winnerText = $("winnerText");
  const btnToggleRole = $("btnToggleRole");
  const myRoleCard = $("myRoleCard");
  const myRoleText = $("myRoleText");
  const myRoleHint = $("myRoleHint");
  const myVoteStatus = $("myVoteStatus");
  const liveTally = $("liveTally");
  const pActionBox = $("pActionBox");
  const btnBackMode2 = $("btnBackMode2");

  // Role names/hints
  const ROLE_UI = {
    mafia: { name:"Ù…Ø§ÙÙŠØ§", hint:"Ø¨Ø§Ù„Ù„ÙŠÙ„: ØµÙˆÙ‘Øª Ù„Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨. Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±: Ø­Ø§ÙˆÙ„ Ù…Ø§ ØªÙ†ÙƒØ´Ù." },
    citizen: { name:"Ù…ÙˆØ§Ø·Ù†", hint:"Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±: ØµÙˆÙ‘Øª ØµØ­. Ø¨Ø§Ù„Ù„ÙŠÙ„: Ø§Ù†ØªØ¸Ø±." },
    sniper: { name:"Ù‚Ù†Ø§Øµ", hint:"ğŸ¯ Ø·Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø·ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø±). Ø§Ø®ØªØ± Ø§Ù„Ù‡Ø¯Ù Ø¨Ø¹Ù†Ø§ÙŠØ©." },
    jester: { name:"Ù…Ù‡Ø±Ù‘Ø¬", hint:"ğŸ¤¡ Ù‡Ø¯ÙÙƒ ÙŠØªÙ… Ø¥Ù‚ØµØ§Ø¤Ùƒ Ø¨Ø§Ù„ØªØµÙˆÙŠØª ÙÙŠ Ø§Ù„Ù†Ù‡Ø§Ø± Ù„ØªÙÙˆØ² ÙˆØ­Ø¯Ùƒ ÙÙˆØ±Ù‹Ø§." },
  };

  // State
  let hostCode = null;
  let hostSub = null;
  let playerSub = null;
  let me = getMe(); // {mode:"host"|"player", code, pid, name}

  // Screen
  function setScreen(which){
    screenMode.classList.add("hidden");
    screenHost.classList.add("hidden");
    screenPlayer.classList.add("hidden");
    btnCopyShare.classList.add("hidden");
    badgeMini.classList.add("hidden");

    if (which === "mode") screenMode.classList.remove("hidden");
    if (which === "host") {
      screenHost.classList.remove("hidden");
      btnCopyShare.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = "Ù…Ø¯ÙŠØ±";
    }
    if (which === "player") {
      screenPlayer.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = "Ù„Ø§Ø¹Ø¨";
    }
  }

  function shareLink(code){
    const url = `${location.origin}${location.pathname}?code=${code}`;
    navigator.clipboard?.writeText(url);
    alert("ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø®ÙˆÙ„.");
  }

  // URL join ?code=
  const urlParams = new URLSearchParams(location.search);
  const preCode = urlParams.get("code");
  if (preCode && !me) {
    setScreen("player");
    playerCode.value = preCode;
  }

  // ---------------- Timer actions ----------------
  async function timerStart(code){
    const seconds = Math.max(15, Number(hostPhaseSeconds?.value || 120));
    await SESS(code).update({
      "config/phaseSeconds": seconds,
      "config/timer": { running: true, endAt: now() + seconds * 1000 }
    });
  }
  async function timerStop(code){
    await SESS(code).update({ "config/timer": { running: false, endAt: 0 } });
  }
  async function timerReset(code){
    const snap = await SESS(code).get();
    const s = snap.val();
    const seconds = Math.max(15, Number(s?.config?.phaseSeconds || 120));
    await SESS(code).update({ "config/timer": { running: false, endAt: now() + seconds * 1000 } });
  }

  // ---------------- HOST ----------------
  async function createSession(){
    const code = code6();
    hostCode = code;

    await SESS(code).set({
      code,
      createdAt: now(),
      status: "lobby",      // lobby | playing
      phase: "night",       // night | day
      round: 1,
      config: {
        mafiaCount: 1,
        sniperCount: 1,
        jesterCount: 1,
        sniperUsed: false,
        phaseSeconds: 120,
        timer: { running: false, endAt: 0 }
      },
      winner: "",           // "", "mafia", "citizens", "jester"
      log: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©.",
      votes: { night:{mafia:{}}, day:{public:{}}, dayExtra:{sniper:{}} }
    });
    await SESS(code).child("players").set({});

    me = { mode:"host", code };
    setMe(me);

    hostCodeEl.textContent = code;
    setScreen("host");
    subscribeHost(code);
  }

  function computeWinner(players){
    const alive = players.filter(p => p.alive);
    const mafiaAlive = alive.filter(p => p.role === "mafia").length;
    const others = alive.length - mafiaAlive;
    if (mafiaAlive === 0) return "citizens";
    if (mafiaAlive >= others) return "mafia";
    return "";
  }

  function subscribeHost(code){
    if (hostSub) hostSub.off();
    hostSub = SESS(code);

    hostSub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      hostStatus.textContent = s.status === "lobby" ? "Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†" : "Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©";
      hostPhase.textContent = s.phase === "night" ? "Ù„ÙŠÙ„ ğŸŒ™" : "Ù†Ù‡Ø§Ø± â˜€ï¸";
      hostRound.textContent = String(s.round || 1);
      hostLog.textContent = s.log || "â€”";
      hostWinner.textContent = s.winner ? (s.winner === "jester" ? "ğŸ¤¡ Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬" : s.winner === "mafia" ? "ğŸŸ¥ Ø§Ù„Ù…Ø§ÙÙŠØ§" : "ğŸŸ© Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†") : "â€”";

      if (hostPhaseSeconds) hostPhaseSeconds.value = String(s.config?.phaseSeconds || 120);

      // Timer text
      const t = s.config?.timer || { running:false, endAt:0 };
      if (hostTimerText) {
        hostTimerText.textContent = t.running ? fmtLeft((t.endAt || 0) - now()) : "Ù…ØªÙˆÙ‚Ù";
      }

      // players list (roles hidden)
      const playersObj = s.players || {};
      const players = Object.values(playersObj);
      hostCount.textContent = String(players.length || 0);

      hostPlayers.innerHTML = "";
      if (players.length === 0) {
        hostPlayers.innerHTML = `<div class="text-slate-400 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¨Ø¹Ø¯.</div>`;
      } else {
        players.forEach(p => {
          hostPlayers.innerHTML += `
            <div class="flex items-center justify-between rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
              <div class="font-bold">${escapeHtml(p.name)}</div>
              <div class="text-xs px-2 py-1 rounded-xl border ${p.alive ? "border-emerald-700 bg-emerald-900/30 text-emerald-200" : "border-rose-800 bg-rose-900/20 text-rose-200"}">
                ${p.alive ? "Ø­ÙŠ" : "Ù…ÙŠØª"}
              </div>
            </div>
          `;
        });
      }

      // vote completion info (counts only, but strict completeness enforced on resolve)
      const aliveAll = players.filter(x => x.alive);
      const aliveMafia = aliveAll.filter(x => x.role === "mafia");
      if (s.phase === "night") {
        const mv = s.votes?.night?.mafia || {};
        hostVoteInfo.textContent = `${Object.keys(mv).length}/${Math.max(1, aliveMafia.length)} (Ù…Ø§ÙÙŠØ§)`;
      } else {
        const dv = s.votes?.day?.public || {};
        hostVoteInfo.textContent = `${Object.keys(dv).length}/${Math.max(1, aliveAll.length)} (Ù†Ù‡Ø§Ø±)`;
      }
    });
  }

  async function lockAndAssign(){
    if (!hostCode) return;

    const snap = await SESS(hostCode).get();
    const s = snap.val();
    const playersObj = s?.players || {};
    const players = Object.values(playersObj);

    if (players.length < 5) return alert("Ù„Ø§Ø²Ù… 5 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.");

    const mafiaCount = Math.max(1, Number(hostMafia.value || 1));
    await SESS(hostCode).child("config/mafiaCount").set(mafiaCount);

    // Roles: mafia + sniper(1) + jester(1) + rest citizens
    const roles = [];
    for (let i=0;i<mafiaCount;i++) roles.push("mafia");
    roles.push("sniper");
    roles.push("jester");

    if (roles.length > players.length) return alert("Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø£ÙƒØ¨Ø± Ù…Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.");

    while (roles.length < players.length) roles.push("citizen");

    const rolesShuffled = shuffle(roles);
    const playersShuffled = shuffle(players);

    const updates = {};
    playersShuffled.forEach((p, idx) => {
      updates[`players/${p.id}/role`] = rolesShuffled[idx];
      updates[`players/${p.id}/alive`] = true;
      updates[`players/${p.id}/joinedAt`] = p.joinedAt || now();
    });

    updates["status"] = "playing";
    updates["phase"] = "night";
    updates["round"] = 1;
    updates["winner"] = "";
    updates["config/sniperUsed"] = false;
    updates["config/timer"] = { running:false, endAt:0 };
    updates["votes"] = { night:{mafia:{}}, day:{public:{}}, dayExtra:{sniper:{}} };
    updates["log"] = "ØªÙ… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±. Ø¨Ø¯Ø£Øª Ø§Ù„Ù„Ø¹Ø¨Ø©: Ù„ÙŠÙ„ ğŸŒ™ (ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§).";

    await SESS(hostCode).update(updates);
    alert("ØªÙ… Ø§Ù„ØªÙˆØ²ÙŠØ¹ âœ… Ø§Ù„Ø¢Ù† Ø§Ù„Ù…Ø§ÙÙŠØ§ ØªØµÙˆÙ‘Øª Ù…Ù† Ø¬ÙˆØ§Ù„Ø§ØªÙ‡Ù….");
  }

  async function togglePhase(){
    if (!hostCode) return;
    const snap = await SESS(hostCode).get();
    const s = snap.val();
    if (!s || s.winner) return alert("Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù†ØªÙ‡ÙŠØ©.");

    const next = s.phase === "night" ? "day" : "night";
    const nextRound = next === "night" ? (Number(s.round||1)+1) : Number(s.round||1);

    await SESS(hostCode).update({
      phase: next,
      round: nextRound,
      votes: { night:{mafia:{}}, day:{public:{}}, dayExtra:{sniper:{}} },
      "config/timer": { running:false, endAt:0 },
      log: `ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ${next === "night" ? "Ù„ÙŠÙ„ ğŸŒ™" : "Ù†Ù‡Ø§Ø± â˜€ï¸"} (Ø§Ù„Ø¬ÙˆÙ„Ø© ${nextRound}).`
    });
  }

  async function resolvePhase(){
    if (!hostCode) return;

    const snap = await SESS(hostCode).get();
    const s = snap.val();
    if (!s || s.status !== "playing") return alert("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ø¬Ø§Ù‡Ø²Ø©.");
    if (s.winner) return alert("Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù†ØªÙ‡ÙŠØ©.");

    const playersObj = s.players || {};
    const players = Object.values(playersObj);
    const aliveObj = Object.fromEntries(players.filter(p => p.alive).map(p => [p.id, p]));

    const topVoted = (votes) => {
      const tally = {};
      Object.values(votes || {}).forEach(id => {
        if (!id) return;
        tally[id] = (tally[id] || 0) + 1;
      });
      return Object.entries(tally).sort((a,b)=>b[1]-a[1])[0]?.[0] || "";
    };

    if (s.phase === "night") {
      // Ø´Ø±Ø· Ø§ÙƒØªÙ…Ø§Ù„ ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ Ø§Ù„Ø£Ø­ÙŠØ§Ø¡
      const aliveMafiaIds = Object.values(playersObj).filter(p => p.alive && p.role === "mafia").map(p => p.id);
      const mafiaVotes = s.votes?.night?.mafia || {};
      const votedMafia = aliveMafiaIds.filter(id => mafiaVotes[id]);
      if (votedMafia.length !== aliveMafiaIds.length) {
        return alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ†ÙÙŠØ°: ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ (${votedMafia.length}/${aliveMafiaIds.length}).`);
      }

      const victimId = topVoted(mafiaVotes);
      if (!victimId) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØª Ù…Ø§ÙÙŠØ§ ÙƒØ§ÙÙŠ.");

      if (aliveObj[victimId]) {
        await SESS(hostCode).child(`players/${victimId}/alive`).set(false);
        await SESS(hostCode).child("log").set(`Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„ÙŠÙ„: ØªÙ… Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨: ${aliveObj[victimId].name}`);
      }
    } else {
      // Ø´Ø±Ø· Ø§ÙƒØªÙ…Ø§Ù„ ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± Ù„Ù„Ø£Ø­ÙŠØ§Ø¡
      const aliveAllIds = Object.values(playersObj).filter(p => p.alive).map(p => p.id);
      const dayVotes = s.votes?.day?.public || {};
      const votedAll = aliveAllIds.filter(id => dayVotes[id]);
      if (votedAll.length !== aliveAllIds.length) {
        return alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ†ÙÙŠØ°: ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± ØºÙŠØ± Ù…ÙƒØªÙ…Ù„ (${votedAll.length}/${aliveAllIds.length}).`);
      }

      // ØªÙ†ÙÙŠØ° Ø§Ù„Ù‚Ù†Ø§Øµ (Ø¥Ù† ÙˆÙØ¬Ø¯ ØªØµÙˆÙŠØª) Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø·ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
      const sniperVotes = s.votes?.dayExtra?.sniper || {};
      const sniperTargetId = topVoted(sniperVotes);

      if (sniperTargetId && !s.config?.sniperUsed && aliveObj[sniperTargetId]) {
        await SESS(hostCode).child(`players/${sniperTargetId}/alive`).set(false);
        await SESS(hostCode).child("config/sniperUsed").set(true);
        await SESS(hostCode).child("log").set(`ğŸ¯ Ø§Ù„Ù‚Ù†Ø§Øµ Ù‚ØªÙ„ Ù„Ø§Ø¹Ø¨: ${aliveObj[sniperTargetId].name}`);
      }

      // ØªÙ†ÙÙŠØ° ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø±
      const outId = topVoted(dayVotes);
      if (!outId) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØª Ù†Ù‡Ø§Ø± ÙƒØ§ÙÙŠ.");

      const out = aliveObj[outId];
      if (out) {
        await SESS(hostCode).child(`players/${outId}/alive`).set(false);

        if (out.role === "jester") {
          await SESS(hostCode).update({
            winner: "jester",
            log: "ğŸ¤¡ ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ÙˆØ­Ø¯Ù‡! (ØªÙ… Ø¥Ù‚ØµØ§Ø¤Ù‡ Ø¨Ø§Ù„ØªØµÙˆÙŠØª)"
          });
          alert("ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ğŸ¤¡ğŸ†");
          return;
        } else {
          await SESS(hostCode).child("log").set(`Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø±: ØªÙ… Ø¥Ù‚ØµØ§Ø¡ Ù„Ø§Ø¹Ø¨: ${out.name}`);
        }
      }
    }

    // Winner check
    const newSnap = await SESS(hostCode).get();
    const ns = newSnap.val();
    const w = computeWinner(Object.values(ns.players || {}));
    if (w) {
      await SESS(hostCode).update({
        winner: w,
        log: w === "mafia" ? "ğŸ† ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§!" : "ğŸ† ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†!"
      });
      alert(w === "mafia" ? "ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§ ğŸŸ¥ğŸ†" : "ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ† ğŸŸ©ğŸ†");
    } else {
      alert("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªÙŠØ¬Ø© âœ…");
    }
  }

  // ---------------- PLAYER ----------------
  async function joinSession(){
    const code = String(playerCode.value || "").trim();
    const name = String(playerName.value || "").trim();
    if (!/^\d{6}$/.test(code)) return alert("Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ ØµØ­ÙŠØ­ (6 Ø£Ø±Ù‚Ø§Ù…).");
    if (!name) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ.");

    const sessSnap = await SESS(code).get();
    const s = sessSnap.val();
    if (!s) return alert("Ø§Ù„Ø¬Ù„Ø³Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");

    const pid = rid();
    me = { mode:"player", code, pid, name };
    setMe(me);

    await SESS(code).child(`players/${pid}`).set({
      id: pid,
      name,
      alive: true,
      role: "",
      joinedAt: now()
    });

    setScreen("player");
    joinBox.classList.add("hidden");
    playerBox.classList.remove("hidden");
    pName.textContent = name;
    pCode.textContent = code;

    subscribePlayer(code, pid);
  }

  function subscribePlayer(code, pid){
    if (playerSub) playerSub.off();
    playerSub = SESS(code);

    playerSub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      // winner banner for all
      if (s.winner) {
        winnerBanner.classList.remove("hidden");
        winnerText.textContent = s.winner === "jester" ? "ğŸ¤¡ğŸ† ÙØ§Ø² Ø§Ù„Ù…Ù‡Ø±Ù‘Ø¬ ÙˆØ­Ø¯Ù‡!" :
                                 s.winner === "mafia" ? "ğŸŸ¥ğŸ† ÙØ§Ø²Øª Ø§Ù„Ù…Ø§ÙÙŠØ§!" : "ğŸŸ©ğŸ† ÙØ§Ø² Ø§Ù„Ù…ÙˆØ§Ø·Ù†ÙˆÙ†!";
      } else {
        winnerBanner.classList.add("hidden");
      }

      const meObj = s.players?.[pid];
      if (!meObj) return;

      pPhase.textContent = s.phase === "night" ? "Ù„ÙŠÙ„ ğŸŒ™" : "Ù†Ù‡Ø§Ø± â˜€ï¸";
      pRound.textContent = String(s.round || 1);

      // Live tally (no names)
      if (liveTally) {
        if (s.phase === "night") liveTally.textContent = tallyText(s.votes?.night?.mafia);
        else liveTally.textContent = tallyText(s.votes?.day?.public);
      }

      // Role
      const roleKey = meObj.role || "";
      if (!roleKey) {
        myRoleText.textContent = "Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±â€¦";
        myRoleHint.textContent = "Ø§Ù„Ù…Ø¯ÙŠØ± Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù‚Ø±ÙŠØ¨Ù‹Ø§.";
      } else {
        myRoleText.textContent = ROLE_UI[roleKey]?.name || roleKey;
        myRoleHint.textContent = ROLE_UI[roleKey]?.hint || "â€”";
      }

      // Vote status
      renderMyVoteStatus(s, pid, roleKey);

      // Action UI
      renderPlayerAction(s, pid, meObj, roleKey);
    });
  }

  function renderMyVoteStatus(s, pid, roleKey){
    if (s.phase === "night") {
      if (roleKey !== "mafia") {
        myVoteStatus.textContent = "Ù„ÙŠÙ„: Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØµÙˆÙŠØª Ù„Ùƒ.";
        return;
      }
      const v = s.votes?.night?.mafia?.[pid];
      myVoteStatus.textContent = v ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØµÙˆÙŠØª Ø§Ù„Ù‚ØªÙ„." : "â³ Ù„Ù… ØªØµÙˆÙ‘Øª Ø¨Ø¹Ø¯.";
    } else {
      const v = s.votes?.day?.public?.[pid];
      let extra = "";
      if (roleKey === "sniper") {
        const sv = s.votes?.dayExtra?.sniper?.[pid];
        extra = s.config?.sniperUsed ? " | ğŸ¯ Ø§Ù„Ø·Ù„Ù‚Ø© Ù…Ø³ØªÙ‡Ù„ÙƒØ©." : (sv ? " | ğŸ¯ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø§Ù„Ù‚Ù†Ø§Øµ." : " | ğŸ¯ Ù„Ù… ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ù„Ù‚Ø©.");
      }
      myVoteStatus.textContent = (v ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø±." : "â³ Ù„Ù… ØªØµÙˆÙ‘Øª Ø¨Ø¹Ø¯.") + extra;
    }
  }

  function buildAliveOptions(playersObj, excludeId){
    const alive = Object.values(playersObj || {}).filter(p => p.alive && p.id !== excludeId);
    return alive.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
  }

  function renderPlayerAction(s, pid, meObj, roleKey){
    const playersObj = s.players || {};
    const aliveOptions = buildAliveOptions(playersObj, pid); // âœ… Ù…Ù†Ø¹ Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙØ³

    if (!meObj.alive) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø£Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù„Ø¹Ø¨Ø© âŒ</div>`;
      return;
    }

    if (!roleKey) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ±â€¦</div>`;
      return;
    }

    if (s.winner) {
      pActionBox.innerHTML = `<div class="text-center text-slate-300">Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ğŸ</div>`;
      return;
    }

    // Night
    if (s.phase === "night") {
      if (roleKey !== "mafia") {
        pActionBox.innerHTML = `<div class="text-center text-slate-300">Ù„ÙŠÙ„â€¦ Ø§Ù†ØªØ¸Ø± (ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ ÙÙ‚Ø·).</div>`;
        return;
      }

      // Lock vote after submit (simple)
      const already = s.votes?.night?.mafia?.[pid];

      pActionBox.innerHTML = `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="font-extrabold text-lg">ØªØµÙˆÙŠØª Ø§Ù„Ù…Ø§ÙÙŠØ§ (Ù‚ØªÙ„)</div>
          <select id="selNightKill" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©</option>
            ${aliveOptions}
          </select>
          <button id="btnNightKill" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${already ? "disabled" : ""}>
            ${already ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª" : "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª"}
          </button>
          <div class="text-xs text-slate-400">ØªØµÙˆÙŠØªÙƒ Ø³Ø±ÙŠ ÙˆÙ„Ù† ÙŠØ¸Ù‡Ø± Ù„Ø£Ø­Ø¯.</div>
        </div>
      `;

      if (!already) {
        $("btnNightKill").addEventListener("click", async () => {
          const victimId = $("selNightKill").value || "";
          if (!victimId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø¶Ø­ÙŠØ©.");
          await SESS(me.code).child(`votes/night/mafia/${pid}`).set(victimId);
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØµÙˆÙŠØªÙƒ âœ…");
        });
      }
      return;
    }

    // Day
    const dayAlready = s.votes?.day?.public?.[pid];

    const dayVoteBox = `
      <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
        <div class="font-extrabold text-lg">ØªØµÙˆÙŠØª Ø§Ù„Ù†Ù‡Ø§Ø± (Ø¥Ù‚ØµØ§Ø¡)</div>
        <select id="selDayVote" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${dayAlready ? "disabled" : ""}>
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ</option>
          ${aliveOptions}
        </select>
        <button id="btnDayVote" class="tap w-full px-4 py-4 rounded-3xl ${dayAlready ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-amber-600 hover:bg-amber-500"} font-extrabold" ${dayAlready ? "disabled" : ""}>
          ${dayAlready ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª" : "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØµÙˆÙŠØª"}
        </button>
        <div class="text-xs text-slate-400">ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¹Ù†Ø¯ Ø¶ØºØ· Ø§Ù„Ù…Ø¯ÙŠØ± â€œØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªÙŠØ¬Ø©â€.</div>
      </div>
    `;

    const sniperAlready = s.votes?.dayExtra?.sniper?.[pid];
    const sniperDisabled = !!s.config?.sniperUsed || !!sniperAlready;

    const sniperBox = (roleKey === "sniper")
      ? `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ğŸ¯ Ø§Ù„Ù‚Ù†Ø§Øµ</div>
            <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">
              ${s.config?.sniperUsed ? "Ù…Ø³ØªØ®Ø¯Ù…" : (sniperAlready ? "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" : "Ù…ØªØ§Ø­")}
            </div>
          </div>
          <div class="text-sm text-slate-300">Ø·Ù„Ù‚Ø© ÙˆØ§Ø­Ø¯Ø© Ø·ÙˆØ§Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© (ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§).</div>
          <select id="selSniper" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${sniperDisabled ? "disabled" : ""}>
            <option value="">Ø§Ø®ØªØ± Ù‡Ø¯Ù Ø§Ù„Ù‚Ù†Ø§Øµ</option>
            ${aliveOptions}
          </select>
          <button id="btnSniper" class="tap w-full px-4 py-4 rounded-3xl ${sniperDisabled ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${sniperDisabled ? "disabled" : ""}>
            ${s.config?.sniperUsed ? "ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø·Ù„Ù‚Ø©" : (sniperAlready ? "ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù" : "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‡Ø¯Ù (Ø³Ø±ÙŠ)")}
          </button>
          <div class="text-xs text-slate-400">ÙŠØªÙ… ØªÙ†ÙÙŠØ° Ù‚ØªÙ„ Ø§Ù„Ù‚Ù†Ø§Øµ Ø¹Ù†Ø¯ Ø¶ØºØ· Ø§Ù„Ù…Ø¯ÙŠØ± â€œØªÙ†ÙÙŠØ° Ø§Ù„Ù†ØªÙŠØ¬Ø©â€.</div>
        </div>
      ` : "";

    pActionBox.innerHTML = dayVoteBox + sniperBox;

    if (!dayAlready) {
      $("btnDayVote").addEventListener("click", async () => {
        const targetId = $("selDayVote").value || "";
        if (!targetId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ.");
        await SESS(me.code).child(`votes/day/public/${pid}`).set(targetId);
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØµÙˆÙŠØªÙƒ âœ…");
      });
    }

    if (roleKey === "sniper" && !sniperDisabled) {
      $("btnSniper").addEventListener("click", async () => {
        const targetId = $("selSniper").value || "";
        if (!targetId) return alert("Ø§Ø®ØªØ± Ù‡Ø¯Ù Ø§Ù„Ù‚Ù†Ø§Øµ.");
        await SESS(me.code).child(`votes/dayExtra/sniper/${pid}`).set(targetId);
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø§Ù„Ù‚Ù†Ø§Øµ âœ…");
      });
    }
  }

  // Role toggle
  btnToggleRole.addEventListener("click", () => {
    myRoleCard.classList.toggle("hidden");
  });

  // Copy/share button
  btnCopyShare.addEventListener("click", () => {
    if (me?.mode === "host" && hostCode) return shareLink(hostCode);
    if (me?.mode === "player" && me?.code) return shareLink(me.code);
  });

  // Reset local
  btnResetLocal.addEventListener("click", () => {
    clearMe();
    location.href = location.pathname; // remove query
  });

  // Timer buttons
  btnTimerStart?.addEventListener("click", () => hostCode && timerStart(hostCode));
  btnTimerStop?.addEventListener("click", () => hostCode && timerStop(hostCode));
  btnTimerReset?.addEventListener("click", () => hostCode && timerReset(hostCode));

  // Buttons
  btnGoHost.addEventListener("click", createSession);
  btnGoPlayer.addEventListener("click", () => setScreen("player"));

  btnCopyJoin.addEventListener("click", () => hostCode && shareLink(hostCode));
  btnHostLockAndAssign.addEventListener("click", lockAndAssign);
  btnHostTogglePhase.addEventListener("click", togglePhase);
  btnHostResolve.addEventListener("click", resolvePhase);

  btnPlayerJoin.addEventListener("click", joinSession);

  btnBackMode1.addEventListener("click", () => { clearMe(); setScreen("mode"); });
  btnBackMode2.addEventListener("click", () => { clearMe(); setScreen("mode"); });

  // Smooth timer refresh for host display (no heavy load)
  setInterval(() => {
    if (me?.mode === "host" && hostCode && hostTimerText) {
      SESS(hostCode).child("config/timer").get().then(snap => {
        const t = snap.val() || { running:false, endAt:0 };
        hostTimerText.textContent = t.running ? fmtLeft((t.endAt||0) - now()) : "Ù…ØªÙˆÙ‚Ù";
      }).catch(()=>{});
    }
  }, 1000);

  // Auto resume
  if (me?.mode === "host" && me?.code) {
    hostCode = me.code;
    hostCodeEl.textContent = hostCode;
    setScreen("host");
    subscribeHost(hostCode);
  } else if (me?.mode === "player" && me?.code && me?.pid) {
    setScreen("player");
    joinBox.classList.add("hidden");
    playerBox.classList.remove("hidden");
    pName.textContent = me.name;
    pCode.textContent = me.code;
    subscribePlayer(me.code, me.pid);
  } else {
    setScreen("mode");
  }
})();
</script>
</body>
</html>
