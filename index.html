<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ูุงููุง โ ูุนุจ ุขูู ุจุฏูู ูุฏูุฑ</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (Realtime DB) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <style>
    body { padding-bottom: env(safe-area-inset-bottom); }
    .tap { -webkit-tap-highlight-color: transparent; }
    .glass { backdrop-filter: blur(10px); }
    .no-spin::-webkit-outer-spin-button,
    .no-spin::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .no-spin { -moz-appearance: textfield; }
    /* ====== Modern Room UI (Safe CSS Only) ====== */
:root{
  --glass: rgba(2,6,23,.55);
  --glass2: rgba(2,6,23,.35);
  --line: rgba(148,163,184,.16);
  --line2: rgba(148,163,184,.10);
}

body{
  background: linear-gradient(180deg, #020617 0%, #020617 55%, #0b1220 100%) !important;
  overflow-x: hidden;
}

/* ุฎูููุฉ ูุงุนูุฉ + ููุณุฉ โูุฏููุฉโ ุฎูููุฉ */

/* ุฒุฌุงุฌ */
.glass{
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

/* ุชุญุณูู ุงูููุฏุฑ ุจุฏูู ุชุบููุฑ HTML */
header{
  background: rgba(2,6,23,.55) !important;
  border-bottom: 1px solid var(--line) !important;
}
header .tap{
  background: rgba(15,23,42,.35) !important;
  border: 1px solid var(--line) !important;
}

/* ููุทูุฉ ุงููุงุนุจูู โ ููุฏุฑู Tiles ุจุฏูู ุชุบููุฑ ููุทู */
#inGamePlayersList > *{
  border: 1px solid var(--line) !important;
  background: rgba(2,6,23,.38) !important;
  border-radius: 22px !important;
  box-shadow: 0 12px 30px rgba(0,0,0,.25) !important;
}

/* ุดุงุฑุฉ/ุญุงูุฉ (ูู ููุฌูุฏุฉ) */
#inGamePlayersList .badge,
#inGamePlayersList [data-badge]{
  border-radius: 999px !important;
}

/* ุตูุฏูู ุงูุฅุฌุฑุงุก: ุฎููู ูุฃูู Bottom Sheet โุดููุงูโ ุจุฏูู ููู ููุงูู */
#pActionBox{
  border-radius: 22px !important;
}
#pActionBox > *{
  border: 1px solid var(--line2) !important;
  background: rgba(2,6,23,.32) !important;
  border-radius: 18px !important;
}

/* ุฃุฒุฑุงุฑ ุนุงูุฉ */
button.tap{
  border-radius: 18px !important;
}
  </style>
</head>

<body class="text-slate-100 min-h-screen overflow-x-hidden">

  <!-- Background -->
  <div aria-hidden="true" class="fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-950 to-slate-900"></div>
    <div class="absolute inset-0 opacity-30" style="background:
      radial-gradient(900px 500px at 10% 0%, rgba(56,189,248,0.18), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,0.12), transparent 60%),
      radial-gradient(900px 600px at 50% 100%, rgba(168,85,247,0.10), transparent 60%);"></div>
    <div class="absolute inset-x-0 bottom-0 h-[58vh] opacity-15"
      style="background-image: url('data:image/svg+xml;utf8,<?xml version=%221.0%22 encoding=%22UTF-8%22?><svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1200 500%22><defs><linearGradient id=%22g%22 x1=%220%22 x2=%220%22 y1=%220%22 y2=%221%22><stop offset=%220%25%22 stop-color=%22%23ffffff%22 stop-opacity=%220.45%22/><stop offset=%22100%25%22 stop-color=%22%23ffffff%22 stop-opacity=%220.0%22/></linearGradient></defs><path fill=%22url(%23g)%22 d=%22M0 420 L80 380 L130 395 L210 340 L260 360 L320 300 L390 330 L460 250 L520 290 L590 210 L650 260 L720 190 L780 240 L860 160 L920 220 L1000 140 L1080 210 L1200 120 L1200 500 L0 500 Z%22/></svg>'); background-size: cover; background-position: center bottom;"></div>
  </div>

  
  <header class="sticky top-0 z-40 bg-slate-950/50 glass border-b border-slate-800/70">
    <div class="px-4 py-3 flex items-center justify-between">
      <button id="btnMenu" class="tap p-2 rounded-2xl bg-slate-900/40 border border-slate-800/70 hover:bg-slate-900/60" aria-label="ุงููุงุฆูุฉ">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" stroke-linecap="round" d="M4 7h16M4 12h16M4 17h16"/></svg>
      </button>

      <div class="flex items-center gap-2">
        <div class="text-lg font-extrabold tracking-wide">ูุงููุง</div>
        <div id="badgeMini" class="hidden text-[11px] px-2 py-1 rounded-xl border border-slate-700/70 bg-slate-900/40 text-slate-200">โ</div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnHow" class="tap p-2 rounded-2xl bg-slate-900/40 border border-slate-800/70 hover:bg-slate-900/60" aria-label="ูุนูููุงุช">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="M12 17v-6"/><path stroke="currentColor" stroke-width="2" d="M12 8h.01"/><path stroke="currentColor" stroke-width="2" d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/></svg>
        </button>
        <button id="btnCopyShare" class="hidden tap p-2 rounded-2xl bg-slate-900/40 border border-slate-800/70 hover:bg-slate-900/60" aria-label="ูุดุงุฑูุฉ">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7"/><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M16 6l-4-4-4 4"/><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M12 2v14"/></svg>
        </button>
        <button id="btnLeave" class="hidden tap p-2 rounded-2xl bg-rose-700/30 border border-rose-700/60 hover:bg-rose-700/45" aria-label="ุฎุฑูุฌ">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M16 17l5-5-5-5"/><path stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 12H9"/></svg>
        </button>
      </div>
    </div>
  </header>


  <!-- Modal: How to play -->
  <div id="howModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-x-0 bottom-0 max-w-md mx-auto p-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-950 shadow-xl p-5 space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-xl font-extrabold">๐ ููู ุชูุนุจุ</div>
          <button id="btnCloseHow" class="tap px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">ุฅุบูุงู</button>
        </div>
        <div class="text-sm text-slate-300 leading-7">
          <div class="font-bold text-slate-100 mb-1">ุงูููุฑุฉ</div>
          ูู ูุงุนุจ ุนูุฏู ุฏูุฑ ุณุฑู. ุงููุนุจุฉ ุชูุดู ุชููุงุฆููุง: <b>ููู</b> ุซู <b>ููุงุฑ</b> ุจูุคููุช. ูุง ููู ูุฏูุฑ.
          <div class="mt-3 font-bold text-slate-100 mb-1">ุงูููู ๐</div>
          โข ุงููุงููุง ุชุตููุช ููุชู ูุงุนุจ.<br>
          โข ุงูุฃุฏูุงุฑ ุงูููููุฉ (ุฅุฐุง ููุนููุฉ): ุทุจูุจ/ูุญูู/ุญุงุฑุณ/ูุงุชู ูุชุณูุณู/ุณุงุญุฑุฉ ุชุฎุชุงุฑ ูุฑุงุฑุงุชูุง.<br>
          <div class="mt-3 font-bold text-slate-100 mb-1">ุงูููุงุฑ โ๏ธ</div>
          โข ุงูุฌููุน ูุตููุช ูุฅูุตุงุก ูุงุนุจ.<br>
          โข ุงูููุงุต (ุฅุฐุง ููุนูู) ุนูุฏู ุทููุฉ ูุงุญุฏุฉ ุทูุงู ุงููุนุจุฉ (ุจุงูููุงุฑ).<br>
          โข ุงูุนูุฏุฉ (ุฅุฐุง ููุนูู) ุตูุชู ูุญุณูุจ <b>ูุฑุชูู</b> ุจุฏูู ูุง ูุนุฑู ุฃุญุฏ.
          <div class="mt-3 text-xs text-slate-400">
            ุงููุธุงู ููููุฐ ุงููุชุงุฆุฌ ุนูุฏ ุงูุชูุงู ุดุฑุท ููุงูุฉ ุงููุฑุญูุฉ ุฃู ุงูุชูุงุก ุงูููุช.
          </div>
        </div>
      </div>
    </div>

  <!-- Modal: Phase transition summary -->
  <div id="phaseModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="absolute inset-x-0 bottom-0 max-w-md mx-auto p-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-950 shadow-xl p-5 space-y-3">
        <div class="flex items-center justify-between">
          <div class="text-xl font-extrabold">๐งพ ููุฎุต ุงูุฌููุฉ</div>
          <button id="btnClosePhase" class="tap px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">ุฅุบูุงู</button>
        </div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
          <div id="pmTitle" class="text-lg font-extrabold">โ</div>
          <div id="pmBody" class="mt-2 text-sm text-slate-200 leading-7">โ</div>
        </div>
        <div class="text-xs text-slate-400 leading-6">
          ูุฐุง ุงูููุฎุต ุนุงู ููุง ููุดู ุฃุฏูุงุฑ.
        </div>
        <button id="btnPhaseOk" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          ูุชุงุจุนุฉ โ
        </button>
      </div>
    </div>
  </div>

  </div>

  <!-- Modal: Role reveal (one-time per game on device) -->
  <div id="roleModal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/70"></div>
    <div class="absolute inset-x-0 bottom-0 max-w-md mx-auto p-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-950 shadow-xl p-5 space-y-3">
        <div class="text-xl font-extrabold">๐ญ ุฏูุฑู</div>
        <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-4">
          <div id="rmRole" class="text-3xl font-extrabold">โ</div>
          <div id="rmHint" class="text-sm text-slate-300 mt-2 leading-7">โ</div>
        </div>
        <div class="text-xs text-slate-400 leading-6">
          ููุงุญุธุฉ: ุงูุฃุฏูุงุฑ ูุง ุชุธูุฑ ูุฃุญุฏ ุบูุฑู.
        </div>
        <button id="btnRoleOk" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          ูููุช โ
        </button>
      </div>
    </div>
  </div>

  <main class="px-4 py-4 space-y-4 max-w-2xl mx-auto pb-[60vh]">

    <!-- Screen: Mode -->
    <section id="screenMode" class="space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 shadow">
        <h1 class="text-2xl font-extrabold">ูุงููุง โ ุจุฏูู ูุฏูุฑ</h1>
        <p class="text-slate-300 text-sm mt-2 leading-6">
          โข ุฃูู ุดุฎุต ููุดุฆ ุงูุฌูุณุฉ ูุฏุฎู ููุงุนุจ ููุถุจุท ุงูุฅุนุฏุงุฏุงุช ุซู ูุถุบุท <b>ุงุจุฏุฃ ุงููุนุจุฉ</b>.<br>
          โข ุจุนุฏ ุงูุจุฏุก: <b>ุงููุฑุงุญู + ุงููุคูุช + ุชูููุฐ ุงููุชุงุฆุฌ</b> ูููุง ุชุชู ุชููุงุฆููุง.
        </p>
      </div>

      <button id="btnGoCreate" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
        ุฅูุดุงุก ุฌูุณุฉ (ูุฃูุง ูุงุนุจ)
      </button>

      <button id="btnGoJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
        ุฏุฎูู ุฌูุณุฉ
      </button>

      <div class="text-xs text-slate-400 text-center">
        ุชูุฏุฑ ุชุฑุณู โุฑุงุจุท ุงูุฏุฎููโ ุจุฏู ุงูููุฏ.
      </div>
    </section>

    <!-- Screen: Create -->
    <section id="screenCreate" class="hidden space-y-4">
      <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">ุฅูุดุงุก ุฌูุณุฉ</h2>

        <label class="text-sm text-slate-300">ุงุณูู</label>
        <input id="createName" placeholder="ูุซุงู: ุนุจุฏุงููู"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <div class="grid grid-cols-2 gap-2 mt-2">
          <div>
            <label class="text-sm text-slate-300">ูุฏุฉ ุงููุฑุญูุฉ (ุซุงููุฉ)</label>
            <input id="cfgSeconds" type="number" min="15" value="120"
              class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
          </div>
          <div>
            <label class="text-sm text-slate-300">ุญู ุงูุชุนุงุฏู</label>
            <select id="cfgTieMode"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
              <option value="revote">ุฅุนุงุฏุฉ ุงูุชุตููุช</option>
              <option value="random">ุงุฎุชูุงุฑ ุนุดูุงุฆู</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-sm text-slate-300">ููุงูุฉ ุงูููุงุฑ</label>
            <select id="cfgDayEnd"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
              <option value="all">ุนูุฏ ุชุตููุช ุงูุฌููุน</option>
              <option value="majority">ุนูุฏ ุญุตูู ุฎูุงุฑ ุนูู ุฃุบูุจูุฉ</option>
              <option value="timer">ุงูุชุธุงุฑ ุงูููุช ููุท</option>
            </select>
          </div>
          <div>
            <label class="text-sm text-slate-300">ููุงูุฉ ุงูููู</label>
            <select id="cfgNightEnd"
              class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500">
              <option value="all">ุนูุฏ ุฅููุงุก ูู ุงูุฃุฏูุงุฑ</option>
              <option value="timer">ุงูุชุธุงุฑ ุงูููุช ููุท</option>
            </select>
          </div>
        </div>

        <div>
          <label class="text-sm text-slate-300">ุนุฏุฏ ุงููุงููุง</label>
          <input id="cfgMafia" type="number" min="1" value="1"
            class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
        </div>

        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold">ุงูุฃุฏูุงุฑ (ุชูุนูู/ุฅูุบุงุก + ุนุฏุฏ)</div>
            <div class="text-xs text-slate-400">ุงูุจุงูู โููุงุทูโ</div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            
            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ฏ ููุงุต</span>
                <input id="roleSniperOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleSniperCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                 />
            </div>
    

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐คก ููุฑูุฌ</span>
                <input id="roleJesterOn" type="checkbox" checked class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleJesterCount" type="number" min="0" max="10" value="1"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                 />
            </div>
    

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ฉบ ุทุจูุจ</span>
                <input id="roleDoctorOn" type="checkbox"  class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleDoctorCount" type="number" min="0" max="10" value="0"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                disabled />
            </div>
    

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ ูุญูู</span>
                <input id="roleDetectiveOn" type="checkbox"  class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleDetectiveCount" type="number" min="0" max="10" value="0"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                disabled />
            </div>
    

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ก๏ธ ุญุงุฑุณ</span>
                <input id="roleBodyguardOn" type="checkbox"  class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleBodyguardCount" type="number" min="0" max="10" value="0"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                disabled />
            </div>
    

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ช ูุงุชู ูุชุณูุณู</span>
                <input id="roleSerialOn" type="checkbox"  class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleSerialCount" type="number" min="0" max="10" value="0"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                disabled />
            </div>
    

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐งช ุณุงุญุฑุฉ</span>
                <input id="roleWitchOn" type="checkbox"  class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleWitchCount" type="number" min="0" max="10" value="0"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                disabled />
            </div>
    

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <label class="flex items-center justify-between gap-2">
                <span class="font-bold">๐ ุนูุฏุฉ</span>
                <input id="roleMayorOn" type="checkbox"  class="h-5 w-5 accent-sky-500">
              </label>
              <input id="roleMayorCount" type="number" min="0" max="10" value="0"
                class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500"
                disabled />
            </div>
    </div>

          <div class="text-xs text-slate-400 leading-6">
            โข ุงูุทุจูุจ: ูุฎุชุงุฑ ุดุฎุตูุง ูุฅููุงุฐู (ููู).<br>
            โข ุงููุญูู: ูุญูู ููุธูุฑ ูู ููุท โูุงููุง/ููุณ ูุงููุงโ (ููู).<br>
            โข ุงูุญุงุฑุณ: ูุญูู ุดุฎุตูุงุ ุฅุฐุง ูุงุฌูุช ุงููุงููุง ูุฏูู ูููุช ุงูุญุงุฑุณ ุจุฏููุง ุนูู (ููู).<br>
            โข ุงููุงุชู ุงููุชุณูุณู: ููุชู ุดุฎุตูุง (ููู) ููู ุทุฑู ูุณุชูู (ูููุฒ ุฅุฐุง ุจูู ููุญุฏู).<br>
            โข ุงูุณุงุญุฑุฉ: ุนูุฏูุง ุฅููุงุฐ <b>ูุฑุฉ</b> ูุณู <b>ูุฑุฉ</b> ุทูุงู ุงููุนุจุฉ (ููู).<br>
            โข ุงูุนูุฏุฉ: ุตูุชู ุจุงูููุงุฑ ูุญุณูุจ <b>ูุฑุชูู</b> (ุจุฏูู ูุง ูุนุฑู ุฃุญุฏ).
          </div>
        </div>

        <button id="btnCreateSession" class="tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
          ุฅูุดุงุก ุงูุฌูุณุฉ
        </button>

        <button id="btnBackFromCreate" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          ุฑุฌูุน
        </button>
      </div>
    </section>

    <!-- Screen: Player -->
    <section id="screenPlayer" class="hidden space-y-4">
      <div id="joinBox" class="hidden rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
        <h2 class="text-xl font-extrabold">ุฏุฎูู ุฌูุณุฉ</h2>

        <label class="text-sm text-slate-300">ููุฏ ุงูุฌูุณุฉ</label>
        <input id="playerCode" placeholder="ูุซุงู: 482913"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <label class="text-sm text-slate-300">ุงุณูู</label>
        <input id="playerName" placeholder="ูุซุงู: ุนุจุฏุงููู"
          class="mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />

        <button id="btnPlayerJoin" class="tap w-full px-4 py-4 rounded-3xl bg-sky-600 hover:bg-sky-500 font-extrabold text-lg">
          ุฏุฎูู
        </button>

        <button id="btnBackFromJoin" class="tap w-full px-4 py-4 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 font-bold">
          ุฑุฌูุน
        </button>

        <div class="text-xs text-slate-400">ููุงุญุธุฉ: ูุง ูููู ุชูุฑุงุฑ ููุณ ุงูุงุณู ุฏุงุฎู ุงูุฌูุณุฉ.</div>
      </div>

      <div id="playerBox" class="hidden space-y-4">
        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-xs text-slate-300">ุงูุฌูุณุฉ</div>
              <div class="text-2xl font-extrabold mt-1">
                <span id="pName">โ</span> ยท <span class="tracking-widest" id="pCode">โ</span>
              </div>
              <div id="lobbyHint" class="text-sm text-slate-300 mt-2 leading-6">โ</div>
            </div>
            <div class="text-left">
              <div class="text-xs text-slate-300">ุงูููุช ุงููุชุจูู</div>
              <div class="text-sm text-slate-400">โฌ๏ธ ููุญุฉ ุงูุฅุฌุฑุงุก ุจุงูุฃุณูู</div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
              <div class="text-xs text-slate-300">ุงููุฑุญูุฉ</div>
              <div class="text-2xl font-extrabold mt-1">โ</div>
            </div>
            <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3 text-right">
              <div class="text-xs text-slate-300">ุงูุฌููุฉ</div>
              <div class="text-2xl font-extrabold mt-1">โ</div>
            </div>
          </div>

          <div id="winnerBanner" class="hidden rounded-2xl border border-amber-700 bg-amber-900/20 p-3">
            <div class="font-extrabold" id="winnerText">โ</div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">ุงูููุฎุต</div>
            <div id="publicLog" class="mt-1 text-slate-300 text-sm leading-6">โ</div>
          </div>
        </div>

        <div id="lobbyBox" class="hidden rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ุงููุงุนุจูู</div>
            <div class="text-xs text-slate-400"><span id="playerCount">โ</span></div>
          </div>
          <div id="playersList" class="space-y-2"></div>

          <button id="btnStartGame" class="hidden tap w-full px-4 py-4 rounded-3xl bg-emerald-600 hover:bg-emerald-500 font-extrabold text-lg">
            ุงุจุฏุฃ ุงููุนุจุฉ
          </button>

          <div class="text-xs text-slate-400 leading-6">
            ุงูุดุฑุท: 5 ูุงุนุจูู ุฃู ุฃูุซุฑ. ุจุนุฏ ุงูุจุฏุก ูู ุดูุก ูุตูุฑ ุขูู.
          </div>
        </div>

        <!-- In-game players list -->
        <div id="inGamePlayersBox" class="hidden">
          <div class="flex items-center justify-center">
            <div class="px-5 py-2 rounded-2xl bg-slate-950/60 border border-slate-800/70 shadow-sm flex items-center gap-3">
              <div class="text-xs text-slate-300">โฑ๏ธ ุงูููุช</div>
              <div id="phaseLeft" class="text-lg font-extrabold tabular-nums">โ</div>
              <div class="w-px h-5 bg-slate-800/70"></div>
              <div id="pPhase" class="text-sm font-extrabold">โ</div>
              <div class="text-xs text-slate-400">ยท</div>
              <div class="text-sm font-bold">ุฌููุฉ <span id="pRound">โ</span></div>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <div class="font-extrabold text-lg">ุงููุงุนุจูู</div>
              <div class="text-xs text-slate-400"><span id="inGameCount">โ</span></div>
            </div>
            <div id="inGamePlayersList" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
            <div class="mt-2 text-xs text-slate-400 leading-6">
              ุงูุญุงูุฉ ููุท (ุญู/ุฎุงุฑุฌ). ุงูุฃุฏูุงุฑ ูุง ุชุธูุฑ.
            </div>
          </div>
        </div>

        <!-- History -->

        <div id="historyBox" class="hidden rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="font-extrabold text-lg">ุณุฌู ุงูุฌููุงุช</div>
          <div id="historyList" class="space-y-2"></div>
        </div>

        <div class="rounded-3xl border border-slate-800 bg-slate-900/40 p-5 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">ุฏูุฑู</div>
            <button id="btnToggleRole" class="tap text-sm px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">
              ุฅุธูุงุฑ/ุฅุฎูุงุก
            </button>
          </div>

          <div id="myRoleCard" class="hidden rounded-2xl border border-slate-800 bg-slate-950 p-4">
            <div id="myRoleText" class="text-3xl font-extrabold">โ</div>
            <div id="myRoleHint" class="text-sm text-slate-300 mt-2 leading-6">โ</div>
            <div id="roleExtraBox" class="mt-3 hidden rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
              <div class="text-xs text-slate-300">ูุนูููุฉ ุฎุงุตุฉ</div>
              <div id="roleExtraText" class="mt-1 font-bold">โ</div>
            </div>
          </div>

          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
            <div class="font-extrabold">ุญุงูุฉ ุฅุฌุฑุงุกู</div>
            <div id="myVoteStatus" class="text-sm text-slate-300 mt-1">โ</div>
          </div>
        </div>

        <div class="fixed inset-x-0 bottom-0 z-30 px-4 pb-[env(safe-area-inset-bottom)]">
  <div class="max-w-2xl mx-auto rounded-t-3xl border border-slate-800/70 bg-slate-950/70 glass shadow-2xl">
    <div class="px-5 pt-4 pb-3 border-b border-slate-800/70">
      <div class="w-12 h-1.5 rounded-full bg-slate-700/60 mx-auto mb-3"></div>
      <div class="flex items-center justify-between">
        <div class="font-extrabold text-lg">ุงูุฅุฌุฑุงุก</div>
        <div class="text-xs text-slate-400">๐ <span id="liveTally">โ</span></div>
      </div>
    </div>
    <div class="px-5 py-4 max-h-[52vh] overflow-auto">
      <div id="pActionBox" class="space-y-3"></div>
    </div>
  </div>
</div>
    </section>
  </main>

<script>
// --- RoleCard pseudo component removed: we render real HTML via JS (below) ---
</script>

<script>
(() => {
  // Replace RoleCard tags (simple templating for this single-file HTML)
  document.querySelectorAll("RoleCard").forEach(el => {
    const title = el.getAttribute("title") || "";
    const idOn = el.getAttribute("idOn") || "";
    const idCount = el.getAttribute("idCount") || "";
    const checked = el.getAttribute("checked") ? "checked" : "";
    el.outerHTML = `
      <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3">
        <label class="flex items-center justify-between gap-2">
          <span class="font-bold">${title}</span>
          <input id="${idOn}" type="checkbox" ${checked} class="h-5 w-5 accent-sky-500">
        </label>
        <input id="${idCount}" type="number" min="0" max="10" value="1"
          class="no-spin mt-2 w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
      </div>
    `;
  });

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC4YdqgiAfJmRmvkLH4wspzclAzKs3wyLw",
    authDomain: "mafia-game-7e488.firebaseapp.com",
    databaseURL: "https://mafia-game-7e488-default-rtdb.firebaseio.com",
    projectId: "mafia-game-7e488",
    storageBucket: "mafia-game-7e488.firebasestorage.app",
    messagingSenderId: "513186840934",
    appId: "1:513186840934:web:ccf858b27cea91be1448a7"
  };

  const $ = (id) => document.getElementById(id);
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Helpers
  const rid = () => (crypto?.getRandomValues ? [...crypto.getRandomValues(new Uint32Array(2))].map(x=>x.toString(16)).join("") : String(Math.random()).slice(2));
  const now = () => Date.now();
  const code6 = () => String(Math.floor(100000 + Math.random() * 900000));
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const shuffle = (arr) => { const a = arr.slice(); for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };
  const normName = (s) => String(s || "").trim().replace(/\s+/g, " ").toLowerCase();
  const clampInt = (x, lo, hi) => Math.max(lo, Math.min(hi, Number(x || 0)));

  function fmtLeft\(ms\)\{
    const s = Math\.max\(0, Math\.ceil\(ms / 1000\)\);
    const m = Math\.floor\(s / 60\);
    const r = s % 60;
    return m > 0 \? `\$\{m\}:\$\{String\(r\)\.padStart\(2,"0"\)\}` : `\$\{r\}s`;
  \}

  function showPhaseModal(title, body){
    if (!phaseModal) return;
    pmTitle.textContent = title || "โ";
    pmBody.textContent = body || "โ";
    phaseModal.classList.remove("hidden");
  }
  function closePhaseModal(){ phaseModal?.classList.add("hidden"); }

  function getTopCandidatesWeighted(votesByPid, playersObj, weightFn){
    const tally = {};
    for (const [voterPid, targetId] of Object.entries(votesByPid || {})) {
      if (!targetId || targetId === "skip") continue;
      const w = weightFn(voterPid, playersObj);
      tally[targetId] = (tally[targetId] || 0) + w;
    }
    const entries = Object.entries(tally).sort((a,b)=>b[1]-a[1]);
    if (!entries.length) return { max: 0, candidates: [], tally:{} };
    const max = entries[0][1];
    const candidates = entries.filter(([,c]) => c === max).map(([id]) => id);
    return { max, candidates, tally };
  }

  function tallyTextWeighted(votesByPid, playersObj, weightFn){
    const seen = Object.keys(votesByPid || {}).filter(k => (votesByPid||{})[k]).length;
    if (seen === 0) return "ูุง ุชูุฌุฏ ุฃุตูุงุช ุจุนุฏ.";
    const top = getTopCandidatesWeighted(votesByPid || {}, playersObj, weightFn);
    return `ุชู ุชุณุฌูู ${seen} ุตูุช. ุฃุนูู ุฎูุงุฑ ุนููู ${top.max} (ูุฒู).`;
  }

  // Identity storage
  const LS_KEY = "mafia_identity_auto_v3";
  const LS_ROLE_SEEN = "mafia_role_seen_v3";
  const getMe = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || "null"); } catch { return null; } };
  const setMe = (o) => localStorage.setItem(LS_KEY, JSON.stringify(o));
  const clearMe = () => localStorage.removeItem(LS_KEY);

  const roleSeenKey = (code, startedAt, pid) => `${code}:${startedAt}:${pid}`;
  const hasSeenRole = (k) => { try { const o = JSON.parse(localStorage.getItem(LS_ROLE_SEEN) || "{}"); return !!o[k]; } catch { return false; } };
  const markSeenRole = (k) => { let o={}; try{o=JSON.parse(localStorage.getItem(LS_ROLE_SEEN)||"{}")}catch{}; o[k]=true; localStorage.setItem(LS_ROLE_SEEN, JSON.stringify(o)); };

  const SESS = (code) => db.ref(`sessions/${code}`);

  // UI refs
  const badgeMini = $("badgeMini");
  const btnCopyShare = $("btnCopyShare");
  const btnLeave = $("btnLeave");
  const btnHow = $("btnHow");
  const howModal = $("howModal");
  const btnCloseHow = $("btnCloseHow");

  const phaseModal = $("phaseModal");
  const btnClosePhase = $("btnClosePhase");
  const btnPhaseOk = $("btnPhaseOk");
  const pmTitle = $("pmTitle");
  const pmBody = $("pmBody");

  const roleModal = $("roleModal");
  const rmRole = $("rmRole");
  const rmHint = $("rmHint");
  const btnRoleOk = $("btnRoleOk");

  const screenMode = $("screenMode");
  const screenCreate = $("screenCreate");
  const screenPlayer = $("screenPlayer");

  const btnGoCreate = $("btnGoCreate");
  const btnGoJoin = $("btnGoJoin");

  // Create form
  const createName = $("createName");
  const cfgSeconds = $("cfgSeconds");
  const cfgTieMode = $("cfgTieMode");
  const cfgMafia = $("cfgMafia");
  const cfgDayEnd = $("cfgDayEnd");
  const cfgNightEnd = $("cfgNightEnd");

  const roleSniperOn = $("roleSniperOn");
  const roleJesterOn = $("roleJesterOn");
  const roleDoctorOn = $("roleDoctorOn");
  const roleDetectiveOn = $("roleDetectiveOn");
  const roleBodyguardOn = $("roleBodyguardOn");
  const roleSerialOn = $("roleSerialOn");
  const roleWitchOn = $("roleWitchOn");
  const roleMayorOn = $("roleMayorOn");

  const roleSniperCount = $("roleSniperCount");
  const roleJesterCount = $("roleJesterCount");
  const roleDoctorCount = $("roleDoctorCount");
  const roleDetectiveCount = $("roleDetectiveCount");
  const roleBodyguardCount = $("roleBodyguardCount");
  const roleSerialCount = $("roleSerialCount");
  const roleWitchCount = $("roleWitchCount");
  const roleMayorCount = $("roleMayorCount");

  // ุชูุนูู/ุชุนุทูู ุนุฏุงุฏ ูู ุฏูุฑ ุญุณุจ ุฎูุงุฑ ุงูุชูุนูู (ูุชูุงุฏู ูุดุงูู ุงูุดูู/ุงูููู)
  function wireRoleCountToggle(idOn, idCount){
    const onEl = $(idOn); const cntEl = $(idCount);
    if (!onEl || !cntEl) return;
    const sync = () => {
      if (onEl.checked){
        cntEl.disabled = false;
        if (Number(cntEl.value || 0) <= 0) cntEl.value = 1;
      } else {
        cntEl.value = 0;
        cntEl.disabled = true;
      }
    };
    onEl.addEventListener("change", sync);
    sync();
  }
  ["Sniper","Jester","Doctor","Detective","Bodyguard","Serial","Witch","Mayor"].forEach(k=>{
    wireRoleCountToggle(`role${k}On`, `role${k}Count`);
  });


  const btnCreateSession = $("btnCreateSession");
  const btnBackFromCreate = $("btnBackFromCreate");

  // Join form
  const joinBox = $("joinBox");
  const playerCode = $("playerCode");
  const playerName = $("playerName");
  const btnPlayerJoin = $("btnPlayerJoin");
  const btnBackFromJoin = $("btnBackFromJoin");

  // Player UI
  const playerBox = $("playerBox");
  const pName = $("pName");
  const pCode = $("pCode");
  const pPhase = $("pPhase");
  const pRound = $("pRound");
  const phaseLeft = $("phaseLeft");
  const lobbyHint = $("lobbyHint");
  const publicLog = $("publicLog");

  const winnerBanner = $("winnerBanner");
  const winnerText = $("winnerText");

  const lobbyBox = $("lobbyBox");
  const playerCount = $("playerCount");
  const playersList = $("playersList");
  const btnStartGame = $("btnStartGame");

  const inGamePlayersBox = $("inGamePlayersBox");
  const inGameCount = $("inGameCount");
  const inGamePlayersList = $("inGamePlayersList");

  const historyBox = $("historyBox");
  const historyList = $("historyList");

  const btnToggleRole = $("btnToggleRole");
  const myRoleCard = $("myRoleCard");
  const myRoleText = $("myRoleText");
  const myRoleHint = $("myRoleHint");
  const roleExtraBox = $("roleExtraBox");
  const roleExtraText = $("roleExtraText");
  const myVoteStatus = $("myVoteStatus");
  const liveTally = $("liveTally");
  const pActionBox = $("pActionBox");

  const ROLE_UI = {
    mafia: { name:"ูุงููุง", hint:"ุจุงูููู: ุตููุช ููุชู ูุงุนุจ. ุจุงูููุงุฑ: ุญุงูู ูุง ุชููุดู." },
    citizen: { name:"ููุงุทู", hint:"ุจุงูููุงุฑ: ุตููุช ุตุญ. ุจุงูููู: ุงูุชุธุฑ." },
    sniper: { name:"ููุงุต", hint:"๐ฏ ุทููุฉ ูุงุญุฏุฉ ุทูุงู ุงููุนุจุฉ (ุจุงูููุงุฑ). ุงุฎุชูุงุฑู ุณุฑู." },
    jester: { name:"ููุฑูุฌ", hint:"๐คก ูุฏูู ูุชู ุฅูุตุงุคู ุจุงูุชุตููุช ูู ุงูููุงุฑ ูุชููุฒ ูุญุฏู ููุฑูุง." },
    doctor: { name:"ุทุจูุจ", hint:"๐ฉบ ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ูุฅููุงุฐู ูู ุงููุชู." },
    detective: { name:"ูุญูู", hint:"๐ ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ููุชุญููู (ูุธูุฑ ูู: ูุงููุง/ููุณ ูุงููุง)." },
    bodyguard: { name:"ุญุงุฑุณ", hint:"๐ก๏ธ ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ูุชุญููู. ุฅุฐุง ูุงุฌูุชู ุงููุงููุง ูุฏูู ุชููุช ุฃูุช ุจุฏููุง ุนูู." },
    serial: { name:"ูุงุชู ูุชุณูุณู", hint:"๐ช ุจุงูููู: ุงุฎุชุฑ ูุงุนุจูุง ููุชูู. ูุฏูู ุชุจูู ุขุฎุฑ ุดุฎุต ุญู." },
    witch: { name:"ุณุงุญุฑุฉ", hint:"๐งช ุจุงูููู: ุนูุฏู ุฅููุงุฐ ูุฑุฉ ูุณู ูุฑุฉ ุทูุงู ุงููุนุจุฉ." },
    mayor: { name:"ุนูุฏุฉ", hint:"๐ ุจุงูููุงุฑ: ุตูุชู ูุญุณูุจ ูุฑุชูู (ุณุฑู)." },
  };

  // State
  let me = getMe();
  let sub = null;

  // Render guards
  let lastRenderKey = "";
  let lastActionKey = "";
  let lastPhaseLocal = "";
  let lastRoundLocal = 0;

  // Engine heartbeat
  let engineTimer = null;
  let lockExpiresAtLocal = 0;

  function setScreen(which){
    screenMode.classList.add("hidden");
    screenCreate.classList.add("hidden");
    screenPlayer.classList.add("hidden");
    joinBox.classList.add("hidden");
    playerBox.classList.add("hidden");
    btnCopyShare.classList.add("hidden");
    btnLeave.classList.add("hidden");
    badgeMini.classList.add("hidden");

    if (which === "mode") screenMode.classList.remove("hidden");
    if (which === "create") screenCreate.classList.remove("hidden");
    if (which === "join") { screenPlayer.classList.remove("hidden"); joinBox.classList.remove("hidden"); }
    if (which === "player") {
      screenPlayer.classList.remove("hidden");
      playerBox.classList.remove("hidden");
      btnCopyShare.classList.remove("hidden");
      btnLeave.classList.remove("hidden");
      badgeMini.classList.remove("hidden");
      badgeMini.textContent = me?.isCreator ? "ูููุดุฆ" : "ูุงุนุจ";
    }
  }

  function shareLink(code){
    const url = `${location.origin}${location.pathname}?code=${code}`;
    navigator.clipboard?.writeText(url);
    alert("ุชู ูุณุฎ ุฑุงุจุท ุงูุฏุฎูู.");
  }

  // URL join ?code=
  const urlParams = new URLSearchParams(location.search);
  const preCode = urlParams.get("code");
  if (preCode && !me) {
    setScreen("join");
    playerCode.value = preCode;
  }

  function readRolesFromUI(){
    const mk = (onEl, cntEl) => ({ on: !!onEl?.checked, count: clampInt(cntEl?.value, 0, 20) });
    return {
      sniper: mk(roleSniperOn, roleSniperCount),
      jester: mk(roleJesterOn, roleJesterCount),
      doctor: mk(roleDoctorOn, roleDoctorCount),
      detective: mk(roleDetectiveOn, roleDetectiveCount),
      bodyguard: mk(roleBodyguardOn, roleBodyguardCount),
      serial: mk(roleSerialOn, roleSerialCount),
      witch: mk(roleWitchOn, roleWitchCount),
      mayor: mk(roleMayorOn, roleMayorCount),
    };
  }

  async function createSessionAsPlayer(){
    const name = String(createName.value || "").trim();
    if (!name) return alert("ุงูุชุจ ุงุณูู.");

    const seconds = clampInt(cfgSeconds.value, 15, 3600);
    const tieMode = String(cfgTieMode.value || "revote");
    const dayEnd = String(cfgDayEnd.value || "all");   // all | majority | timer
    const nightEnd = String(cfgNightEnd.value || "all"); // all | timer
    const mafiaCount = Math.max(1, Number(cfgMafia.value || 1));
    const rolesCfg = readRolesFromUI();

    const code = code6();
    const pid = rid();

    await SESS(code).set({
      code,
      createdAt: now(),
      startedAt: 0,
      status: "lobby",
      phase: "lobby",
      round: 0,
      phaseEndAt: 0,
      creatorPid: pid,
      config: {
        phaseSeconds: seconds,
        tieMode,
        dayEnd,
        nightEnd,
        mafiaCount,
        roles: rolesCfg,
        sniperUsedBy: {},
        witchUsedBy: {}
      },
      winner: "",
      log: "ุชู ุฅูุดุงุก ุงูุฌูุณุฉ. ุจุงูุชุธุงุฑ ุงููุงุนุจููโฆ",
      votes: {
        night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} },
        day: { public:{} },
        dayExtra: { sniper:{} }
      },
      private: { detectiveResults:{} },
      history: {},
      engine: { lock: { holder:"", expiresAt: 0 }, lastResolveAt: 0 }
    });

    await SESS(code).child(`players/${pid}`).set({ id: pid, name, alive:true, role:"", joinedAt: now(), left:false });

    // onDisconnect
    SESS(code).child(`players/${pid}`).onDisconnect().update({ left:true, alive:false, leftAt: now() });

    me = { code, pid, name, isCreator:true };
    setMe(me);

    setScreen("player");
    pName.textContent = name;
    pCode.textContent = code;
    subscribe(code, pid);
  }

  async function joinSession(){
    const code = String(playerCode.value || "").trim();
    const name = String(playerName.value || "").trim();
    if (!/^\d{6}$/.test(code)) return alert("ุงูุชุจ ููุฏ ุตุญูุญ (6 ุฃุฑูุงู).");
    if (!name) return alert("ุงูุชุจ ุงุณูู.");

    const snap = await SESS(code).get();
    const s = snap.val();
    if (!s) return alert("ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ.");

    const wanted = normName(name);
    const existing = Object.values(s.players || {}).some(p => normName(p.name) === wanted && !p.left);
    if (existing) return alert("ูุฐุง ุงูุงุณู ูุณุชุฎุฏู ุฏุงุฎู ุงูุฌูุณุฉ. ุงุฎุชุฑ ุงุณููุง ุขุฎุฑ.");

    const pid = rid();
    await SESS(code).child(`players/${pid}`).set({ id: pid, name, alive:true, role:"", joinedAt: now(), left:false });

    // onDisconnect
    SESS(code).child(`players/${pid}`).onDisconnect().update({ left:true, alive:false, leftAt: now() });

    me = { code, pid, name, isCreator:false };
    setMe(me);

    setScreen("player");
    pName.textContent = name;
    pCode.textContent = code;
    subscribe(code, pid);
  }

  async function leaveSession(){
    if (!me?.code || !me?.pid) { clearMe(); location.href = location.pathname; return; }
    try { await SESS(me.code).child(`players/${me.pid}`).update({ left:true, alive:false, leftAt: now() }); } catch {}
    clearMe();
    location.href = location.pathname;
  }

  function computeWinner(players){
    const alive = players.filter(p => p.alive && !p.left);
    if (alive.length === 0) return "";
    const mafiaAlive = alive.filter(p => p.role === "mafia").length;
    const serialAlive = alive.filter(p => p.role === "serial").length;
    if (alive.length === 1 && alive[0].role === "serial") return "serial";
    if (mafiaAlive === 0 && serialAlive === 0) return "citizens";
    if (mafiaAlive > 0 && mafiaAlive >= (alive.length - mafiaAlive)) return "mafia";
    return "";
  }

  
  function buildAliveOptions(playersObj, excludeId, allowSelf){
    const alive = Object.values(playersObj || {}).filter(p => p.alive && !p.left && (allowSelf || p.id !== excludeId));
    return alive.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
  }

  // UI: selectable cards with search (ุฃูุถู ููุฌูุงู)
  function renderPickCards(containerEl, playersObj, excludeId, allowSelf, selectedId, onSelect){
    const all = Object.values(playersObj || {}).filter(p => p.alive && !p.left && (allowSelf || p.id !== excludeId));
    containerEl.innerHTML = `
      <input id="pickSearch" placeholder="ุจุญุซ ุจุงูุงุณูโฆ"
        class="tap w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" />
      <div id="pickList" class="mt-3 space-y-2 max-h-64 overflow-auto pr-1"></div>
    `;
    const searchEl = containerEl.querySelector("#pickSearch");
    const listEl = containerEl.querySelector("#pickList");

    const renderList = () => {
      const q = (searchEl.value || "").trim().toLowerCase();
      const filtered = q ? all.filter(p => normName(p.name).includes(q)) : all;
      listEl.innerHTML = filtered.length ? "" : `<div class="text-sm text-slate-400 text-center py-6">ูุง ููุฌุฏ ูุชุงุฆุฌ.</div>`;
      filtered.forEach(p => {
        const active = p.id === selectedId;
        const badge = active
          ? `<span class="text-xs px-2 py-1 rounded-xl border border-emerald-700 bg-emerald-900/20">ูุญุฏุฏ</span>`
          : `<span class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">ุงุฎุชุฑ</span>`;
        const row = document.createElement("button");
        row.type = "button";
        row.className = `tap w-full flex items-center justify-between rounded-2xl border px-3 py-3 text-right ${
          active ? "border-emerald-700 bg-emerald-900/10" : "border-slate-800 bg-slate-950 hover:bg-slate-900/30"
        }`;
        row.innerHTML = `<div class="font-bold">${escapeHtml(p.name)}</div>${badge}`;
        row.addEventListener("click", () => {
          selectedId = p.id;
          onSelect(p.id);
          renderList();
        });
        listEl.appendChild(row);
      });
    };

    searchEl.addEventListener("input", renderList);
    renderList();
  }


  // -------- Engine (auto) --------
  async function tryAcquireLock(code, pid){
    const lockRef = SESS(code).child("engine/lock");
    const leaseMs = 12000;

    const res = await lockRef.transaction((cur) => {
      const c = cur || { holder:"", expiresAt:0 };
      if (!c.holder || (c.expiresAt || 0) < now() || c.holder === pid) {
        return { holder: pid, expiresAt: now() + leaseMs };
      }
      return;
    });
    if (res.committed) lockExpiresAtLocal = res.snapshot.val()?.expiresAt || (now()+leaseMs);
    return !!res.committed;
  }

  async function maybeRenewLock(code, pid){
    if (!lockExpiresAtLocal || lockExpiresAtLocal - now() > 3500) return;
    const lockRef = SESS(code).child("engine/lock");
    const leaseMs = 12000;
    const res = await lockRef.transaction((cur) => {
      const c = cur || { holder:"", expiresAt:0 };
      if (c.holder === pid) return { holder: pid, expiresAt: now() + leaseMs };
      return;
    });
    if (res.committed) lockExpiresAtLocal = res.snapshot.val()?.expiresAt || (now()+leaseMs);
  }

  const aliveRoleCount = (players, role) => players.filter(p => p.alive && !p.left && p.role === role).length;

  async function pushHistory(code, entry){
    try {
      await SESS(code).child("history").push({ t: now(), ...entry });
      // trim (keep last 30) best-effort
      const snap = await SESS(code).child("history").limitToLast(40).get();
      const vals = snap.val() || {};
      const keys = Object.keys(vals);
      if (keys.length > 30) {
        const sorted = keys.sort((a,b) => (vals[a]?.t||0) - (vals[b]?.t||0));
        const toDel = sorted.slice(0, keys.length - 30);
        const upd = {};
        toDel.forEach(k => upd[k] = null);
        await SESS(code).child("history").update(upd);
      }
    } catch {}
  }

  function majorityReached(dayVotes, playersObj){
    const alive = Object.values(playersObj || {}).filter(p => p.alive && !p.left);
    const threshold = Math.floor(alive.length / 2) + 1;

    const weightFn = (voterPid, playersObj2) => {
      const p = playersObj2[voterPid];
      return (p?.role === "mayor" && p.alive && !p.left) ? 2 : 1;
    };
    const top = getTopCandidatesWeighted(dayVotes || {}, playersObj, weightFn);
    return top.max >= threshold;
  }

  async function engineStep(code, pid){
    const acquired = await tryAcquireLock(code, pid);
    if (!acquired) return;

    try {
      const snap = await SESS(code).get();
      const s = snap.val();
      if (!s || s.winner) return;
      if (s.status !== "playing") return;

      const phase = s.phase;
      const phaseEndAt = Number(s.phaseEndAt || 0);
      const playersObj = s.players || {};
      const players = Object.values(playersObj);
      const alive = players.filter(p => p.alive && !p.left);

      const cfg = s.config || {};
      const nightEnd = String(cfg.nightEnd || "all");
      const dayEnd = String(cfg.dayEnd || "all");

      let ready = false;

      if (phase === "night") {
        if (now() >= phaseEndAt) ready = true;
        else if (nightEnd === "timer") ready = false;
        else {
          // require role actions
          let allDone = true;

          // mafia (each mafia must vote)
          const aliveMafia = alive.filter(p => p.role === "mafia").map(p => p.id);
          const mv = s.votes?.night?.mafia || {};
          if (aliveMafia.some(id => !mv[id])) allDone = false;

          // doctor (must choose or skip)
          const docAlive = alive.filter(p => p.role === "doctor").map(p => p.id);
          const dv = s.votes?.night?.doctor || {};
          if (docAlive.some(id => !dv[id])) allDone = false;

          // detective
          const detAlive = alive.filter(p => p.role === "detective").map(p => p.id);
          const detv = s.votes?.night?.detective || {};
          if (detAlive.some(id => !detv[id])) allDone = false;

          // bodyguard
          const bgAlive = alive.filter(p => p.role === "bodyguard").map(p => p.id);
          const bgv = s.votes?.night?.bodyguard || {};
          if (bgAlive.some(id => !bgv[id])) allDone = false;

          // serial
          const skAlive = alive.filter(p => p.role === "serial").map(p => p.id);
          const skv = s.votes?.night?.serial || {};
          if (skAlive.some(id => !skv[id])) allDone = false;

          // witch: allow skip, but we still require an explicit decision (save/poison/skip)
          const wiAlive = alive.filter(p => p.role === "witch").map(p => p.id);
          const wsv = s.votes?.night?.witchSave || {};
          const wpv = s.votes?.night?.witchPoison || {};
          if (wiAlive.some(id => !(wsv[id] || wpv[id]))) allDone = false;

          ready = allDone;
        }
      }

      if (phase === "day") {
        if (now() >= phaseEndAt) ready = true;
        else if (dayEnd === "timer") ready = false;
        else if (dayEnd === "all") {
          const aliveIds = alive.map(p => p.id);
          const dv = s.votes?.day?.public || {};
          ready = aliveIds.every(id => !!dv[id]);
        } else if (dayEnd === "majority") {
          ready = majorityReached(s.votes?.day?.public || {}, playersObj);
        }
      }

      if (!ready) return;

      // Resolve idempotency
      const lastResolveAt = Number(s.engine?.lastResolveAt || 0);
      if (now() - lastResolveAt < 1500) return;
      await SESS(code).child("engine/lastResolveAt").set(now());

      const tieMode = String(cfg.tieMode || "revote");
      const seconds = clampInt(cfg.phaseSeconds, 15, 3600);
      const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

      async function tieRevote(path, msg){
        if (tieMode === "revote") {
          const upd = {};
          upd[path] = {};
          upd["log"] = msg + " ุชูุช ุฅุนุงุฏุฉ ุงูุชุตููุช.";
          upd["phaseEndAt"] = now() + seconds*1000;
          await SESS(code).update(upd);
          await pushHistory(code, { round: s.round || 0, phase, text: msg + " ุฅุนุงุฏุฉ ุชุตููุช." });
          return { stop:true };
        }
        return { stop:false };
      }

      const aliveObj = Object.fromEntries(alive.map(p => [p.id, p]));

      if (phase === "night") {
        const events = [];

        // Mafia target
        const mafiaVotes = s.votes?.night?.mafia || {};
        let mafiaVictimId = "";
        const mafiaTop = getTopCandidatesWeighted(mafiaVotes, playersObj, () => 1);
        if (mafiaTop.candidates.length === 1) mafiaVictimId = mafiaTop.candidates[0];
        else if (mafiaTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/mafia", `ุชุนุงุฏู ูู ุชุตููุช ุงููุงููุง (${mafiaTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          mafiaVictimId = pick(mafiaTop.candidates);
        }

        // Doctor save
        const docVotes = s.votes?.night?.doctor || {};
        let doctorSaveId = "";
        const docTop = getTopCandidatesWeighted(docVotes, playersObj, () => 1);
        if (docTop.candidates.length === 1) doctorSaveId = docTop.candidates[0] || "";
        else if (docTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/doctor", `ุชุนุงุฏู ูู ุชุตููุช ุงูุทุจูุจ (${docTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          doctorSaveId = pick(docTop.candidates);
        }

        // Witch save/poison (once each)
        const wsv = s.votes?.night?.witchSave || {};
        const wpv = s.votes?.night?.witchPoison || {};
        let witchSaveId = "";
        let witchPoisonId = "";

        // For witch, each witch submits one choice; we use first valid (since count can be >1 witches)
        for (const [wid, target] of Object.entries(wsv)) {
          if (!target || target === "skip") continue;
          const used = s.config?.witchUsedBy?.[wid] || {};
          if (used.saveUsed) continue;
          witchSaveId = target;
          await SESS(code).child(`config/witchUsedBy/${wid}/saveUsed`).set(true);
        }
        for (const [wid, target] of Object.entries(wpv)) {
          if (!target || target === "skip") continue;
          const used = s.config?.witchUsedBy?.[wid] || {};
          if (used.poisonUsed) continue;
          witchPoisonId = target;
          await SESS(code).child(`config/witchUsedBy/${wid}/poisonUsed`).set(true);
        }

        const savedId = doctorSaveId || witchSaveId || "";

        // Bodyguard protect
        const bgVotes = s.votes?.night?.bodyguard || {};
        let protectedId = "";
        const bgTop = getTopCandidatesWeighted(bgVotes, playersObj, () => 1);
        if (bgTop.candidates.length === 1) protectedId = bgTop.candidates[0] || "";
        else if (bgTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/bodyguard", `ุชุนุงุฏู ูู ุชุตููุช ุงูุญุงุฑุณ (${bgTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          protectedId = pick(bgTop.candidates);
        }

        // Serial kill
        const skVotes = s.votes?.night?.serial || {};
        let skVictimId = "";
        const skTop = getTopCandidatesWeighted(skVotes, playersObj, () => 1);
        if (skTop.candidates.length === 1) skVictimId = skTop.candidates[0] || "";
        else if (skTop.candidates.length > 1) {
          const r = await tieRevote("votes/night/serial", `ุชุนุงุฏู ูู ุชุตููุช ุงููุงุชู ุงููุชุณูุณู (${skTop.candidates.length} ุฎูุงุฑุงุช).`);
          if (r.stop) return;
          skVictimId = pick(skTop.candidates);
        }

        // Detective results (private)
        const detVotes = s.votes?.night?.detective || {};
        for (const [detPid, targetId] of Object.entries(detVotes || {})) {
          if (!targetId || targetId === "skip") continue;
          const t = playersObj[targetId];
          const res = t ? (t.role === "mafia" ? "๐ฅ ุงููุชูุฌุฉ: ูุงููุง" : "๐ฉ ุงููุชูุฌุฉ: ููุณ ูุงููุง") : "ุงููุฏู ุบูุฑ ููุฌูุฏ";
          await SESS(code).child(`private/detectiveResults/${detPid}`).set(res);
        }

        // Apply attacks (public messages without names)
        const applyAttack = async (victimId, label) => {
          if (!victimId || victimId === "skip" || !aliveObj[victimId]) return;
          if (victimId === savedId) { events.push("๐ฉบ ุชู ุฅููุงุฐ ูุงุนุจ"); return; }
          if (victimId === protectedId) {
            const bgAliveOne = alive.find(p => p.role === "bodyguard" && p.alive && !p.left);
            if (bgAliveOne) {
              await SESS(code).child(`players/${bgAliveOne.id}/alive`).set(false);
              events.push("๐ก๏ธ ุงูุญุงุฑุณ ุถุญูู ุจููุณู");
              return;
            }
          }
          await SESS(code).child(`players/${victimId}/alive`).set(false);
          events.push(label);
        };

        await applyAttack(mafiaVictimId, "๐ ุชู ูุชู ูุงุนุจ (ูุฌูู ุงููุงููุง)");
        await applyAttack(skVictimId, "๐ช ุชู ูุชู ูุงุนุจ (ูุฌูู ุงููุงุชู ุงููุชุณูุณู)");
        await applyAttack(witchPoisonId, "๐งช ุชู ุชุณููู ูุงุนุจ (ุงูุณุงุญุฑุฉ)");

        const msg = events.length ? events.join(" | ") : "๐ ูู ูุญุฏุซ ุดูุก ูุฐู ุงููููุฉ.";
        await SESS(code).child("log").set(msg);
        await pushHistory(code, { round: s.round || 1, phase: "night", text: msg });

        // next => day
        await SESS(code).update({
          phase: "day",
          phaseEndAt: now() + seconds*1000,
          votes: { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} }, day: { public:{} }, dayExtra: { sniper:{} } }
        });

      } else if (phase === "day") {
        const events = [];

        const dayVotes = s.votes?.day?.public || {};
        const weightFn = (voterPid, playersObj2) => {
          const p = playersObj2[voterPid];
          if (p?.role === "mayor" && p.alive && !p.left) return 2;
          return 1;
        };
        const top = getTopCandidatesWeighted(dayVotes, playersObj, weightFn);

        if (!top.candidates.length) {
          events.push("โ๏ธ ูู ูุตููุช ุฃุญุฏ.");
        } else {
          let outId = top.candidates[0];
          if (top.candidates.length > 1) {
            const r = await tieRevote("votes/day/public", `ุชุนุงุฏู ูู ุชุตููุช ุงูููุงุฑ (${top.candidates.length} ุฎูุงุฑุงุช).`);
            if (r.stop) return;
            outId = pick(top.candidates);
          }
          const out = aliveObj[outId];
          if (out) {
            await SESS(code).child(`players/${outId}/alive`).set(false);
            if (out.role === "jester") {
              await SESS(code).update({ winner:"jester", log:"๐คก๐ ูุงุฒ ุงูููุฑูุฌ ูุญุฏู! (ุชู ุฅูุตุงุคู ุจุงูุชุตููุช)" });
              await pushHistory(code, { round: s.round || 1, phase: "day", text: "๐คก๐ ูุงุฒ ุงูููุฑูุฌ ูุญุฏู!" });
              return;
            }
            events.push("โ๏ธ ุชู ุฅูุตุงุก ูุงุนุจ ุจุงูุชุตููุช");
          }
        }

        // Sniper (one shot)
        const sniperVotes = s.votes?.dayExtra?.sniper || {};
        for (const [snPid, targetId] of Object.entries(sniperVotes || {})) {
          const usedBy = s.config?.sniperUsedBy || {};
          if (usedBy[snPid]) continue;
          if (playersObj[snPid]?.role !== "sniper") continue;
          if (playersObj[targetId]?.alive && !playersObj[targetId]?.left) {
            await SESS(code).child(`players/${targetId}/alive`).set(false);
            await SESS(code).child(`config/sniperUsedBy/${snPid}`).set(true);
            events.push("๐ฏ ุงูููุงุต ูููุฐ ูุชููุง");
          }
        }

        const msg = events.join(" | ") || "โ๏ธ ุงูุชูู ุงูููุงุฑ.";
        await SESS(code).child("log").set(msg);
        await pushHistory(code, { round: s.round || 1, phase: "day", text: msg });

        // next => night
        await SESS(code).update({
          phase: "night",
          round: Number(s.round || 0) + 1,
          phaseEndAt: now() + seconds*1000,
          votes: { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} }, day: { public:{} }, dayExtra: { sniper:{} } }
        });
      }

      // Winner check
      const after = (await SESS(code).get()).val();
      const w = computeWinner(Object.values(after.players || {}));
      if (w) {
        const winMsg = w === "serial" ? "๐ ูุงุฒ ุงููุงุชู ุงููุชุณูุณู!" : (w === "mafia" ? "๐ ูุงุฒุช ุงููุงููุง!" : "๐ ูุงุฒ ุงูููุงุทููู!");
        await SESS(code).update({ winner: w, log: winMsg });
        await pushHistory(code, { round: after.round || 1, phase: after.phase || "", text: winMsg });
      }

    } finally {
      await maybeRenewLock(code, pid).catch(()=>{});
    }
  }

  function startEngine(code, pid){
    if (engineTimer) clearInterval(engineTimer);
    engineTimer = setInterval(() => engineStep(code, pid).catch(()=>{}), 2000);
  }

  // -------- Start Game --------
  async function startGameIfCreator(){
    if (!me?.code || !me?.pid) return;

    const snap = await SESS(me.code).get();
    const s = snap.val();
    if (!s) return alert("ุงูุฌูุณุฉ ุบูุฑ ููุฌูุฏุฉ.");
    if (s.creatorPid !== me.pid) return alert("ููุท ูููุดุฆ ุงูุฌูุณุฉ ูุณุชุทูุน ุจุฏุก ุงููุนุจุฉ.");
    if (s.status !== "lobby") return alert("ุงููุนุจุฉ ุจุฏุฃุช ุจุงููุนู.");

    const players = Object.values(s.players || {}).filter(p => !p.left);
    if (players.length < 5) return alert("ูุงุฒู 5 ูุงุนุจูู ุนูู ุงูุฃูู.");

    const seconds = clampInt(s.config?.phaseSeconds, 15, 3600);
    const mafiaCount = Math.max(1, Number(s.config?.mafiaCount || 1));
    const rolesCfg = s.config?.roles || {};

    const roles = [];
    for (let i=0;i<mafiaCount;i++) roles.push("mafia");

    const addRole = (key) => {
      const r = rolesCfg[key];
      if (!r?.on) return;
      const cnt = Math.max(0, Number(r.count || 0));
      for (let i=0;i<cnt;i++) roles.push(key);
    };
    ["sniper","jester","doctor","detective","bodyguard","serial","witch","mayor"].forEach(addRole);

    if (roles.length > players.length) return alert(`ุงูุฃุฏูุงุฑ ุฃูุซุฑ ูู ุงููุงุนุจูู. ุงูุฃุฏูุงุฑ=${roles.length} ุงููุงุนุจูู=${players.length}`);
    while (roles.length < players.length) roles.push("citizen");

    const rolesShuffled = shuffle(roles);
    const playersShuffled = shuffle(players);

    const startedAt = now();

    const updates = {};
    playersShuffled.forEach((p, idx) => {
      updates[`players/${p.id}/role`] = rolesShuffled[idx];
      updates[`players/${p.id}/alive`] = true;
      updates[`players/${p.id}/left`] = false;
    });

    updates["status"] = "playing";
    updates["phase"] = "night";
    updates["round"] = 1;
    updates["winner"] = "";
    updates["startedAt"] = startedAt;
    updates["phaseEndAt"] = startedAt + seconds*1000;
    updates["config/sniperUsedBy"] = {};
    updates["config/witchUsedBy"] = {};
    updates["votes"] = { night: { mafia:{}, doctor:{}, detective:{}, bodyguard:{}, serial:{}, witchSave:{}, witchPoison:{} }, day: { public:{} }, dayExtra: { sniper:{} } };
    updates["private/detectiveResults"] = {};
    updates["log"] = "ุจุฏุฃุช ุงููุนุจุฉ ุชููุงุฆููุง: ููู ๐";
    updates["history"] = {};

    await SESS(me.code).update(updates);
    await pushHistory(me.code, { round: 1, phase: "night", text: "ุจุฏุฃุช ุงููุนุจุฉ: ููู ๐" });
    alert("ุชู ุงูุจุฏุก โ");
  }

  // -------- Subscribe & Render --------
  function buildRenderKey(s, pid){
    const meObj = s.players?.[pid] || {};
    const subset = {
      status: s.status, phase: s.phase, round: s.round, phaseEndAt: s.phaseEndAt,
      winner: s.winner, log: s.log, startedAt: s.startedAt,
      players: Object.fromEntries(Object.entries(s.players || {}).map(([k,v]) => [k, {id:v.id,name:v.name,alive:v.alive,left:v.left,role:v.role}])),
      votes: s.votes,
      detRes: s.private?.detectiveResults?.[pid] || "",
      sniperUsed: s.config?.sniperUsedBy?.[pid] || false,
      witchUsed: s.config?.witchUsedBy?.[pid] || {},
      history: s.history || {}
    };
    return JSON.stringify(subset);
  }

  function renderHistory(historyObj){
    const arr = Object.values(historyObj || {}).sort((a,b)=> (b.t||0)-(a.t||0)).slice(0, 10);
    historyList.innerHTML = arr.length ? "" : `<div class="text-slate-400 text-sm">ูุง ููุฌุฏ ุณุฌู ุจุนุฏ.</div>`;
    arr.forEach(e => {
      const ph = e.phase === "night" ? "ููู" : (e.phase === "day" ? "ููุงุฑ" : e.phase || "");
      historyList.innerHTML += `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-3">
          <div class="text-xs text-slate-400">ุฌููุฉ ${escapeHtml(String(e.round||"โ"))} ยท ${escapeHtml(ph)}</div>
          <div class="mt-1 text-sm text-slate-200 leading-6">${escapeHtml(e.text || "")}</div>
        </div>
      `;
    });
  }

  
  function renderInGamePlayers(playersObj, myPid){
    const players = Object.values(playersObj || {}).filter(p => !p.left);
    const alive = players.filter(p => p.alive);
    inGameCount.textContent = `${alive.length} ุฃุญูุงุก / ${players.length} ุฅุฌูุงูู`;

    const initials = (name) => {
      const t = String(name || "").trim().split(/\s+/).filter(Boolean);
      const a = (t[0] || "ุ")[0];
      const b = (t[1] || "")[0] || "";
      return (a + b).toUpperCase();
    };

    inGamePlayersList.innerHTML = players.length ? "" : `<div class="col-span-2 sm:col-span-3 text-slate-400 text-sm text-center py-6">ูุง ููุฌุฏ ูุงุนุจูู.</div>`;

    players
      .sort((a,b)=> (a.alive===b.alive? a.name.localeCompare(b.name): (a.alive? -1:1)))
      .forEach(p => {
        const isMe = p.id === myPid;
        const ring = isMe ? "ring-2 ring-sky-500/70" : "ring-1 ring-slate-800/80";
        const state = p.alive
          ? `<span class="text-[11px] px-2 py-1 rounded-xl border border-emerald-700/70 bg-emerald-900/10">ุญู</span>`
          : `<span class="text-[11px] px-2 py-1 rounded-xl border border-rose-700/70 bg-rose-900/10">ุฎุงุฑุฌ</span>`;

        const tile = document.createElement("div");
        tile.className = `rounded-3xl bg-slate-950/55 border border-slate-800/70 shadow-sm p-3 ${ring}`;
        tile.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="w-10 h-10 rounded-2xl bg-slate-900/60 border border-slate-800/70 flex items-center justify-center font-extrabold">
              ${escapeHtml(initials(p.name))}
            </div>
            <div class="flex items-center gap-2">
              ${state}
            </div>
          </div>
          <div class="mt-3">
            <div class="font-extrabold text-sm truncate">${escapeHtml(p.name)}${isMe ? ` <span class="text-xs text-slate-400">(ุฃูุช)</span>` : ""}</div>
            <div class="text-[11px] text-slate-400 mt-1">ุฌุงูุฒ</div>
          </div>
        `;
        inGamePlayersList.appendChild(tile);
      });
  }

  function maybeShowRoleOnce(s, pid, roleKey){
    if (!s.startedAt || !roleKey || roleKey === "") return;
    const k = roleSeenKey(s.code, s.startedAt, pid);
    if (hasSeenRole(k)) return;
    rmRole.textContent = ROLE_UI[roleKey]?.name || roleKey;
    rmHint.textContent = ROLE_UI[roleKey]?.hint || "โ";
    roleModal.classList.remove("hidden");
  }

  function subscribe(code, pid){
    if (sub) sub.off();
    sub = SESS(code);

    setScreen("player");
    pName.textContent = me.name;
    pCode.textContent = code;

    startEngine(code, pid);

    sub.on("value", (snap) => {
      const s = snap.val();
      if (!s) return;

      me.isCreator = (me.pid === s.creatorPid);
      setMe(me);
      badgeMini.textContent = me.isCreator ? "ูููุดุฆ" : "ูุงุนุจ";

      const key = buildRenderKey(s, pid);
      if (key === lastRenderKey) return;
      lastRenderKey = key;

      publicLog.textContent = s.log || "โ";

      if (s.status === "lobby") {
        pPhase.textContent = "ููุจูู";
        pRound.textContent = "โ";
        phaseLeft.textContent = "โ";
        lobbyHint.innerHTML = `ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ ุดุงุฑู ุงูุฑุงุจุท ูุฏุฎููุง ููููู.`;
        lobbyBox.classList.remove("hidden");
        inGamePlayersBox.classList.add("hidden");
        historyBox.classList.add("hidden");

        const players = Object.values(s.players || {}).filter(p => !p.left);
        playerCount.textContent = `${players.length} ูุงุนุจูู`;
        playersList.innerHTML = players.length ? "" : `<div class="text-slate-400 text-sm">ูุง ููุฌุฏ ูุงุนุจูู ุจุนุฏ.</div>`;
        players.forEach(p => {
          playersList.innerHTML += `
            <div class="flex items-center justify-between rounded-2xl bg-slate-950 border border-slate-800 px-3 py-2">
              <div class="font-bold">${escapeHtml(p.name)}</div>
              <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60 text-slate-200">ุฌุงูุฒ</div>
            </div>`;
        });

        btnStartGame.classList.toggle("hidden", !(me.isCreator && players.length >= 5));
        myVoteStatus.textContent = "ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ";
        pActionBox.innerHTML = `<div class="text-center text-slate-300">ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ</div>`;
        myRoleText.textContent = "โ";
        myRoleHint.textContent = "โ";
        roleExtraBox.classList.add("hidden");
        return;
      }

      // playing
      lobbyBox.classList.add("hidden");
      inGamePlayersBox.classList.remove("hidden");
      historyBox.classList.remove("hidden");

      const phase = s.phase;

      // ููุฎุต ุชููุงุฆู ุนูุฏ ุงูุงูุชูุงู ุจูู ุงููุฑุงุญู
      if (s.status === "playing" && !s.winner) {
        const curRound = Number(s.round || 0);
        if (lastPhaseLocal && phase !== lastPhaseLocal) {
          const title = (phase === "day") ? `โ๏ธ ุจุฏุงูุฉ ุงูููุงุฑ โ ุฌููุฉ ${curRound}` : `๐ ุจุฏุงูุฉ ุงูููู โ ุฌููุฉ ${curRound}`;
          // ูุนุฑุถ ุขุฎุฑ ุณุฌู ุนุงู (log) ูููุฎุต
          showPhaseModal(title, s.log || "โ");
        }
        lastPhaseLocal = phase;
        lastRoundLocal = curRound;
      }

      pPhase.textContent = phase === "night" ? "ููู ๐" : "ููุงุฑ โ๏ธ";
      pRound.textContent = String(s.round || 1);

      const endAt = Number(s.phaseEndAt || 0);
      phaseLeft.textContent = endAt ? fmtLeft(endAt - now()) : "โ";
      lobbyHint.innerHTML = `ุงููุนุจุฉ ุชูุฏุงุฑ ุชููุงุฆููุง. ุงุฎุชุฑ ุงูุฅุฌุฑุงุก ุญุณุจ ุฏูุฑู.`;

      if (s.winner) {
        winnerBanner.classList.remove("hidden");
        winnerText.textContent =
          s.winner === "jester" ? "๐คก๐ ูุงุฒ ุงูููุฑูุฌ ูุญุฏู!" :
          s.winner === "serial" ? "๐ช๐ ูุงุฒ ุงููุงุชู ุงููุชุณูุณู!" :
          s.winner === "mafia" ? "๐ฅ๐ ูุงุฒุช ุงููุงููุง!" : "๐ฉ๐ ูุงุฒ ุงูููุงุทููู!";
      } else winnerBanner.classList.add("hidden");

      renderInGamePlayers(s.players || {}, pid);
      renderHistory(s.history || {});

      const meObj = s.players?.[pid];
      if (!meObj) return;

      const roleKey = meObj.role || "";

      // role UI
      if (!roleKey) {
        myRoleText.textContent = "ุจุงูุชุธุงุฑ ุชูุฒูุน ุงูุฃุฏูุงุฑโฆ";
        myRoleHint.textContent = "ุณูุชู ุงูุชูุฒูุน ุนูุฏ ุจุฏุก ุงููุนุจุฉ.";
      } else {
        myRoleText.textContent = ROLE_UI[roleKey]?.name || roleKey;
        myRoleHint.textContent = ROLE_UI[roleKey]?.hint || "โ";
      }

      // show role once
      maybeShowRoleOnce(s, pid, roleKey);

      const detRes = s.private?.detectiveResults?.[pid];
      if (detRes) { roleExtraBox.classList.remove("hidden"); roleExtraText.textContent = detRes; }
      else roleExtraBox.classList.add("hidden");

      // live tally
      if (phase === "night") {
        liveTally.textContent = tallyTextWeighted(s.votes?.night?.mafia || {}, s.players || {}, () => 1);
      } else {
        const weightFn = (voterPid, playersObj2) => {
          const p = playersObj2[voterPid];
          return (p?.role === "mayor" && p.alive && !p.left) ? 2 : 1;
        };
        liveTally.textContent = tallyTextWeighted(s.votes?.day?.public || {}, s.players || {}, weightFn);
      }

      renderPlayerAction(s, pid, meObj, roleKey);
    });
  }

  function renderPlayerAction(s, pid, meObj, roleKey){
    const actionKey = JSON.stringify({
      status: s.status, phase: s.phase, winner: s.winner,
      roleKey, alive: meObj.alive, left: meObj.left,
      votes: s.votes,
      used: s.config?.sniperUsedBy?.[pid] || false,
      witchUsed: s.config?.witchUsedBy?.[pid] || {}
    });
    if (actionKey === lastActionKey) return;
    lastActionKey = actionKey;

    const phase = s.phase;
    const playersObj = s.players || {};

    if (meObj.left) {
      myVoteStatus.textContent = "ุฎุฑุฌุช ูู ุงูุฌูุณุฉ.";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุฎุฑุฌุช ูู ุงูุฌูุณุฉ.</div>`;
      return;
    }
    if (!meObj.alive) {
      myVoteStatus.textContent = "โ ุฎุงุฑุฌ ุงููุนุจุฉ";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุฃูุช ุฎุงุฑุฌ ุงููุนุจุฉ โ</div>`;
      return;
    }
    if (!roleKey) {
      myVoteStatus.textContent = "ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุจุงูุชุธุงุฑ ุจุฏุก ุงููุนุจุฉโฆ</div>`;
      return;
    }
    if (s.winner) {
      myVoteStatus.textContent = "ุงูุชูุช ุงููุนุจุฉ ๐";
      pActionBox.innerHTML = `<div class="text-center text-slate-300">ุงูุชูุช ุงููุนุจุฉ ๐</div>`;
      return;
    }

    const aliveNoSelf = buildAliveOptions(playersObj, pid, false);
    const aliveAllowSelf = buildAliveOptions(playersObj, pid, true);

    // NIGHT
    if (phase === "night") {
      const parts = [];
      if (roleKey === "mafia") parts.push(s.votes?.night?.mafia?.[pid] ? "โ ุตููุช (ูุงููุง)" : "โณ ูู ุชุตููุช (ูุงููุง)");
      if (roleKey === "doctor") parts.push(s.votes?.night?.doctor?.[pid] ? "โ ุงุฎุชุฑุช ุฅููุงุฐ/ุชุฎุทู" : "โณ ูู ุชุฎุชุฑ");
      if (roleKey === "detective") parts.push(s.votes?.night?.detective?.[pid] ? "โ ุงุฎุชุฑุช ุชุญููู/ุชุฎุทู" : "โณ ูู ุชุฎุชุฑ");
      if (roleKey === "bodyguard") parts.push(s.votes?.night?.bodyguard?.[pid] ? "โ ุงุฎุชุฑุช ุญูุงูุฉ/ุชุฎุทู" : "โณ ูู ุชุฎุชุฑ");
      if (roleKey === "serial") parts.push(s.votes?.night?.serial?.[pid] ? "โ ุงุฎุชุฑุช ูุชู/ุชุฎุทู" : "โณ ูู ุชุฎุชุฑ");
      if (roleKey === "witch") parts.push((s.votes?.night?.witchSave?.[pid] || s.votes?.night?.witchPoison?.[pid]) ? "โ ูุฑุงุฑ/ุชุฎุทู" : "โณ ูู ุชุฎุชุงุฑู");
      myVoteStatus.textContent = parts.length ? parts.join(" | ") : "ููู: ูุง ููุฌุฏ ุฅุฌุฑุงุก ูู.";

      const mkSendBlock = (title, selId, btnId, path, already, color) => `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="font-extrabold text-lg">${title}</div>
          <select id="${selId}" class="w-full rounded-2xl bg-slate-950 border border-slate-800 px-4 py-3 outline-none focus:border-sky-500" ${already ? "disabled" : ""}>
            <option value="">ุงุฎุชุฑ</option>${aliveNoSelf}
          </select>
          <button id="${btnId}" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : color} font-extrabold" ${already ? "disabled" : ""}>
            ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
          </button>
          <button id="${btnId}Skip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">ุชุฎุทู</button>
        </div>
      `;

      if (roleKey === "mafia") {
        const already = s.votes?.night?.mafia?.[pid];
        pActionBox.innerHTML = mkSendBlock("ุชุตููุช ุงููุงููุง (ูุชู)", "selNightKill", "btnNightKill", `votes/night/mafia/${pid}`, !!already, "bg-rose-600 hover:bg-rose-500");
        // cards picker
        const pk = document.getElementById("pickNightKill");
        if (pk && !already) {
          renderPickCards(pk, playersObj, pid, false, "", (id) => { document.getElementById("selNightKill").value = id; });
        }

        if (!already) $("btnNightKill").addEventListener("click", async () => {
          const victimId = $("selNightKill").value || "";
          if (!victimId) return alert("ุงุฎุชุฑ ุงูุถุญูุฉ.");
          await SESS(me.code).child(`votes/night/mafia/${pid}`).set(victimId);
          alert("ุชู โ");
        });
        $("btnNightKillSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/mafia/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "doctor") {
        const already = s.votes?.night?.doctor?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">๐ฉบ ุงูุทุจูุจ (ุฅููุงุฐ)</div>
            <div id="pickDoc"></div><input type="hidden" id="selDoc" value="">
            <button id="btnDoc" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-emerald-600 hover:bg-emerald-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnDocSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">ุชุฎุทู</button>
          </div>`;

        const pk = document.getElementById("pickDoc");
        if (pk && !already) {
          renderPickCards(pk, playersObj, pid, true, "", (id) => { document.getElementById("selDoc").value = id; });
        }
        if (!already) $("btnDoc").addEventListener("click", async () => {
          const t = $("selDoc").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/doctor/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnDocSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/doctor/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "detective") {
        const already = s.votes?.night?.detective?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">๐ ุงููุญูู (ุชุญููู)</div>
            <div id="pickDet"></div><input type="hidden" id="selDet" value="">
            <button id="btnDet" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-sky-600 hover:bg-sky-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnDetSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">ุชุฎุทู</button>
            <div class="text-xs text-slate-400">ุงููุชูุฌุฉ ุชุธูุฑ ูู ููุท ุจุนุฏ ุงูุชูููุฐ.</div>
          </div>`;

        const pk = document.getElementById("pickDet");
        if (pk && !already) {
          renderPickCards(pk, playersObj, pid, false, "", (id) => { document.getElementById("selDet").value = id; });
        }
        if (!already) $("btnDet").addEventListener("click", async () => {
          const t = $("selDet").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุฏู.");
          await SESS(me.code).child(`votes/night/detective/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnDetSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/detective/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "bodyguard") {
        const already = s.votes?.night?.bodyguard?.[pid];
        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="font-extrabold text-lg">๐ก๏ธ ุงูุญุงุฑุณ (ุญูุงูุฉ)</div>
            <div id="pickBg"></div><input type="hidden" id="selBg" value="">
            <button id="btnBg" class="tap w-full px-4 py-4 rounded-3xl ${already ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-indigo-600 hover:bg-indigo-500"} font-extrabold" ${already ? "disabled" : ""}>
              ${already ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู"}
            </button>
            <button id="btnBgSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">ุชุฎุทู</button>
          </div>`;

        const pk = document.getElementById("pickBg");
        if (pk && !already) {
          renderPickCards(pk, playersObj, pid, true, "", (id) => { document.getElementById("selBg").value = id; });
        }
        if (!already) $("btnBg").addEventListener("click", async () => {
          const t = $("selBg").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/bodyguard/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnBgSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/bodyguard/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "serial") {
        const already = s.votes?.night?.serial?.[pid];
        pActionBox.innerHTML = mkSendBlock("๐ช ุงููุงุชู ุงููุชุณูุณู (ูุชู)", "selSk", "btnSk", `votes/night/serial/${pid}`, !!already, "bg-rose-600 hover:bg-rose-500");

        const pk = document.getElementById("pickSk");
        if (pk && !already) {
          renderPickCards(pk, playersObj, pid, false, "", (id) => { document.getElementById("selSk").value = id; });
        }
        if (!already) $("btnSk").addEventListener("click", async () => {
          const t = $("selSk").value || "";
          if (!t) return alert("ุงุฎุชุฑ ุงูุถุญูุฉ.");
          await SESS(me.code).child(`votes/night/serial/${pid}`).set(t);
          alert("ุชู โ");
        });
        $("btnSkSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/serial/${pid}`).set("skip");
          alert("ุชู โ");
        });
        return;
      }

      if (roleKey === "witch") {
        const used = s.config?.witchUsedBy?.[pid] || {};
        const saveUsed = !!used.saveUsed;
        const poisonUsed = !!used.poisonUsed;
        const ws = s.votes?.night?.witchSave?.[pid];
        const wp = s.votes?.night?.witchPoison?.[pid];

        pActionBox.innerHTML = `
          <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
            <div class="flex items-center justify-between">
              <div class="font-extrabold text-lg">๐งช ุงูุณุงุญุฑุฉ</div>
              <div class="text-xs text-slate-400">ุฅููุงุฐ ูุฑุฉ + ุณู ูุฑุฉ</div>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3 space-y-2">
              <div class="flex items-center justify-between">
                <div class="font-bold">๐ฉบ ุฅููุงุฐ</div>
                <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">${saveUsed ? "ูุณุชุฎุฏู" : (ws ? "ูุฑุณูู" : "ูุชุงุญ")}</div>
              </div>
              <div id="pickWitchSave"></div><input type="hidden" id="selWitchSave" value="">
              <button id="btnWitchSave" class="tap w-full px-4 py-3 rounded-3xl ${saveUsed || ws ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-emerald-600 hover:bg-emerald-500"} font-extrabold" ${saveUsed || ws ? "disabled" : ""}>
                ุฅุฑุณุงู ุงูุฅููุงุฐ
              </button>
            </div>

            <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-3 space-y-2">
              <div class="flex items-center justify-between">
                <div class="font-bold">โ๏ธ ุณู</div>
                <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">${poisonUsed ? "ูุณุชุฎุฏู" : (wp ? "ูุฑุณูู" : "ูุชุงุญ")}</div>
              </div>
              <div id="pickWitchPoison"></div><input type="hidden" id="selWitchPoison" value="">
              <button id="btnWitchPoison" class="tap w-full px-4 py-3 rounded-3xl ${poisonUsed || wp ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${poisonUsed || wp ? "disabled" : ""}>
                ุฅุฑุณุงู ุงูุณู
              </button>
            </div>

            <button id="btnWitchSkip" class="tap w-full px-4 py-3 rounded-3xl bg-slate-900 hover:bg-slate-800 border border-slate-800 text-sm">
              ุชุฎุทู (ูุง ุดูุก)
            </button>
          </div>`;

        const pkS = document.getElementById("pickWitchSave");
        if (pkS && !(saveUsed || ws)) {
          renderPickCards(pkS, playersObj, pid, true, "", (id) => { document.getElementById("selWitchSave").value = id; });
        }
        const pkP = document.getElementById("pickWitchPoison");
        if (pkP && !(poisonUsed || wp)) {
          renderPickCards(pkP, playersObj, pid, false, "", (id) => { document.getElementById("selWitchPoison").value = id; });
        }

        $("btnWitchSkip").addEventListener("click", async () => {
          await SESS(me.code).child(`votes/night/witchSave/${pid}`).set("skip");
          await SESS(me.code).child(`votes/night/witchPoison/${pid}`).set("skip");
          alert("ุชู โ");
        });

        const bs = $("btnWitchSave");
        if (bs && !saveUsed && !ws) bs.addEventListener("click", async () => {
          const t = $("selWitchSave").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/witchSave/${pid}`).set(t);
          alert("ุชู โ");
        });

        const bp = $("btnWitchPoison");
        if (bp && !poisonUsed && !wp) bp.addEventListener("click", async () => {
          const t = $("selWitchPoison").value || "";
          if (!t) return alert("ุงุฎุชุฑ ูุงุนุจ.");
          await SESS(me.code).child(`votes/night/witchPoison/${pid}`).set(t);
          alert("ุชู โ");
        });

        return;
      }

      pActionBox.innerHTML = `<div class="text-center text-slate-300">ูููโฆ ุงูุชุธุฑ.</div>`;
      return;
    }

    // DAY
    const v = s.votes?.day?.public?.[pid];
    const used = !!s.config?.sniperUsedBy?.[pid];
    const sv = s.votes?.dayExtra?.sniper?.[pid];
    const extra = (roleKey === "sniper") ? (used ? " | ๐ฏ ุงูุทููุฉ ูุณุชูููุฉ." : (sv ? " | ๐ฏ ุชู ุชุญุฏูุฏ ุงููุฏู." : " | ๐ฏ ูู ุชุณุชุฎุฏู ุงูุทููุฉ.")) : "";
    myVoteStatus.textContent = (v ? "โ ุชู ุชุตููุช ุงูููุงุฑ." : "โณ ูู ุชุตููุช ุจุนุฏ.") + extra;

    const aliveOptionsNoSelf = buildAliveOptions(playersObj, pid, false);
    const dayAlready = !!v;
    const sniperDisabled = used || !!sv;

    pActionBox.innerHTML = `
      <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
        <div class="font-extrabold text-lg">ุชุตููุช ุงูููุงุฑ (ุฅูุตุงุก)</div>
        <div id="pickDayVote"></div><input type="hidden" id="selDayVote" value="">
        <button id="btnDayVote" class="tap w-full px-4 py-4 rounded-3xl ${dayAlready ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-amber-600 hover:bg-amber-500"} font-extrabold" ${dayAlready ? "disabled" : ""}>
          ${dayAlready ? "ุชู ุงูุฅุฑุณุงู" : "ุฅุฑุณุงู ุงูุชุตููุช"}
        </button>
      </div>

      ${roleKey === "sniper" ? `
        <div class="rounded-2xl border border-slate-800 bg-slate-950 p-4 space-y-3">
          <div class="flex items-center justify-between">
            <div class="font-extrabold text-lg">๐ฏ ุงูููุงุต</div>
            <div class="text-xs px-2 py-1 rounded-xl border border-slate-700 bg-slate-900/60">
              ${used ? "ูุณุชุฎุฏู" : (sv ? "ุชู ุงูุฅุฑุณุงู" : "ูุชุงุญ")}
            </div>
          </div>
          <div id="pickSniper"></div><input type="hidden" id="selSniper" value="">
          <button id="btnSniper" class="tap w-full px-4 py-4 rounded-3xl ${sniperDisabled ? "bg-slate-800 border border-slate-700 opacity-60" : "bg-rose-600 hover:bg-rose-500"} font-extrabold" ${sniperDisabled ? "disabled" : ""}>
            ${used ? "ุชู ุงุณุชุฎุฏุงู ุงูุทููุฉ" : (sv ? "ุชู ุชุญุฏูุฏ ุงููุฏู" : "ุชุญุฏูุฏ ุงููุฏู (ุณุฑู)")}
          </button>
        </div>
      ` : "" }
    `;

    const pk = document.getElementById("pickDayVote");
    if (pk && !dayAlready) {
      renderPickCards(pk, playersObj, pid, false, "", (id) => { document.getElementById("selDayVote").value = id; });
    }

    if (!dayAlready) $("btnDayVote").addEventListener("click", async () => {
      const targetId = $("selDayVote").value || "";
      if (!targetId) return alert("ุงุฎุชุฑ ุงูุดุฎุต.");
      await SESS(me.code).child(`votes/day/public/${pid}`).set(targetId);
      alert("ุชู โ");
    });

    if (roleKey === "sniper" && !sniperDisabled) $("btnSniper").addEventListener("click", async () => {

    const pkS = document.getElementById("pickSniper");
    if (pkS && !sniperDisabled) {
      renderPickCards(pkS, playersObj, pid, false, "", (id) => { document.getElementById("selSniper").value = id; });
    }

      const targetId = $("selSniper").value || "";
      if (!targetId) return alert("ุงุฎุชุฑ ุงููุฏู.");
      await SESS(me.code).child(`votes/dayExtra/sniper/${pid}`).set(targetId);
      alert("ุชู โ");
    });
  }

  // ---------- UI Events ----------
  btnMenu?.addEventListener("click", () => howModal.classList.remove("hidden"));

  btnGoCreate.addEventListener("click", () => setScreen("create"));
  btnGoJoin.addEventListener("click", () => setScreen("join"));
  btnBackFromCreate.addEventListener("click", () => setScreen("mode"));
  btnBackFromJoin.addEventListener("click", () => setScreen("mode"));

  btnCreateSession.addEventListener("click", createSessionAsPlayer);
  btnPlayerJoin.addEventListener("click", joinSession);

  btnToggleRole.addEventListener("click", () => myRoleCard.classList.toggle("hidden"));
  btnCopyShare.addEventListener("click", () => me?.code && shareLink(me.code));
  btnStartGame.addEventListener("click", startGameIfCreator);

  btnLeave.addEventListener("click", leaveSession);

  btnHow.addEventListener("click", () => howModal.classList.remove("hidden"));
  btnCloseHow.addEventListener("click", () => howModal.classList.add("hidden"));

  btnClosePhase.addEventListener("click", closePhaseModal);
  btnPhaseOk.addEventListener("click", closePhaseModal);
  phaseModal.addEventListener("click", (e) => { if (e.target === phaseModal) closePhaseModal(); });

  howModal.addEventListener("click", (e) => { if (e.target === howModal) howModal.classList.add("hidden"); });

  btnRoleOk.addEventListener("click", async () => {
    roleModal.classList.add("hidden");
    // mark seen
    try {
      const snap = await SESS(me.code).get();
      const s = snap.val();
      const k = roleSeenKey(s.code, s.startedAt, me.pid);
      markSeenRole(k);
    } catch {}
  });
  roleModal.addEventListener("click", (e) => { if (e.target === roleModal) roleModal.classList.add("hidden"); });

  // Countdown (local only)
  setInterval(() => {
    if (!me?.code) return;
    SESS(me.code).child("phaseEndAt").get().then(snap => {
      const endAt = Number(snap.val() || 0);
      if (!endAt) return;
      phaseLeft.textContent = fmtLeft(endAt - now());
    }).catch(()=>{});
  }, 900);

  // ---------- Resume ----------
  if (me?.code && me?.pid) {
    setScreen("player");
    pName.textContent = me.name;
    pCode.textContent = me.code;
    subscribe(me.code, me.pid);
  } else if (preCode) {
    setScreen("join");
  } else {
    setScreen("mode");
  }
})();
</script>
</body>
</html>



